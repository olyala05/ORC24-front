{% extends "layout.html" %} {% block title %} {{ _('ORC Status') }} {% endblock
  %} {% block content %}
  
  <div class="orc-status-container">
    <!-- Header -->
    {% include 'partials/header.html' %}
  
    <!-- ORC Status ƒ∞√ßeriƒüi -->
    <div class="orc-content">
      <div class="device-info">
        <ul>
          <li>
            <span class="highlight">{{ _('S/N') }}</span>
            <span>{{ modem.serial_no if modem.serial_no else '-' }}</span>
          </li>
          <li>
            <span class="highlight">{{ _('MODEM NAME') }}</span>
            <span>{{ modem.name if modem.name else '-' }}</span>
          </li>
          <li>
            <span class="highlight">{{ _('MODEM BRAND / MODEL') }}</span>
            <span id="brand-model">-</span>
          </li>
  
          <li>
            <span class="highlight"> {{ _('MODEM STATUS')}}</span>
  
            <span
              >{% if modem.status == "A" %} {{ _('Active')}} {% else %} {{
              _('Passive')}} {% endif %}</span
            >
          </li>
          <li>
            <span class="highlight">{{ _('DATE OF INSTALLATION')}} </span
            ><span>{{modem.created_at if modem.created_at else '-'}}</span>
          </li>
          <li>
            <span class="highlight">{{ _('NETWORK TYPE')}} </span>
            <span>
              {% if network and network.network_type_list %} {{
              network.network_type_list | join(" / ") }} {% else %} {{
              _('Disconnected')}} {% endif %}
            </span>
          </li>
          <!--           <li>
            <span class="highlight">{{ _('CONNECTION TYPE') }}</span>
            <span id="connection-protocol">-</span>
          </li> -->

          <li>
            <span class="highlight">{{ _('SOFTWARE VERSION')}}</span>
            <span>V 1.02</span>
          </li>
        </ul>
      </div>
  
      <div class="connection-table" id="connection-table">
        <table>
          <thead>
            <tr>
              <th>{{ _('Archive')}}</th>
              <th>{{ _('Now')}}</th>
              <th>{{ _('Modem Name')}}</th>
              <th>{{ _('Last Connection Date')}}</th>
            </tr>
          </thead>
  
          <tbody>
            <tr>
              <td><span class="status-dot red"></span></td>
              <td><span class="status-dot red"></span></td>
              <td>{{ _('Lora Disconnection')}}</td>
              <td id="lora-date">-</td>  
            </tr>
  
            <tr data-tag="wifi_connection">
              <td><span class="status-dot red"></span></td>
              <td><span class="status-dot red"></span></td>
              <td>{{ _('WiFi Connection')}}</td>
              <td>-</td>
            </tr>
  
            <tr data-tag="cloud_connection">
              <td><span class="status-dot red"></span></td>
              <td><span class="status-dot red"></span></td>
              <td>{{ _('Cloud Connection')}}</td>
              <td>-</td>
            </tr>
  
            <tr data-tag="rabbitmq">
              <td><span class="status-dot red"></span></td>
              <td><span class="status-dot red"></span></td>
              <td>{{ _('Rabbit MQ')}}</td>
              <td>-</td>
            </tr>
  
            <tr data-tag="vpn_connection">
              <td><span class="status-dot red"></span></td>
              <td><span class="status-dot red"></span></td>
              <td>{{ _('VPN Connection')}}</td>
              <td>-</td>
            </tr>
          </tbody>
        </table>
  
        <div class="algorithm-section">
          <h3 style="text-align: start; margin-left: 17px">
            {{ _('Algorithm Processes')}}
          </h3>
          <div class="separator"></div>
          <!-- Turuncu √ßizgi -->
          <div class="algorithm-box">
            <div class="algorithm-left">
              <i class="fa fa-refresh" aria-hidden="true"></i>
              <span>{{ _('ORC Process Procedures')}}</span>
            </div>
            <!-- !! burada eƒüer hata var ise kƒ±rmƒ±zƒ±z yap buttonu  !!-->
            <button class="status-btn" onclick="redirectToLog()">
              {{ _('Logs')}}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    function redirectToLog() {
      window.location.href = "{{ url_for('log')}}";
    }
  
    document.addEventListener("DOMContentLoaded", function () {
      fetch("/equipments-with-models", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Gelen JSON:", data);
  
          if (data.data && data.data.length > 0) {
            let protocolText = "";
            let equipment = data.data[0];
  
            if (equipment.communication_protocol_code === 1) {
              protocolText = "MODBUS TCP/IP";
            } else if (equipment.communication_protocol_code === 2) {
              protocolText = "MODBUS RTU";
            } else if (equipment.communication_protocol_code === 3) {
              protocolText = "OBIS";
            } else if (equipment.communication_protocol_code === 4) {
              protocolText = "RS232";
            } else {
              protocolText = "UNKNOWN";
            }
  
            document.getElementById("connection-protocol").innerText =
              protocolText;
          } else {
            document.getElementById("connection-protocol").innerText = "-";
          }
        })
        .catch((error) => {
          console.error("API isteƒüi hatasƒ±:", error);
          document.getElementById("connection-protocol").innerText =
            "Error fetching data";
        });
    });

    async function fetchBrandModel() {
      try {
        const response = await fetch("/get_modem_info");
        if (!response.ok) throw new Error("Server hatasƒ±: " + response.status);
    
        const result = await response.json();
        const modem = result.data;
    
        console.log("[LOG] Gelen modem bilgisi:", modem);
    
        const BRAND_MAP = {
          1: "ORC_23",
          2: "ORC_24",
          3: "ORC_44"
        };
    
        const MODEL_MAP = {
          1: "RASPBERRY_PI",
          2: "ORANGE_PI",
          3: "ReComputerR1000",
          4: "ReComputerR1100"
        };
    
        const brand = BRAND_MAP[modem.brand_id] || "Bilinmeyen Marka";
        const model = MODEL_MAP[modem.modem_model_id] || "Bilinmeyen Model";
    
        document.getElementById("brand-model").textContent = `${brand} / ${model}`;
      } catch (error) {
        console.error("Modem Brand/Model hatasƒ±:", error);
        document.getElementById("brand-model").textContent = "Veri alƒ±namadƒ±";
      }
    }
    
    // Sayfa y√ºklendiƒüinde otomatik olarak modem model bilgisini √ßek
    window.onload = fetchBrandModel;
  
    function showTableLoading(message) {
      const container = document.getElementById("connection-table");
  
      // Zaten eklenmi≈ü mi kontrol et
      if (document.getElementById("table-loading-overlay")) return;
  
      const loadingDiv = document.createElement("div");
      loadingDiv.id = "table-loading-overlay";
      loadingDiv.className = "table-loading-overlay";
      loadingDiv.innerHTML = `
            <div class="loading-box">
              <p>${message}</p>
              <div class="loader"></div>
            </div>
        `;
  
      container.style.position = "relative";
      container.appendChild(loadingDiv);
    }
  
    function hideTableLoading() {
      const loadingDiv = document.getElementById("table-loading-overlay");
      if (loadingDiv) loadingDiv.remove();
    }
 document.addEventListener("DOMContentLoaded", function () {
    // üìå Sadece tabloya √∂zel loading g√∂ster
    showTableLoading("Veriler getiriliyor...");
  
    fetch("/get_archive_log_status")
      .then((response) => response.json())
      .then((data) => {
        console.log("[LOG] Archive log status fetch ba≈üladƒ±.");
        console.log("[FETCH] /get_archive_log_status cevabƒ±:", data);
  
        if (data.status !== "success" || !data.data) {
          console.warn("[LOG] Ge√ßersiz yanƒ±t yapƒ±sƒ±");
          hideTableLoading();
          return;
        }
  
        const archiveData = data.data;
  
        const tagMapping = {
          wifi_connection: "ƒ∞nternet Var Mƒ±?",
          cloud_connection: "modem bilgisi buluta g√∂nderildi mi?",
          vpn_connection: "VPN IP Adresi",
          rabbitmq: "Rabbit MQya Basƒ±lan veri",
        };
  
        const typeToColorClass = {
          1: "green",
          2: "orange",
          3: "red",
        };
  
        const rows = Array.from(document.querySelectorAll("tbody tr"));
        console.log("[LOG] Tablodaki Satƒ±rlar:");
        rows.forEach((r, index) => {
          console.log(`Row ${index + 1}:`, r.innerText.trim());
        });
  
        Object.entries(tagMapping).forEach(([dataTag, archiveKeyLabel]) => {
          const row = rows.find((tr) => tr.dataset.tag === dataTag);
  
          if (!row) {
            console.warn(`[LOG] ${dataTag} i√ßin satƒ±r bulunamadƒ±.`);
            console.warn(`Satƒ±r bulunamadƒ±! tag=${dataTag}`);
            return;
          }
  
          const archiveKey = Object.keys(archiveData).find(
            (key) => key.toLowerCase() === archiveKeyLabel.toLowerCase()
          );
  
          if (!archiveKey) {
            console.warn(`[LOG] ${archiveKeyLabel} i√ßin veri bulunamadƒ±.`);
            return;
          }
  
          const archiveInfo = archiveData[archiveKey];
          console.log(`[LOG] Archive Info (${archiveKey}):`, archiveInfo);
          console.log(`[${dataTag}] Archive Info:`, archiveInfo);
  
          const rowSpans = row.querySelectorAll(".status-dot");
          const allCells = row.querySelectorAll("td");
  
          const archiveType = archiveInfo.archive_log_type;
          const nowType = archiveInfo.last_log_type;
          const archiveDate = archiveInfo.archive_log_date;
          const lastLogDate = archiveInfo.last_log_date;
  
          // 1Ô∏è‚É£ Archive S√ºtunu Tooltip + Renk
          if (typeToColorClass[archiveType]) {
            rowSpans[0].classList.remove("red", "green", "orange");
            rowSpans[0].classList.add(typeToColorClass[archiveType]);
  
            const dtArchive = new Date(archiveDate);
            rowSpans[0].title = dtArchive.toLocaleString("tr-TR");
            console.log(`‚úÖ [${dataTag}] Archive tipi: ${archiveType} (${typeToColorClass[archiveType]})`);
          }
  
          // 2Ô∏è‚É£ Now S√ºtunu Tooltip + Renk
          if (typeToColorClass[nowType]) {
            rowSpans[1].classList.remove("red", "green", "orange");
            rowSpans[1].classList.add(typeToColorClass[nowType]);
  
            const dtNow = new Date(lastLogDate);
            rowSpans[1].title = dtNow.toLocaleString("tr-TR");
            console.log(`‚úÖ [${dataTag}] Now tipi: ${nowType} (${typeToColorClass[nowType]})`);
          }
  
          // 3Ô∏è‚É£ Last Connection Date H√ºcresini G√ºncelle
          if (allCells[3] && lastLogDate) {
            const dtNow = new Date(lastLogDate);
            allCells[3].textContent = dtNow.toLocaleString("tr-TR");
          }
        });
  
        console.log("[LOG] Archive log durumu ba≈üarƒ±yla i≈ülendi.");
        hideTableLoading();
      })
      .catch((error) => {
        console.error("[LOG] Archive log durumu alƒ±namadƒ±:", error);
        hideTableLoading();
      });
  });
  


/**

document.addEventListener("DOMContentLoaded", function () {
  showTableLoading("Veriler getiriliyor...");

  const typeToColorClass = {
    1: "green",
    2: "orange",
    3: "red",
  };

  const tagMapping = {
    wifi_connection: "ƒ∞nternet Var Mƒ±?",
    cloud_connection: "modem bilgisi buluta g√∂nderildi mi?",
    vpn_connection: "VPN IP Adresi",
    rabbitmq: "Rabbit MQya Basƒ±lan veri",
  };

  const rows = Array.from(document.querySelectorAll("tbody tr"));
  const now = new Date();
  const tagsToFallback = [];

  fetch("/get_archive_log_status")
    .then((response) => response.json())
    .then((archiveResult) => {
      if (archiveResult.status !== "success" || !archiveResult.data) {
        throw new Error("Ge√ßersiz archive log yapƒ±sƒ±");
      }

      const archiveData = archiveResult.data;

      Object.entries(tagMapping).forEach(([tag, label]) => {
        const row = rows.find((tr) => tr.dataset.tag === tag);
        if (!row) return;

        const archiveKey = Object.keys(archiveData).find(
          (k) => k.toLowerCase() === label.toLowerCase()
        );

        const archiveInfo = archiveKey ? archiveData[archiveKey] : null;
        const rowSpans = row.querySelectorAll(".status-dot");
        const allCells = row.querySelectorAll("td");

        // 1Ô∏è‚É£ Archive Renk ve Tooltip
        if (archiveInfo?.archive_log_type) {
          const archiveDate = new Date(archiveInfo.archive_log_date);
          rowSpans[0].classList.remove("red", "green", "orange");
          rowSpans[0].classList.add(typeToColorClass[archiveInfo.archive_log_type]);
          rowSpans[0].title = archiveDate.toLocaleString("tr-TR");
        }

        // 2Ô∏è‚É£ Now: Archive'daki tarih 24 saat i√ßinde mi?
        const lastLogDate = archiveInfo?.last_log_date ? new Date(archiveInfo.last_log_date) : null;
        const isValid = lastLogDate && (now - lastLogDate) < 24 * 60 * 60 * 1000;

        if (archiveInfo?.last_log_type && isValid) {
          rowSpans[1].classList.remove("red", "green", "orange");
          rowSpans[1].classList.add(typeToColorClass[archiveInfo.last_log_type]);
          rowSpans[1].title = lastLogDate.toLocaleString("tr-TR");
          if (allCells[3]) allCells[3].textContent = lastLogDate.toLocaleString("tr-TR");
        } else {
          tagsToFallback.push(tag);  // Bu tag i√ßin cihazdan veri alacaƒüƒ±z
        }
      });

      return tagsToFallback;
    })
    .then((missingTags) => {
      if (!missingTags.length) {
        hideTableLoading();
        return;
      }

      // ‚è≥ Archive'da olmayanlarƒ± cihazdan al
      return fetch("/wi-fi-list", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      })
        .then(res => res.json())
        .then(deviceData => {
          if (deviceData.status !== "success" || !deviceData.data) return;
          const data = deviceData.data;

          const connectionMap = {
            wifi_connection: data.wifi_connected,
            vpn_connection: data.vpn_connected,
            rabbitmq: data.rabbitmq_connected,
            cloud_connection: data.cloud_connected ?? false,
          };

          missingTags.forEach((tag) => {
            const row = rows.find((tr) => tr.dataset.tag === tag);
            if (!row) return;

            const dotNow = row.querySelectorAll(".status-dot")[1];
            const dateCell = row.querySelectorAll("td")[3];

            const isConnected = connectionMap[tag];
            dotNow.classList.remove("green", "red");
            dotNow.classList.add(isConnected ? "green" : "red");
            dotNow.title = isConnected ? "Baƒülƒ±" : "Baƒülƒ± deƒüil";
            if (dateCell) dateCell.textContent = data.last_connected_time || "-";
          });
        });
    })
    .catch((err) => {
      console.error("üõë Hata olu≈ütu:", err);
    })
    .finally(() => {
      hideTableLoading();
    });
});

**/
    document.addEventListener("DOMContentLoaded", function() {
      const now = new Date();
  
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');  
      const year = now.getFullYear();
  
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
  
      const formattedDate = `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
  
      document.getElementById("lora-date").innerText = formattedDate;
    });
  </script>
  
  <style>
    .highlight {
      color: #88acff;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      display: inline-block;
      border-radius: 50%;
    }
  
    .status-dot.red {
      background-color: red;
    }
  
    .status-dot.green {
      background-color: #33ff00;
    }
  
    .status-dot.orange {
      background-color: #FF0F00;
    }
  
    .table-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      backdrop-filter: blur(1px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
  
    .loading-box {
      text-align: center;
    }
  
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #ef8018;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
  
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
  {% endblock %}
  