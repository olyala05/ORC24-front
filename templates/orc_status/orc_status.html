{% extends "layout.html" %} 

{% block title %} {{ _('ORC Status') }} {% endblock %} 

{% block content %}

<div class="orc-status-container">
  <!-- Header -->
  {% include 'partials/header.html' %}

  <!-- ORC Status İçeriği -->
  <div class="orc-content">

    <div class="device-info">
      <ul>
        <li><span class="highlight">{{ _('S/N') }}</span> <span>{{ modem.serial_no if modem.serial_no else '-' }}</span></li>
        <li><span class="highlight">{{ _('MODEM NAME') }}</span> <span>{{ modem.name if modem.name else '-' }}</span></li>
        <li><span class="highlight">{{ _('MODEM BRAND / MODEL') }}</span> <span id="brand-model">-</span></li>
        
        <li>
          <span class="highlight"> {{ _('MODEM STATUS')}}</span>
         
          <span
            >{% if modem.status == "A" %} {{ _('Active')}} {% else %} {{ _('Passive')}} {% endif %}</span>
        </li>
        <li><span class="highlight">{{ _('DATE OF INSTALLATION')}} </span><span>{{modem.created_at if modem.created_at else '-'}}</span></li>
        <!-- <li><span class="highlight">{{ _('DATA READING INTERVAL')}}</span> <span>1380 Seconds</span></li> -->
        
        <li><span class="highlight">{{ _('NETWORK TYPE')}} </span>
          <span>
              {% if network and network.network_type_list %}
                  {{ network.network_type_list | join(" / ") }}
              {% else %}
                  {{ _('Disconnected')}}
              {% endif %}
          </span>
        </li>      
        <li><span class="highlight">{{ _('CONNECTION PROTOCOL') }}</span> <span id="connection-protocol">-</span></li>
        <li><span class="highlight">{{ _('SOFTWARE VERSION')}}</span> <span>V 1.02</span></li>
      </ul>
    </div>

    <div class="connection-table">
      <table>
        <thead>
          <tr>
            <th>{{ _('Archive')}}</th>
            <th>{{ _('Now')}}</th>
            <th>{{ _('Modem Name')}}</th>
            <th>{{ _('Last Connection Date')}}</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>{{ _('Lora Disconnection')}}</td>
            <td>2024-04-03 13:54:31</td>
          </tr>

          <tr>
            {% if network.wifi_connected %}
                <td><span class="status-dot #33FF00"></span></td>
                <td><span class="status-dot #33FF00"></span></td>
                <td>{{ _('WiFi Connection')}}</td>
                <td>{{ network.last_connected_time }}</td> 
            {% else %}
                <td><span class="status-dot red"></span></td>
                <td><span class="status-dot red"></span></td>
                <td>{{ _('WiFi Disconnected')}}</td>
                <td>{{ network.last_connected_time }}</td> 
            {% endif %}
          </tr>
        
          <tr data-status="cloud">
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>{{ _('Cloud Connection')}}</td>
            <td class="last-connection">{{ _('Checking...')}}</td> 
          </tr>
      
          <tr data-status="rabbitmq">
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>{{ _('Rabbit MQ')}}</td>
            <td class="last-connection">{{ _('Checking...')}}</td>
          </tr>
        
          <tr>
            {% if network.vpn_connected %}
                <td><span class="status-dot #33FF00"></span></td>
                <td><span class="status-dot #33FF00"></span></td>
                <td>{{ _('VPN Connection')}}</td>
                <td>{{ network.last_connected_time }}</td> 
            {% else %}
                <td><span class="status-dot red"></span></td>
                <td><span class="status-dot red"></span></td>
                <td>{{ _('VPN Disconnected')}}</td>
                <td>{{ network.last_connected_time }}</td> 
            {% endif %}
          </tr>
        </tbody>

      </table>

      <div class="algorithm-section">
        <h3 style="text-align: start; margin-left: 17px;">{{ _('Algorithm Processes')}}</h3>
        <div class="separator"></div>
        <!-- Turuncu çizgi -->
        <div class="algorithm-box">
          <div class="algorithm-left">
            <i class="fa fa-refresh" aria-hidden="true"></i>  <span>{{ _('ORC Process Procedures')}}</span>        
          </div>
          <!-- !! burada eğer hata var ise kırmızız yap buttonu  !!-->
          <button class="status-btn" onclick="redirectToLog()">{{ _('Logs')}}</button>
        </div>
      </div>
    </div>

  </div>

<script>

  function redirectToLog() {
    window.location.href = "{{ url_for('log')}}"
  }

  function retryConnection() {
    fetch("/check_network")
      .then(response => response.json())
      .then(result => {
        console.log("Network Data:", result.data);
        const network = result.data;
        if (network && network.connected_ssid && network.connected_ssid !== "Not Connected") {
          location.reload();
        } else {
          Swal.fire({
            icon: "error",
            title: "{{ _('No Wi-Fi Connection!') }}",
            text: "{{ _('Please check your modem and connections.') }}",
            confirmButtonText: "{{ _('OK') }}"
          });
        }
      })
      .catch(error => {
        console.error("Bağlantı kontrolü sırasında hata oluştu:", error);
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const disconnectBtn = document.querySelector(".disconnect-btn");
    disconnectBtn.addEventListener("click", function () {
        fetch("/disconnect_request", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            alert("Wi-Fi bağlantısı kapatıldı!");
        })
        .catch(error => console.error("Error:", error));
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    fetch("/equipments-with-models", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
    })
    .then(response => response.json())
    .then(data => {
        console.log("Gelen JSON:", data);  

        if (data.data && data.data.length > 0) { 
            let protocolText = "-";
            let equipment = data.data[0];  

            if (equipment.communication_protocol_code === 1) {
                protocolText = "SERIAL";
            } else if (equipment.communication_protocol_code === 2) {
                protocolText = "TCP";
            } else if (equipment.communication_protocol_code === 0) {
                protocolText = "UNKNOWN";
            }

            document.getElementById("connection-protocol").innerText = protocolText;
        } else {
            document.getElementById("connection-protocol").innerText = "-";
        }
    })
    .catch(error => {
        console.error("API isteği hatası:", error);
        document.getElementById("connection-protocol").innerText = "Error fetching data";
    });
  });

  // RabbitMQ Status Checking
  document.addEventListener("DOMContentLoaded", function () {
    function updateRabbitMQStatus() {
      fetch("/rabbitmq-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        const rabbitmqStatusRow = document.querySelector("tr[data-status='rabbitmq']");
        const statusCells = rabbitmqStatusRow.querySelectorAll(".status-dot");
        const lastConnectionCell = rabbitmqStatusRow.querySelector(".last-connection");

        if (data.status === "success" && data.data.rabbitmq_connected) {
          statusCells.forEach(cell => {
            cell.classList.remove("red");
            cell.classList.add("green");
          });
        } else {
          statusCells.forEach(cell => {
            cell.classList.remove("green");
            cell.classList.add("red");
          });
        }

        // Last Connection Date'yi güncelle
        if (data.data.last_connection_time) {
          lastConnectionCell.textContent = data.data.last_connection_time;
        } else {
          lastConnectionCell.textContent = "No connection yet";
        }
      })
      .catch(error => {
        console.error("Error fetching RabbitMQ status:", error);
      });
    }

    // Sayfa yüklendiğinde RabbitMQ bağlantısını kontrol et
    updateRabbitMQStatus();

    // RabbitMQ bağlantısını her 10 saniyede bir kontrol et
    setInterval(updateRabbitMQStatus, 10000);
  });

  // Cloud Status Checking  
  document.addEventListener("DOMContentLoaded", function () {
    function updateCloudStatus() {
      fetch("/cloud-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        const cloudStatusRow = document.querySelector("tr[data-status='cloud']");
        const statusCells = cloudStatusRow.querySelectorAll(".status-dot");
        const lastConnectionCell = cloudStatusRow.querySelector(".last-connection");

        if (data.status === "success" && data.data.cloud_connected) {
          statusCells.forEach(cell => {
            cell.classList.remove("red");
            cell.classList.add("green");
          });
        } else {
          statusCells.forEach(cell => {
            cell.classList.remove("green");
            cell.classList.add("red");
          });
        }

        // Son bağlantı tarihini güncelle
        lastConnectionCell.textContent = data.data.last_connection_time
          ? data.data.last_connection_time
          : "No connection yet";
      })
      .catch(error => {
        console.error("Error fetching Cloud status:", error);
      });
    }

    // Sayfa yüklendiğinde kontrol et
    updateCloudStatus();

    // Bulut bağlantısını her 10 saniyede bir kontrol et
    setInterval(updateCloudStatus, 10000);
  });

  async function fetchBrandModel() {
    try {
        const response = await fetch("/get-all-equipments", { method: "POST" });

        if (!response.ok) {
            throw new Error("Server hatası: " + response.status);
        }

        const data = await response.json();
        if (data.status === "error") {
            throw new Error("API Hatası: " + data.message);
        }

        const equipments = data.data;
        if (!equipments.length) {
            throw new Error("Ekipman bilgisi bulunamadı.");
        }

        const brandModel = equipments[0].equipment_model_name || "-"; 
        document.getElementById("brand-model").textContent = brandModel;

    } catch (error) {
        console.error("Hata:", error);
        document.getElementById("brand-model").textContent = "Veri alınamadı";
    }
  }

  // Sayfa yüklendiğinde otomatik olarak modem model bilgisini çek
  window.onload = fetchBrandModel;

  document.addEventListener("DOMContentLoaded", function () {
  fetch("/get_archive_log_status")
    .then(response => response.json())
    .then(data => {
      console.log("[LOG] Archive log status fetch başladı.");

      if (data.status !== "success" || !data.data) {
        console.warn("[LOG] Geçersiz yanıt yapısı");
        return;
      }

      const archiveData = data.data;

      const tagMapping = {
        "WiFi Connection": "İnternet Var Mı?",
        "VPN Connection": "VPN IP Adresi",
        "Cloud Connection": "Modem bilgisi buluta gönderildi mi?",
        "Rabbit MQ": "rabbit mqya basılan veri"
      };

      const typeToColorClass = {
        1: "green",
        2: "orange",
        3: "red"
      };

      Object.entries(tagMapping).forEach(([uiLabel, archiveTag]) => {
        const rows = Array.from(document.querySelectorAll("tbody tr"));
        const row = rows.find(tr => tr.innerText.includes(uiLabel));

        if (!row || !archiveData[archiveTag]) {
          console.warn(`[LOG] ${uiLabel} satırı veya verisi bulunamadı.`);
          return;
        }

        const rowSpans = row.querySelectorAll(".status-dot");
        const archiveType = archiveData[archiveTag].archive_log_type;
        const nowType = archiveData[archiveTag].last_log_type;
        const lastLogDate = archiveData[archiveTag].last_log_date;

        // Log: hangi tipler geldi
        console.log(`[LOG] ${uiLabel} archive_log_type: ${archiveType}, last_log_type: ${nowType}, date: ${lastLogDate}`);

        // Archive Sütunu (ilk status-dot)
        if (typeToColorClass[archiveType]) {
          rowSpans[0].classList.remove("red", "green", "orange");
          rowSpans[0].classList.add(typeToColorClass[archiveType]);
        }

        // Now Sütunu (ikinci status-dot)
        if (typeToColorClass[nowType]) {
          rowSpans[1].classList.remove("red", "green", "orange");
          rowSpans[1].classList.add(typeToColorClass[nowType]);
        }

        // Last Connection Date güncelle
        const lastDateCell = row.querySelector(".last-connection");
        if (lastDateCell && lastLogDate) {
          const dt = new Date(lastLogDate);
          lastDateCell.textContent = dt.toLocaleString("tr-TR", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
          });
        }
      });

      console.log("[LOG] Archive log durumu başarıyla işlendi.");
    })
    .catch(error => {
      console.error("[LOG] Archive log durumu alınamadı:", error);
    });
  });

</script>

<style>
  .highlight {
    color: #88ACFF;
  }
   .status-dot {
    width: 10px;
    height: 10px;
    display: inline-block;
    border-radius: 50%;
  }

  .status-dot.red {
    background-color: red;
  }

  .status-dot.green {
    background-color: #33FF00;
  }
</style>
{% endblock %}

