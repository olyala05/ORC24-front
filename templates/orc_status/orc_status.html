{% extends "layout.html" %} 

{% block title %} ORC Status {% endblock %} 

{% block content %}
<div class="orc-status-container">
  <!-- Header -->
  {% include 'partials/header.html' %}

  <!-- ORC Status İçeriği -->
  <div class="orc-content">
    <div class="device-info">
      <ul>
        <li>S/N: <span>{{ modem.serial_no if modem.serial_no else '-' }}</span></li>
        <li>MODEM NAME: <span>{{ modem.name if modem.name else '-' }}</span></li>
        <li>MODEM BRAND / MODEL: <span>{{ modem.brand_model if modem.brand_model else '-' }}</span></li>
        <li>
          MODEM STATUS:
          <span
            >{% if modem.status == "A" %} Active {% else %} Passive {% endif %}</span>
        </li>
        <li>DATE OF INSTALLATION: <span>{{modem.created_at if modem.created_at else '-'}}</span></li>
        <li>DATA READING INTERVAL: <span>1380 Seconds</span></li>
        <li>NETWORK TYPE: 
          <span>
              {% if network and network.network_type_list %}
                  {{ network.network_type_list | join(" / ") }}
              {% else %}
                  Disconnected
              {% endif %}
          </span>
        </li>      
        <li>CONNECTION PROTOCOL: <span id="connection-protocol">-</span></li>
        <li>SOFTWARE VERSION: <span>V 1.02</span></li>
      </ul>

      <div class="connection-status">
        {% if network and network.connected_ssid and network.connected_ssid != "Not Connected" %}
            <!-- Wi-Fi Bağlıysa -->
            <span class="status-title">
              {% if network and network.active_connections %}
                  Connected {{ network.active_connections | join(" / ") }}
              {% else %}
                  Disconnected
              {% endif %}
            </span>
            <div class="separator"></div>
            <div class="status-details">
                <div class="status-left">
                    <i class="fas fa-wifi"></i> {{ network.connected_ssid }}
                </div>
            </div>
        {% else %}
            <!-- Wi-Fi Bağlı Değilse -->
            <span class="status-title error-message">
                Checking the network cables, modem and router <br>
                Reconnecting to Wi-Fi
            </span>
            <div class="separator"></div>
            <div class="status-details">
              <div class="status-left">
                <img  src="{{ url_for('static', filename='images/svg/11.svg') }}" alt="No Wi Fi"></img> No Internet</div>
                <button class="retry-btn" onclick="retryConnection()">Retry</button>
            </div>
        {% endif %}
    </div>
    </div>

    <div class="connection-table">
      <table>
        <thead>
          <tr>
            <th>Archive</th>
            <th>End</th>
            <th>Modem Name</th>
            <th>Last Connection Date</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>Lora Disconnection</td>
            <td>2024-04-03 13:54:31</td>
          </tr>

          <tr>
            {% if network.wifi_connected %}
                <td><span class="status-dot green"></span></td>
                <td><span class="status-dot green"></span></td>
                <td>WiFi Connection</td>
                <td>{{ network.last_connected_time }}</td> 
            {% else %}
                <td><span class="status-dot red"></span></td>
                <td><span class="status-dot red"></span></td>
                <td>WiFi Disconnected</td>
                <td>{{ network.last_connected_time }}</td> 
            {% endif %}
        </tr>
        
          <tr data-status="cloud">
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>Cloud Connection</td>
            <td class="last-connection">Checking...</td> 
          </tr>
      

          <tr data-status="rabbitmq">
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>Rabbit MQ</td>
            <td class="last-connection">Checking...</td>
          </tr>
        

          <tr>
            {% if network.ethernet_connected %}
                <td><span class="status-dot green"></span></td>
                <td><span class="status-dot green"></span></td>
                <td>Ethernet Connection</td>
                <td>{{ network.last_connected_time }}</td> 
            {% else %}
                <td><span class="status-dot red"></span></td>
                <td><span class="status-dot red"></span></td>
                <td>Ethernet Disconnected</td>
                <td>{{ network.last_connected_time }}</td> 
            {% endif %}
          </tr>
          <tr>
            {% if network.vpn_connected %}
                <td><span class="status-dot green"></span></td>
                <td><span class="status-dot green"></span></td>
                <td>VPN Connection</td>
                <td>{{ network.last_connected_time }}</td> 
            {% else %}
                <td><span class="status-dot red"></span></td>
                <td><span class="status-dot red"></span></td>
                <td>VPN Disconnected</td>
                <td>{{ network.last_connected_time }}</td> 
            {% endif %}
        </tr>
        
        </tbody>
      </table>

      <div class="algorithm-section">
        <h3>Algorithm Processes</h3>
        <div class="separator"></div>
        <!-- Turuncu çizgi -->
        <div class="algorithm-box">
          <div class="algorithm-left">
            <i class="fas fa-cog"></i> <span class="margin-right-70" style="margin-right: 70px;">ORC Process Procedures</span>          
          </div>
          <button class="status-btn" onclick="redirectToLog()">Normal / Error (Red)</button>
        </div>
      </div>
    </div>
  </div>

<script>

  function redirectToLog() {
    window.location.href = "{{ url_for('log')}}"
  }

function retryConnection() {
  fetch("/check_network")
    .then(response => response.json())
    .then(result => {
      console.log("Network Data:", result.data);
      const network = result.data;
      if (network && network.connected_ssid && network.connected_ssid !== "Not Connected") {
        location.reload();
      } else {
        Swal.fire({
          icon: "error",
          title: "Wi-Fi Bağlantısı Yok!",
          text: "Lütfen modeminizi ve bağlantılarınızı kontrol edin.",
          confirmButtonText: "Tamam"
        });
      }
    })
    .catch(error => {
      console.error("Bağlantı kontrolü sırasında hata oluştu:", error);
    });
}

document.addEventListener("DOMContentLoaded", function () {
  const disconnectBtn = document.querySelector(".disconnect-btn");
  disconnectBtn.addEventListener("click", function () {
      fetch("/disconnect_request", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
      })
      .then(response => response.json())
      .then(data => {
          console.log(data);
          alert("Wi-Fi bağlantısı kapatıldı!");
      })
      .catch(error => console.error("Error:", error));
  });
});

document.addEventListener("DOMContentLoaded", function () {
  fetch("/equipments-with-models", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
  })
  .then(response => response.json())
  .then(data => {
      console.log("Gelen JSON:", data);  

      if (data.data && data.data.length > 0) { 
          let protocolText = "-";
          let equipment = data.data[0];  

          if (equipment.communication_protocol_code === 1) {
              protocolText = "SERIAL";
          } else if (equipment.communication_protocol_code === 2) {
              protocolText = "TCP";
          }

          // HTML içindeki CONNECTION PROTOCOL değerini güncelle
          document.getElementById("connection-protocol").innerText = protocolText;
      } else {
          document.getElementById("connection-protocol").innerText = "-";
      }
  })
  .catch(error => {
      console.error("API isteği hatası:", error);
      document.getElementById("connection-protocol").innerText = "Error fetching data";
  });
});

// RabbitMQ Status Checking
document.addEventListener("DOMContentLoaded", function () {
  function updateRabbitMQStatus() {
    fetch("/rabbitmq-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      const rabbitmqStatusRow = document.querySelector("tr[data-status='rabbitmq']");
      const statusCells = rabbitmqStatusRow.querySelectorAll(".status-dot");
      const lastConnectionCell = rabbitmqStatusRow.querySelector(".last-connection");

      if (data.status === "success" && data.data.rabbitmq_connected) {
        statusCells.forEach(cell => {
          cell.classList.remove("red");
          cell.classList.add("green");
        });
      } else {
        statusCells.forEach(cell => {
          cell.classList.remove("green");
          cell.classList.add("red");
        });
      }

      // Last Connection Date'yi güncelle
      if (data.data.last_connection_time) {
        lastConnectionCell.textContent = data.data.last_connection_time;
      } else {
        lastConnectionCell.textContent = "No connection yet";
      }
    })
    .catch(error => {
      console.error("Error fetching RabbitMQ status:", error);
    });
  }

  // Sayfa yüklendiğinde RabbitMQ bağlantısını kontrol et
  updateRabbitMQStatus();

  // RabbitMQ bağlantısını her 10 saniyede bir kontrol et
  setInterval(updateRabbitMQStatus, 10000);
});

// Cloud Status Checking  
document.addEventListener("DOMContentLoaded", function () {
  function updateCloudStatus() {
    fetch("/cloud-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      const cloudStatusRow = document.querySelector("tr[data-status='cloud']");
      const statusCells = cloudStatusRow.querySelectorAll(".status-dot");
      const lastConnectionCell = cloudStatusRow.querySelector(".last-connection");

      if (data.status === "success" && data.data.cloud_connected) {
        statusCells.forEach(cell => {
          cell.classList.remove("red");
          cell.classList.add("green");
        });
      } else {
        statusCells.forEach(cell => {
          cell.classList.remove("green");
          cell.classList.add("red");
        });
      }

      // Son bağlantı tarihini güncelle
      lastConnectionCell.textContent = data.data.last_connection_time
        ? data.data.last_connection_time
        : "No connection yet";
    })
    .catch(error => {
      console.error("Error fetching Cloud status:", error);
    });
  }

  // Sayfa yüklendiğinde kontrol et
  updateCloudStatus();

  // Bulut bağlantısını her 10 saniyede bir kontrol et
  setInterval(updateCloudStatus, 10000);
});

</script>

{% endblock %}

