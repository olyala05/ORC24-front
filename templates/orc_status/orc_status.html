{% extends "layout.html" %} 

{% block title %} ORC Status {% endblock %} 

{% block content %}
<div class="orc-status-container">
  <!-- Header -->
  {% include 'partials/header.html' %}

  <!-- ORC Status İçeriği -->
  <div class="orc-content">
    <div class="device-info">
      <ul>
        <li>S/N: <span>{{modem.serial_no}}</span></li>
        <li>MODEM NAME: <span>{{ modem.name }}</span></li>
        <li>MODEM BRAND / MODEL: <span>ORC 23 OwL</span></li>
        <li>
          MODEM STATUS:
          <span
            >{% if modem.status == "A" %} Active {% else %} Passive {% endif
            %}</span
          >
        </li>
        <li>DATE OF INSTALLATION: <span>{{modem.created_at}}</span></li>
        <li>DATA READING INTERVAL: <span>1380 Seconds</span></li>
        <li>NETWORK TYPE: 
          <span>
              {% if network and network.network_type_list %}
                  {{ network.network_type_list | join(" / ") }}
              {% else %}
                  Disconnected
              {% endif %}
          </span>
        </li>      
        <li>CONNECTION PROTOCOL: <span id="connection-protocol">Loading...</span></li>
        <li>SOFTWARE VERSION: <span>V 1.02</span></li>
      </ul>

      <div class="connection-status">
        {% if network and network.connected_ssid and network.connected_ssid != "Not Connected" %}
            <!-- Wi-Fi Bağlıysa -->
            <span class="status-title">
              {% if network and network.active_connections %}
                  Connected {{ network.active_connections | join(" / ") }}
              {% else %}
                  Disconnected
              {% endif %}
            </span>
            <div class="separator"></div>
            <div class="status-details">
                <div class="status-left">
                    <i class="fas fa-wifi"></i> {{ network.connected_ssid }}
                </div>
            </div>
        {% else %}
            <!-- Wi-Fi Bağlı Değilse -->
            <span class="status-title error-message">
                Checking the network cables, modem and router <br>
                Reconnecting to Wi-Fi
            </span>
            <div class="separator"></div>
            <div class="status-details">
              <div class="status-left">
                <img  src="{{ url_for('static', filename='images/svg/11.svg') }}" alt="No Wi Fi"></img> No Internet</div>
                <button class="retry-btn" onclick="retryConnection()">Retry</button>
            </div>
        {% endif %}
    </div>
    </div>

    <div class="connection-table">
      <table>
        <thead>
          <tr>
            <th>Archive</th>
            <th>End</th>
            <th>Modem Name</th>
            <th>Last Connection Date</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>Lora Disconnection</td>
            <td>2024-04-03 13:54:31</td>
          </tr>

          <tr>
            {% if network.wifi_connected %}
                <td><span class="status-dot green"></span></td>
                <td><span class="status-dot green"></span></td>
                <td>WiFi Connection</td>
                <td>{{ network.last_connected_time }}</td> 
            {% else %}
                <td><span class="status-dot red"></span></td>
                <td><span class="status-dot red"></span></td>
                <td>WiFi Disconnected</td>
                <td>{{ network.last_connected_time }}</td> 
            {% endif %}
        </tr>
        
          <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>Bulut Connection</td>
            <td>2024-04-03 13:55:00</td>
          </tr>
          <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>Rabbit Mq</td>
            <td>2024-04-03 13:55:11</td>
          </tr>
          <tr>
            {% if network.ethernet_connected %}
                <td><span class="status-dot green"></span></td>
                <td><span class="status-dot green"></span></td>
                <td>Ethernet Connection</td>
                <td>{{ network.last_connected_time }}</td> 
            {% else %}
                <td><span class="status-dot red"></span></td>
                <td><span class="status-dot red"></span></td>
                <td>Ethernet Disconnected</td>
                <td>{{ network.last_connected_time }}</td> 
            {% endif %}
          </tr>
          <tr>
            {% if network.vpn_connected %}
                <td><span class="status-dot green"></span></td>
                <td><span class="status-dot green"></span></td>
                <td>VPN Connection</td>
                <td>{{ network.last_connected_time }}</td> 
            {% else %}
                <td><span class="status-dot red"></span></td>
                <td><span class="status-dot red"></span></td>
                <td>VPN Disconnected</td>
                <td>{{ network.last_connected_time }}</td> 
            {% endif %}
        </tr>
        
        </tbody>
      </table>

      <div class="algorithm-section">
        <h3>Algorithm Processes</h3>
        <div class="separator"></div>
        <!-- Turuncu çizgi -->
        <div class="algorithm-box">
          <div class="algorithm-left">
            <i class="fas fa-cog"></i> <span class="margin-right-70" style="margin-right: 70px;">ORC Process Procedures</span>          
          </div>
          <button class="status-btn" onclick="redirectToLog()">Normal / Error (Red)</button>
        </div>
      </div>
    </div>
  </div>

<script>

  function redirectToLog() {
    window.location.href = "{{ url_for('log')}}"
  }

function retryConnection() {
  fetch("/check_network")
    .then(response => response.json())
    .then(result => {
      console.log("Network Data:", result.data);
      const network = result.data;
      if (network && network.connected_ssid && network.connected_ssid !== "Not Connected") {
        location.reload();
      } else {
        Swal.fire({
          icon: "error",
          title: "Wi-Fi Bağlantısı Yok!",
          text: "Lütfen modeminizi ve bağlantılarınızı kontrol edin.",
          confirmButtonText: "Tamam"
        });
      }
    })
    .catch(error => {
      console.error("Bağlantı kontrolü sırasında hata oluştu:", error);
    });
}

document.addEventListener("DOMContentLoaded", function () {
  const disconnectBtn = document.querySelector(".disconnect-btn");
  disconnectBtn.addEventListener("click", function () {
      fetch("/disconnect_request", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
      })
      .then(response => response.json())
      .then(data => {
          console.log(data);
          alert("Wi-Fi bağlantısı kapatıldı!");
      })
      .catch(error => console.error("Error:", error));
  });
});

document.addEventListener("DOMContentLoaded", function () {
  fetch("/equipments-with-models", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
  })
  .then(response => response.json())
  .then(data => {
      if (data.equipment_data && data.equipment_data.communication_protocol_code) {
          let protocolText = "Unknown";

          if (data.equipment_data.communication_protocol_code === 1) {
              protocolText = "SERIAL";
          } else if (data.equipment_data.communication_protocol_code === 2) {
              protocolText = "TCP";
          }

          // HTML içindeki CONNECTION PROTOCOL değerini güncelle
          document.getElementById("connection-protocol").innerText = protocolText;
      } else {
          document.getElementById("connection-protocol").innerText = "Unknown";
      }
  })
  .catch(error => {
      console.error("API isteği hatası:", error);
      document.getElementById("connection-protocol").innerText = "Error fetching data";
  });
});

</script>

{% endblock %}

