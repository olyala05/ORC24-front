{% extends "layout.html" %} 

{% block title %} {{ _('ORC Status') }} {% endblock %} 

{% block content %}

<div class="orc-status-container">
  <!-- Header -->
  {% include 'partials/header.html' %}

  <!-- ORC Status İçeriği -->
  <div class="orc-content">

    <div class="device-info">
      <ul>
        <li><span class="highlight">{{ _('S/N') }}</span> <span>{{ modem.serial_no if modem.serial_no else '-' }}</span></li>
        <li><span class="highlight">{{ _('MODEM NAME') }}</span> <span>{{ modem.name if modem.name else '-' }}</span></li>
        <li><span class="highlight">{{ _('MODEM BRAND / MODEL') }}</span> <span id="brand-model">-</span></li>
        
        <li>
          <span class="highlight"> {{ _('MODEM STATUS')}}</span>
         
          <span
            >{% if modem.status == "A" %} {{ _('Active')}} {% else %} {{ _('Passive')}} {% endif %}</span>
        </li>
        <li><span class="highlight">{{ _('DATE OF INSTALLATION')}} </span><span>{{modem.created_at if modem.created_at else '-'}}</span></li>
        <!-- <li><span class="highlight">{{ _('DATA READING INTERVAL')}}</span> <span>1380 Seconds</span></li> -->
        
        <li><span class="highlight">{{ _('NETWORK TYPE')}} </span>
          <span>
              {% if network and network.network_type_list %}
                  {{ network.network_type_list | join(" / ") }}
              {% else %}
                  {{ _('Disconnected')}}
              {% endif %}
          </span>
        </li>      
        <li><span class="highlight">{{ _('CONNECTION PROTOCOL') }}</span> <span id="connection-protocol">-</span></li>
        <li><span class="highlight">{{ _('SOFTWARE VERSION')}}</span> <span>V 1.02</span></li>
      </ul>
    </div>

    <div class="connection-table">
      <table>
        <thead>
          <tr>
            <th>{{ _('Archive')}}</th>
            <th>{{ _('Now')}}</th>
            <th>{{ _('Modem Name')}}</th>
            <th>{{ _('Last Connection Date')}}</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>{{ _('Lora Disconnection')}}</td>
            <td>2024-04-03 13:54:31</td>
          </tr>

          <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>{{ _('WiFi Connection')}}</td>
            <td>2024-04-03 13:54:31</td>
          </tr>
        
          <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>{{ _('Cloud Connection')}}</td>
            <td>2024-04-03 13:54:31</td>
          </tr>

          <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>{{ _('Rabbit MQ')}}</td>
            <td>2024-04-03 13:54:31</td>
          </tr>

           <tr>
            <td><span class="status-dot red"></span></td>
            <td><span class="status-dot red"></span></td>
            <td>{{ _('VPN Connection')}}</td>
            <td>2024-04-03 13:54:31</td>
          </tr>
        </tbody>

      </table>

      <div class="algorithm-section">
          <h3 style="text-align: start; margin-left: 17px;">{{ _('Algorithm Processes')}}</h3>
          <div class="separator"></div>
          <!-- Turuncu çizgi -->
        <div class="algorithm-box">
            <div class="algorithm-left">
              <i class="fa fa-refresh" aria-hidden="true"></i>  <span>{{ _('ORC Process Procedures')}}</span>        
            </div>
            <!-- !! burada eğer hata var ise kırmızız yap buttonu  !!-->
            <button class="status-btn" onclick="redirectToLog()">{{ _('Logs')}}</button>
        </div>
      </div>
    </div>

  </div>

<script>

  function redirectToLog() {
    window.location.href = "{{ url_for('log')}}"
  }

  document.addEventListener("DOMContentLoaded", function () {
    fetch("/equipments-with-models", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
    })
    .then(response => response.json())
    .then(data => {
        console.log("Gelen JSON:", data);  

        if (data.data && data.data.length > 0) { 
            let protocolText = "-";
            let equipment = data.data[0];  

            if (equipment.communication_protocol_code === 1) {
                protocolText = "SERIAL";
            } else if (equipment.communication_protocol_code === 2) {
                protocolText = "TCP";
            } else if (equipment.communication_protocol_code === 0) {
                protocolText = "UNKNOWN";
            }

            document.getElementById("connection-protocol").innerText = protocolText;
        } else {
            document.getElementById("connection-protocol").innerText = "-";
        }
    })
    .catch(error => {
        console.error("API isteği hatası:", error);
        document.getElementById("connection-protocol").innerText = "Error fetching data";
    });
  });

  async function fetchBrandModel() {
    try {
        const response = await fetch("/get-all-equipments", { method: "POST" });

        if (!response.ok) {
            throw new Error("Server hatası: " + response.status);
        }

        const data = await response.json();
        if (data.status === "error") {
            throw new Error("API Hatası: " + data.message);
        }

        const equipments = data.data;
        if (!equipments.length) {
            throw new Error("Ekipman bilgisi bulunamadı.");
        }

        const brandModel = equipments[0].equipment_model_name || "-"; 
        document.getElementById("brand-model").textContent = brandModel;

    } catch (error) {
        console.error("Hata:", error);
        document.getElementById("brand-model").textContent = "Veri alınamadı";
    }
  }
  // Sayfa yüklendiğinde otomatik olarak modem model bilgisini çek
  window.onload = fetchBrandModel;

  document.addEventListener("DOMContentLoaded", function () {
    fetch("/get_archive_log_status")
      .then(response => response.json())
      .then(data => {
        console.log("[LOG] Archive log status fetch başladı.");

        if (data.status !== "success" || !data.data) {
          console.warn("[LOG] Geçersiz yanıt yapısı");
          return;
        }

        const archiveData = data.data;

        const tagMapping = {
          "WiFi Connection": "İnternet Var Mı?",
          "Cloud Connection": "Modem bilgisi buluta gönderildi mi?",
          "VPN Connection": "VPN IP Adresi",
          "Rabbit MQ": "rabbit mqya basılan veri"
        };

        const typeToColorClass = {
          1: "green",
          2: "orange",
          3: "red"
        };

        const rows = Array.from(document.querySelectorAll("tbody tr"));
        console.log("[LOG] Tablodaki Satırlar:");
        rows.forEach((r, index) => {
          console.log(`Row ${index + 1}:`, r.innerText.trim());
        });

        Object.entries(tagMapping).forEach(([uiLabel, archiveTag]) => {
          console.log(`\n[LOG] İşleniyor: ${uiLabel} -> ${archiveTag}`);

          const row = rows.find(tr => tr.innerText.includes(uiLabel));

          if (!row) {
            console.warn(`[LOG] ${uiLabel} için satır bulunamadı.`);
            return;
          }

          if (!archiveData[archiveTag]) {
            console.warn(`[LOG] ${archiveTag} için veri bulunamadı.`);
            return;
          }

          console.log(`[LOG] Bulunan Satır: ${row.innerText.trim()}`);

          const archiveInfo = archiveData[archiveTag];
          console.log(`[LOG] Archive Info (${archiveTag}):`, archiveInfo);

          const rowSpans = row.querySelectorAll(".status-dot");
          const allCells = row.querySelectorAll("td");

          const archiveType = archiveInfo.archive_log_type;
          const nowType = archiveInfo.last_log_type;
          const archiveDate = archiveInfo.archive_log_date;
          const lastLogDate = archiveInfo.last_log_date;

          // 1️⃣ Archive Sütunu Tooltip + Renk
          if (typeToColorClass[archiveType]) {
            rowSpans[0].classList.remove("red", "green", "orange");
            rowSpans[0].classList.add(typeToColorClass[archiveType]);

            const dtArchive = new Date(archiveDate);
            let tooltipText = `Archive Date: ${dtArchive.toLocaleString("tr-TR")}`;

            if (archiveInfo.archive_log_data) {
              tooltipText += `\nData: ${formatData(archiveInfo.archive_log_data)}`;
            }

            rowSpans[0].title = tooltipText;
          }

          // 2️⃣ Now Sütunu Tooltip + Renk
          if (typeToColorClass[nowType]) {
            rowSpans[1].classList.remove("red", "green", "orange");
            rowSpans[1].classList.add(typeToColorClass[nowType]);

            const dtNow = new Date(lastLogDate);
            let tooltipText = `Now Date: ${dtNow.toLocaleString("tr-TR")}`;

            if (archiveInfo.last_log_data) {
              tooltipText += `\nData: ${formatData(archiveInfo.last_log_data)}`;
            }
            rowSpans[1].title = tooltipText;
          }

          // 3️⃣ Last Connection Date Hücresini Güncelle (4. hücre)
          if (allCells[3] && lastLogDate) {
            const dtNow = new Date(lastLogDate);
            allCells[3].textContent = dtNow.toLocaleString("tr-TR");
          }
        });

        console.log("[LOG] Archive log durumu başarıyla işlendi.");
      })
      .catch(error => {
        console.error("[LOG] Archive log durumu alınamadı:", error);
      });

    function formatData(data) {
      if (typeof data === "object") {
        if (data.description) {
          return data.description;
        }
        return JSON.stringify(data);
      }
      return data;
    }
  });

</script>

<style>
  .highlight {
    color: #88ACFF;
  }
   .status-dot {
    width: 10px;
    height: 10px;
    display: inline-block;
    border-radius: 50%;
  }

  .status-dot.red {
    background-color: red;
  }

  .status-dot.green {
    background-color: #33FF00;
  }

  .status-dot.orange {
    background-color: #EF8018;
  }
</style>
{% endblock %}

