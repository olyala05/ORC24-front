{% extends "layout.html" %} 

{% block title %} ORC Status - Error Log {% endblock%} 

{% block extra_css %}

<!-- CSS logs -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/log.css') }}" />

<!-- CSS calendar -->
<link rel="stylesheet" href="{{ url_for('static', filename='calendar/css/flatpickr.min.css') }}">

{% endblock %} 

{% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="log-container">

  <!--  Calendar -->
  <div id="calendar-container">
    <!-- Yeni:     <input
      type="text"
      id="log-date-picker"
      class="calendar-input"
      placeholder="Select Date"
    />-->


    <div class="calendar-input-wrapper">
      <!-- Flatpickr'a bağlanacak gizli input -->
      <input type="text" id="hidden-date-picker" style="display: none;" />

      <!-- Kullanıcıya gösterilecek input -->
      <input
        type="text"
        id="log-date-picker"
        class="calendar-input"
        placeholder="Select Date"
        readonly
      />

      <!-- Aç/kapa butonu -->
      <span class="calendar-icon" id="calendar-toggle">&#9662;</span>
    </div>

    <!-- Eskisi-->

    <!--    <input    
      type="date"
      id="log-date-picker"
      onchange="fetchLogsByDate()"
      class="calendar-input" 
    /> -->
  </div>

  <div class="log-table">
    <div class="log-table-content">
      <!-- Message for navigating back in time İsterler ise aç -->
      <div
        id="info-message"
        style="
          display: none;
          color: green;
          text-align: center;
          font-size: 14px;
          margin-top: 5px;
        "
      >
        You can select a date from the calendar to view past logs.
      </div>

      <!-- No Logs message -->
      <div
        id="no-logs-message"
        style="
          display: none;
          color: red;
          text-align: center;
          font-size: 14px;
          margin-top: 10px;
        "
      >
        No logs found for today. Please select another date from the calendar.
      </div>

      <table>
        <thead id="log-table-head" style="display: none">
          <tr>
            <th>{{ _('Status')}}</th>
            <th>{{ _('Log Description')}}</th>
            <th>{{ _('Timestamp')}}</th>
          </tr>
        </thead>
        <tbody id="log-table-body">
          <tr
            id="loading-message"
            style="display: none; text-align: center; font-size: 14px"
          >
            <td colspan="3">Loading logs...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<!-- JS -->
<script src="{{ url_for('static', filename='calendar/js/flatpickr.min.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const calendarInput = document.getElementById("log-date-picker");
  const calendarToggle = document.getElementById("calendar-toggle");

  const fp = flatpickr(calendarInput, {
    dateFormat: "Y-m-d",
    defaultDate: new Date(),
    clickOpens: false, // input'a tıklayınca açılmasın
    onOpen: () => calendarToggle.classList.add("open"),
    onClose: () => calendarToggle.classList.remove("open"),
    onChange: function (selectedDates, dateStr, instance) {
      calendarInput.value = dateStr;
      fetchLogsByDate();
    },
  });

  calendarToggle.addEventListener("click", function () {
    fp.open(); // sadece oka tıklanınca aç
  });
});

</script>

<script>

  let currentPage = 1;
  let isLoading = false;
  let hasMoreLogs = true;

  document.addEventListener("DOMContentLoaded", function () {
    fetchLogs();
  });

  document.addEventListener("DOMContentLoaded", function () {
    fetchLogs();

    const container = document.querySelector(".log-table-content");
    if (container) {
      container.addEventListener("scroll", function () {
        const scrollTop = container.scrollTop;
        const scrollHeight = container.scrollHeight;
        const containerHeight = container.clientHeight;

        if (scrollTop + containerHeight >= scrollHeight - 100) {
          console.log("SCROLL TETİKLENDİ (log-table-content)!");
          fetchLogs();
        }
      });
    } else {
      console.error("log-table-content bulunamadı!");
    }
  });

  function formatDateTime(dateTimeStr) {
    const date = new Date(dateTimeStr);
    if (isNaN(date)) return dateTimeStr;
    return `${date.getFullYear()}-${(date.getMonth() + 1)
      .toString()
      .padStart(2, "0")}-${date.getDate().toString().padStart(2, "0")} ${date
      .getHours()
      .toString()
      .padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}:${date
      .getSeconds()
      .toString()
      .padStart(2, "0")}`;
  }

  function fetchLogs() {
    if (isLoading || !hasMoreLogs) return;
    isLoading = true;

    document.getElementById("loading-message").style.display = "table-row";

    fetch("/get_logs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
        day: new Date().getDate(),
        page: currentPage,
        per_page: 20,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("loading-message").style.display = "none";
        isLoading = false;

        if (data.status === "success") {
          let logs = data.data;
          if (typeof logs === "string") {
            try {
              logs = JSON.parse(logs);
            } catch (error) {
              console.error("Error parsing logs JSON:", error);
              logs = [];
            }
          }

          if (Array.isArray(logs) && logs.length > 0) {
            updateTable(logs, true);
          }

          currentPage += 1;
          hasMoreLogs = data.has_more;
        }
        console.log(`Fetching page ${currentPage}, hasMore: ${hasMoreLogs}`);
      })
      .catch((error) => {
        isLoading = false;
        console.error("Error fetching logs:", error);
        document.getElementById("loading-message").style.display = "none";
      });
  }

  function updateTable(logs, append = false) {
    const tableBody = document.querySelector("#log-table-body");
    const tableHead = document.querySelector("#log-table-head");

    if (!append) tableBody.innerHTML = "";

    if (logs.length === 0 && !append) {
      tableHead.style.display = "none";
      return;
    }

    tableHead.style.display = "table-header-group";

    logs.forEach((log, index) => {
      const row = document.createElement("tr");
      const logId = `log-${Date.now()}-${Math.random()}`; // Benzersiz ID

      const fullText = log.tag + " - " + (log.data || "N/A");
      const fullTextEscaped = fullText.replace(/[&<>"']/g, function (match) {
        const chars = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        };
        return chars[match];
      });

      const statusClass = getStatusClass(log.type);
      const needsToggle = fullText.length > 100;

      row.innerHTML = `
        <td><span class="status-dot ${statusClass}"></span></td>
        <td>
          <span class="ellipsis" id="${logId}-short">${fullTextEscaped}</span>
          <span class="log-full" id="${logId}-full">${fullTextEscaped}</span>
          ${
            needsToggle
              ? `<a href="#" class="toggle-link" data-log-id="${logId}">Read More</a>`
              : ""
          }
        </td>
        <td style="white-space: nowrap;">${formatDateTime(log.created_at)}</td>
      `;

      tableBody.appendChild(row);
    });
  }

  document
    .querySelector("#log-table-body")
    .addEventListener("click", function (event) {
      if (event.target.classList.contains("toggle-link")) {
        event.preventDefault();
        const logId = event.target.getAttribute("data-log-id");
        toggleLog(logId, event.target);
      }
    });

  function toggleLog(logId, linkElement) {
    const shortText = document.getElementById(`${logId}-short`);
    const fullText = document.getElementById(`${logId}-full`);

    if (shortText.style.display === "none") {
      shortText.style.display = "inline-block";
      fullText.style.display = "none";
      linkElement.textContent = "Read More";
    } else {
      shortText.style.display = "none";
      fullText.style.display = "inline";
      linkElement.textContent = "Read Less";
    }
  }

  function getStatusClass(type) {
    switch (type) {
      case 1:
        return "status-info";
      case 2:
        return "status-warning";
      case 3:
        return "status-exception";
      default:
        return "status-info";
    }
  }

  function fetchLogsByDate() {
    let selectedDate = document.getElementById("log-date-picker").value;
    if (!selectedDate) {
      console.error("[ERROR] No date selected.");
      return;
    }

    let [year, month, day] = selectedDate.split("-").map(Number);
    console.log(
      `[DEBUG] Fetching logs for selected date: ${year}-${month}-${day}`
    );

    fetch("/get_logs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ year, month, day }),
    })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("info-message").style.display = "none";

        if (data.status === "success" && data.data) {
          let logs =
            typeof data.data === "string" ? JSON.parse(data.data) : data.data;
          if (Array.isArray(logs) && logs.length > 0) {
            document.getElementById("info-message").style.display = "block";
            updateTable(logs);
            document.getElementById("no-logs-message").style.display = "none";
          } else {
            document.getElementById("no-logs-message").style.display = "block";
          }
        } else {
          document.getElementById("no-logs-message").style.display = "block";
        }
      })
      .catch((error) => {
        console.error("[ERROR] Fetch error:", error);
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("no-logs-message").style.display = "block";
      });
  }

  function updateDateRangeDisplay(logs) {
    if (!logs || logs.length === 0) return;
  
    // Tarihleri al ve sırala
    const dates = logs.map(log => new Date(log.created_at)).sort((a, b) => a - b);
    const start = dates[0];
    const end = dates[dates.length - 1];
  
    const format = (date) =>
      date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: '2-digit',
      }).replace(/ /g, ' '); // "28 Dec 22"
  
    const rangeText = `${format(start)} – ${format(end)}`;
    document.getElementById("date-range-display").innerText = rangeText;
  }
  
</script>

<style>
  .log-table-content table {
    width: 100%;
    border-collapse: collapse;
  }

  .log-table-content th,
  .log-table-content td {
    border-bottom: 1px solid #ddd;
    padding: 10px;
    vertical-align: top;
  }

  .status-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
  }

  .status-info {
    background-color: green;
  }
  .status-warning {
    background-color: orange;
  }
  .status-exception {
    background-color: red;
  }

  .ellipsis {
    max-width: 300px;
    --webkit-line-clamp: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: inline-block;
    vertical-align: top;
  }

  .log-full {
    display: none;
    white-space: normal;
    word-break: break-word;
  }

  .toggle-link {
    color: #fe5f00;
    text-decoration: none;
    cursor: pointer;
  }

  .toggle-link:hover {
    text-decoration: underline;
  }

  .date-range-box {
    background-color: #1f2235;
    color: #ffffff;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    font-family: 'Arial', sans-serif;
    display: inline-block;
    margin-bottom: 10px;
  }
  
</style>
{% endblock %}
