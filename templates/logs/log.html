{% extends "layout.html" %} {% block title %} ORC Status - Error Log {% endblock
%} {% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/log.css') }}" />
{% endblock %} {% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="log-container">
  <div class="log-table">
    <div class="log-table-content">
      <div id="calendar-container">
        <input
          type="date"
          id="log-date-picker"
          onchange="fetchLogsByDate()"
          class="calendar-input"
        />
      </div>

      <!-- Message for navigating back in time İsterler ise aç -->
      <div
        id="info-message"
        style="
          display: none;
          color: green;
          text-align: center;
          font-size: 14px;
          margin-top: 5px;
        "
      >
      You can select a date from the calendar to view past logs.
      </div>

      <!-- No Logs message -->
      <div
        id="no-logs-message"
        style="
          display: none;
          color: red;
          text-align: center;
          font-size: 14px;
          margin-top: 10px;
        "
      >
      No logs found for today. Please select another date from the calendar.
      </div>

      <table>
        <thead id="log-table-head" style="display: none">
          <tr>
            <th>Status</th>
            <th>Log Description</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody id="log-table-body">
          <tr
            id="loading-message"
            style="display: none; text-align: center; font-size: 14px"
          >
            <td colspan="3">Loading logs...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetchLogs(); // Fetch logs for the current date initially
  });

  function fetchLogs() {
    document.getElementById("loading-message").style.display = "table-row";
    document.getElementById("no-logs-message").style.display = "none";
    document.getElementById("calendar-container").style.display = "none";
    document.getElementById("info-message").style.display = "none"; // Hide info message initially

    fetch("/get_logs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
        day: new Date().getDate(),
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("loading-message").style.display = "none";

        if (data.status === "success") {
          let logs = data.data;
          if (typeof logs === "string") {
            try {
              logs = JSON.parse(logs);
            } catch (error) {
              console.error("Error parsing logs JSON:", error);
              logs = [];
            }
          }

          if (Array.isArray(logs) && logs.length > 0) {
            document.getElementById("info-message").style.display = "block"; // Show info message when logs are fetched
            updateTable(logs);
            document.getElementById("no-logs-message").style.display = "none"; // Hide "no logs" message
          } else {
            document.getElementById("no-logs-message").style.display = "block"; // Show "no logs" message
          }
        } else {
          document.getElementById("no-logs-message").style.display = "block"; // Show "no logs" message
        }

        document.getElementById("calendar-container").style.display = "block"; // Show the calendar
      })
      .catch((error) => {
        console.error("Error fetching logs:", error);
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("no-logs-message").style.display = "block"; // Show "no logs" message
        document.getElementById("calendar-container").style.display = "block"; // Show the calendar
      });
  }

  function updateTable(logs) {
    const tableBody = document.querySelector("#log-table-body");
    const tableHead = document.querySelector("#log-table-head");

    tableBody.innerHTML = "";

    if (logs.length > 0) {
      tableHead.style.display = "table-header-group"; // Thead göster

      logs.forEach((log, index) => {
        const row = document.createElement("tr");
        let fullText = log.tag + " - " + (log.data || "N/A");
        let truncatedText =
          fullText.length > 100 ? fullText.substring(0, 100) + "..." : fullText;
        let statusClass = getStatusClass(log.type);
        let logId = `log-${index}`;

        row.innerHTML = `
                <td><span class="status-dot ${statusClass}"></span></td>
                <td style="max-width: 300px;">
                    <span id="${logId}-short">${truncatedText}</span>
                    <span id="${logId}-full" style="display: none;">${fullText}</span>
                    ${
                      fullText.length > 100
                        ? `<a href="#" onclick="toggleLog('${logId}'); return false;" id="${logId}-toggle" style="color: #fe5f00; text-decoration: none;">Read more</a>`
                        : ""
                    }
                </td>
                <td style="white-space: nowrap;">${log.created_at}</td>
            `;

        tableBody.appendChild(row);
      });
    } else {
      tableHead.style.display = "none"; // Thead gizle
    }
  }

  // Log açıklamalarını genişletme/daraltma fonksiyonu
  function toggleLog(logId) {
    let shortText = document.getElementById(`${logId}-short`);
    let fullText = document.getElementById(`${logId}-full`);
    let toggleLink = document.getElementById(`${logId}-toggle`);

    if (shortText.style.display === "none") {
      shortText.style.display = "inline";
      fullText.style.display = "none";
      toggleLink.textContent = "Read More";
    } else {
      shortText.style.display = "none";
      fullText.style.display = "inline";
      toggleLink.textContent = "Read Less";
    }
  }

  function getStatusClass(type) {
    switch (type) {
      case 1:
        return "status-info";
      case 2:
        return "status-warning";
      case 3:
        return "status-exception";
      default:
        return "status-info";
    }
  }

  function fetchLogsByDate() {
    let selectedDate = document.getElementById("log-date-picker").value;
    if (!selectedDate) {
      console.error("[ERROR] No date selected.");
      return;
    }

    let [year, month, day] = selectedDate.split("-").map(Number);
    console.log(
      `[DEBUG] Fetching logs for selected date: ${year}-${month}-${day}`
    );

    fetch("/get_logs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ year, month, day }),
    })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("info-message").style.display = "none"; // Hide info message initially

        if (data.status === "success" && data.data) {
          let logs =
            typeof data.data === "string" ? JSON.parse(data.data) : data.data;
          if (Array.isArray(logs) && logs.length > 0) {
            document.getElementById("info-message").style.display = "block"; // Show info message when logs are fetched
            updateTable(logs);
            document.getElementById("no-logs-message").style.display = "none"; // Hide "no logs" message
          } else {
            document.getElementById("no-logs-message").style.display = "block"; // Show "no logs" message
          }
        } else {
          document.getElementById("no-logs-message").style.display = "block"; // Show "no logs" message
        }
      })
      .catch((error) => {
        console.error("[ERROR] Fetch error:", error);
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("no-logs-message").style.display = "block"; // Show "no logs" message
      });
  }
</script>

{% endblock %}
