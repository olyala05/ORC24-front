{% extends "layout.html" %} {% block title %} ORC Status - Error Log {%
endblock%} {% block extra_css %}

<!-- CSS logs -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/log.css') }}" />

{% endblock %} {% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="log-container">
  <!--  Calendar -->
  <div class="calendar-input-wrapper">
    <input type="text" id="log-date-picker" class="calendar-input" />

    <div class="log-table">
      <div class="log-table-content">
        <!-- Message for navigating back in time İsterler ise aç -->
        <div
          id="info-message"
          style="
            display: none;
            color: #33FF00;
            text-align: center;
            font-size: 14px;
            margin-top: 5px;
          "
        ></div>

        <!-- No Logs message -->
        <div
          id="no-logs-message"
          style="
            display: none;
            color: #FF0F00;
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
          "
        >
          No logs found for today. Please select another date from the calendar.
        </div>

        <table>
          <thead id="log-table-head" style="display: none">
            <tr>
              <th>{{ _('Status')}}</th>
              <th>{{ _('Log Description')}}</th>
              <th>{{ _('Timestamp')}}</th>
            </tr>
          </thead>
          <tbody id="log-table-body">
            <tr
              id="loading-message"
              style="display: none; text-align: center; font-size: 14px"
            >
              <td colspan="3">Loading logs...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPage = 1;
  let isLoading = false;
  let hasMoreLogs = true;

  $("#log-date-picker").daterangepicker(
    {
      singleDatePicker: true,
      showDropdowns: false,
      showWeekNumbers: true,
      showISOWeekNumbers: true,
      timePicker: false,
      autoApply: true,
      maxSpan: { days: 7 },
      ranges: {
        Today: [moment(), moment()],
        Yesterday: [moment().subtract(1, "days"), moment().subtract(1, "days")],
        "Last Week": [
          moment().subtract(1, "week").startOf("isoWeek"),
          moment().subtract(1, "week").endOf("isoWeek"),
        ],
        "Last Month": [
          moment().subtract(1, "month").startOf("month"),
          moment().subtract(1, "month").endOf("month"),
        ],
        "Last Quarter": [
          moment().subtract(1, "quarter").startOf("quarter"),
          moment().subtract(1, "quarter").endOf("quarter"),
        ],
      },
      locale: {
        format: "DD MMM YYYY", // Tarih formatı
        monthNames: [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ],
        separator: " - ",
        fromLabel: "From",
        toLabel: "To",
        weekLabel: "W",
        firstDay: 1,
      },
      alwaysShowCalendars: true,
      startDate: moment().startOf("isoWeek").format("DD MMM YYYY"),
      endDate: moment().endOf("isoWeek").format("DD MMM YYYY"),
      opens: "center",
      buttonClasses: "btn btn-sm",
      applyButtonClasses: "btn btn-primary",
    },
    function (start, end, label) {
      const selectedDate = start.format("YYYY-MM-DD"); // Seçilen tarihi al
      console.log("Seçilen tarih: ", selectedDate);

      fetchLogsByDate(selectedDate); // Seçilen tarihe göre logları al
    }
  );

  document.addEventListener("DOMContentLoaded", function () {
    fetchLogs();

    setLogDateInput();

    const container = document.querySelector(".log-table-content");
    if (container) {
      container.addEventListener("scroll", function () {
        const scrollTop = container.scrollTop;
        const scrollHeight = container.scrollHeight;
        const containerHeight = container.clientHeight;

        if (scrollTop + containerHeight >= scrollHeight - 100) {
          console.log("SCROLL TETİKLENDİ (log-table-content)!");
          fetchLogs();
        }
      });
    } else {
      console.error("log-table-content bulunamadı!");
    }
  });

  function setLogDateInput() {
    fetch("/get_logs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
        day: new Date().getDate(),
        page: 1,
        per_page: 1,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success" && data.data.length > 0) {
          const lastLogDate = new Date(data.data[0].created_at);
          const formattedDate = formatDateInput(lastLogDate);

          // Takvimi son log tarihine göre güncelle
          document.getElementById("log-date-picker").value = formattedDate;

          // Seçilen tarih ile logları getir
          fetchLogsByDate(formattedDate);
        }
      })
      .catch((error) => console.error("Error fetching last log date:", error));
  }

  function formatDateInput(date) {
    return `${date.getFullYear()}-${(date.getMonth() + 1)
      .toString()
      .padStart(2, "0")}-${date.getDate().toString().padStart(2, "0")}`;
  }

  function formatDateInput(date) {
    return `${date.getFullYear()}-${(date.getMonth() + 1)
      .toString()
      .padStart(2, "0")}-${date.getDate().toString().padStart(2, "0")}`;
  }

  function formatDateTime(dateTimeStr) {
    const date = new Date(dateTimeStr);
    if (isNaN(date)) return dateTimeStr;
    return `${date.getFullYear()}-${(date.getMonth() + 1)
      .toString()
      .padStart(2, "0")}-${date.getDate().toString().padStart(2, "0")} ${date
      .getHours()
      .toString()
      .padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}:${date
      .getSeconds()
      .toString()
      .padStart(2, "0")}`;
  }

  function fetchLogs() {
    if (isLoading || !hasMoreLogs) return;
    isLoading = true;

    document.getElementById("loading-message").style.display = "table-row";

    fetch("/get_logs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
        day: new Date().getDate(),
        page: currentPage,
        per_page: 20,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("loading-message").style.display = "none";
        isLoading = false;

        if (data.status === "success") {
          let logs = data.data;
          if (typeof logs === "string") {
            try {
              logs = JSON.parse(logs);
            } catch (error) {
              console.error("Error parsing logs JSON:", error);
              logs = [];
            }
          }

          if (Array.isArray(logs) && logs.length > 0) {
            updateTable(logs, true);
          }

          currentPage += 1;
          hasMoreLogs = data.has_more;
        }
        console.log(`Fetching page ${currentPage}, hasMore: ${hasMoreLogs}`);
      })
      .catch((error) => {
        isLoading = false;
        console.error("Error fetching logs:", error);
        document.getElementById("loading-message").style.display = "none";
      });
  }

  function updateTable(logs, append = false) {
    const tableBody = document.querySelector("#log-table-body");
    const tableHead = document.querySelector("#log-table-head");

    if (!append) tableBody.innerHTML = "";

    if (logs.length === 0 && !append) {
      tableHead.style.display = "none";
      return;
    }

    tableHead.style.display = "table-header-group";

    logs.forEach((log, index) => {
      const row = document.createElement("tr");
      const logId = `log-${Date.now()}-${Math.random()}`;

      const fullText = log.tag + " - " + (log.data || "N/A");
      const fullTextEscaped = fullText.replace(/[&<>"']/g, function (match) {
        const chars = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        };
        return chars[match];
      });

      const statusClass = getStatusClass(log.type);
      const needsToggle = fullText.length > 100;

      row.innerHTML = `
      <td><span class="status-dot ${statusClass}"></span></td>
      <td>
        <span class="ellipsis" id="${logId}-short">${fullTextEscaped}</span>
        <span class="log-full" id="${logId}-full">${fullTextEscaped}</span>
        ${
          needsToggle
            ? `<a href="#" class="toggle-link" data-log-id="${logId}">Read More</a>`
            : ""
        }
      </td>
      <td style="white-space: nowrap;">${formatDateTime(log.created_at)}</td>
    `;

      tableBody.appendChild(row);
    });
  }

  document
    .querySelector("#log-table-body")
    .addEventListener("click", function (event) {
      if (event.target.classList.contains("toggle-link")) {
        event.preventDefault();
        const logId = event.target.getAttribute("data-log-id");
        toggleLog(logId, event.target);
      }
    });

  function toggleLog(logId, linkElement) {
    const shortText = document.getElementById(`${logId}-short`);
    const fullText = document.getElementById(`${logId}-full`);

    if (shortText.style.display === "none") {
      shortText.style.display = "inline-block";
      fullText.style.display = "none";
      linkElement.textContent = "Read More";
    } else {
      shortText.style.display = "none";
      fullText.style.display = "inline";
      linkElement.textContent = "Read Less";
    }
  }

  function getStatusClass(type) {
    switch (type) {
      case 1:
        return "status-info";
      case 2:
        return "status-warning";
      case 3:
        return "status-exception";
      default:
        return "status-info";
    }
  }

  function fetchLogsByDate(selectedDate) {
    fetch("/get_logs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        year: selectedDate.split("-")[0],
        month: selectedDate.split("-")[1],
        day: selectedDate.split("-")[2],
        page: 1,
        per_page: 20,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("info-message").style.display = "none";

        if (data.status === "success" && data.data) {
          let logs =
            typeof data.data === "string" ? JSON.parse(data.data) : data.data;
          if (Array.isArray(logs) && logs.length > 0) {
            document.getElementById("info-message").style.display = "block";
            updateTable(logs);
            document.getElementById("no-logs-message").style.display = "none";
          } else {
            document.getElementById("no-logs-message").style.display = "block";
          }
        } else {
          document.getElementById("no-logs-message").style.display = "block";
        }
      })
      .catch((error) => {
        console.error("[ERROR] Fetch error:", error);
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("no-logs-message").style.display = "block";
      });
  }

  function updateDateRangeDisplay(logs) {
    if (!logs || logs.length === 0) return;

    // Tarihleri al ve sırala
    const dates = logs
      .map((log) => new Date(log.created_at))
      .sort((a, b) => a - b);
    const start = dates[0];
    const end = dates[dates.length - 1];

    const format = (date) =>
      date
        .toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "short",
          year: "2-digit",
        })
        .replace(/ /g, " "); // "28 Dec 22"

    const rangeText = `${format(start)} – ${format(end)}`;
    document.getElementById("date-range-display").innerText = rangeText;
  }
</script>

{% endblock %}
