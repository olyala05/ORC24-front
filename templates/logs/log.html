{% extends "layout.html" %} 
{% block title %} ORC Status - Error Log {% endblock%} 

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/log.css') }}" />

{% endblock %} {% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="log-container">
  <div class="log-table">
    <div class="log-table-content">
      <table>
        <thead>
          <tr>
            <th>Status</th>
            <th>Log Description</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody id="log-table-body">
          <tr
            id="loading-message"
            style="display: none; text-align: center; font-size: 14px"
          >
            <td colspan="3">Loading logs...</td>
          </tr>
        </tbody>
      </table>

      <!-- No Logs message -->
      <div
        id="no-logs-message"
        style="
          display: none;
          color: red;
          text-align: center;
          font-size: 14px;
          margin-top: 10px;
        "
      >
        Bu güne ait loglar bulunamadı. Lütfen aşağıdaki takvimden başka bir
        tarih seçin.
      </div>

      <!-- Calendar Selector -->
      <div
        id="calendar-container"
        style="display: block; text-align: center; margin-top: 15px"
      >
        <input type="date" id="log-date-picker" onchange="fetchLogsByDate()" />
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetchLogs();
  });

  function fetchLogs() {
    document.getElementById("loading-message").style.display = "table-row";
    document.getElementById("no-logs-message").style.display = "none";
    document.getElementById("calendar-container").style.display = "none";

    let today = new Date();
    let year = today.getFullYear();
    let month = String(today.getMonth() + 1).padStart(2, "0"); // Ay formatı düzeltildi
    let day = String(today.getDate()).padStart(2, "0");

    let postData = { year, month, day };

    console.log("[DEBUG] Sending request with data:", postData);

    fetch("/get_logs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(postData),
    })
    .then(response => response.json())
    .then(data => {
        console.log("[DEBUG] Response received:", data);
        document.getElementById("loading-message").style.display = "none";

        if (data.status === "success") {
            let logs = data.data;

            console.log("[DEBUG] Logs received:", logs);

            if (typeof logs === "string") {
                try {
                    logs = JSON.parse(logs);
                    console.log("[DEBUG] Parsed logs:", logs);
                } catch (error) {
                    console.error("[DEBUG] JSON parse error:", error);
                    logs = [];
                }
            }

            if (Array.isArray(logs) && logs.length > 0) {
                updateTable(logs);
            } else {
                console.log("[DEBUG] No logs found.");
                document.getElementById("no-logs-message").style.display = "block";
                document.getElementById("calendar-container").style.display = "block";
            }
        } else {
            console.log("[DEBUG] API returned an error:", data);
            document.getElementById("no-logs-message").style.display = "block";
            document.getElementById("calendar-container").style.display = "block";
        }
    })
    .catch(error => {
        console.error("[DEBUG] Fetch error:", error);
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("no-logs-message").style.display = "block";
        document.getElementById("calendar-container").style.display = "block";
    });
}

function updateTable(logs) {
    console.log("[DEBUG] Updating table with logs:", logs);

    if (!Array.isArray(logs) || logs.length === 0) {
        console.error("Logs is not an array or is empty:", logs);
        document.getElementById("no-logs-message").style.display = "block";
        return;
    }

    const tableBody = document.querySelector("#log-table-body");
    tableBody.innerHTML = "";

    logs.forEach((log, index) => {
        const row = document.createElement("tr");

        let shortText = log.tag + " - " + (log.data || "N/A");
        let fullText = JSON.stringify(log.data, null, 2);
        let displayText = shortText.length > 100 ? shortText.substring(0, 100) + "..." : shortText;
        let expandText = shortText.length > 100 ? `<span class='expand' onclick='toggleExpand(this, ${index})'>Devamını Oku</span>` : "";

        let statusClass = getStatusClass(log.type);

        row.innerHTML = `
            <td><span class="status-dot ${statusClass}"></span></td>
            <td class="truncate" style="max-width: 300px;">
                <span id="short-${index}">${displayText}</span>
                <span id="full-${index}" style="display:none;">${fullText}</span>
                ${expandText}
            </td>
            <td style="white-space: nowrap;">${log.created_at}</td>
        `;

        tableBody.appendChild(row);
    });
}

function getStatusClass(type) {
    switch (type) {
        case 1:
            return "status-info";
        case 2:
            return "status-warning"; 
        case 3:
            return "status-exception"; 
        default:
            return "status-info";
    }
}

function toggleExpand(element, index) {
    let shortText = document.getElementById(`short-${index}`);
    let fullText = document.getElementById(`full-${index}`);

    if (shortText.style.display === "none") {
        shortText.style.display = "inline";
        fullText.style.display = "none";
        element.textContent = "Devamını Oku";
    } else {
        shortText.style.display = "none";
        fullText.style.display = "inline";
        element.textContent = "Kısalt";
    }
}



  function getStatusClass(type) {
    switch (type) {
      case 1:
        return "status-info";
      case 2:
        return "status-warning"; 
      case 3:
        return "status-exception"; 
      default:
        return "status-info";
    }
  }

  function toggleExpand(element) {
    let cell = element.parentElement;
    let fullText = cell.getAttribute("data-full-text");
    if (!fullText) {
      fullText = cell.textContent.replace("Devamını Oku", "");
      cell.setAttribute("data-full-text", fullText);
    }
    if (element.textContent === "Devamını Oku") {
      cell.innerHTML =
        fullText +
        " <span class='expand' onclick='toggleExpand(this)'>Kısalt</span>";
    } else {
      cell.innerHTML =
        fullText.substring(0, 500) +
        "... <span class='expand' onclick='toggleExpand(this)'>Devamını Oku</span>";
    }
  }

  function fetchLogsByDate() {
    let selectedDate = document.getElementById("log-date-picker").value;
    
    if (!selectedDate) {
        console.error("No date selected.");
        return;
    }

    let [year, month, day] = selectedDate.split("-").map(Number);

    console.log(`Fetching logs for selected date: ${year}-${month}-${day}`);

    fetch("/get_logs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ year, month, day }),
    })
    .then((response) => response.json())
    .then((data) => {
        console.log("Fetched logs:", data);
        document.getElementById("loading-message").style.display = "none";

        if (data.status === "success" && data.data.length > 0) {
            updateTable(data.data);
        } else {
            document.getElementById("no-logs-message").style.display = "block";
            document.getElementById("calendar-container").style.display = "block";
        }
    })
    .catch((error) => {
        console.error("Error fetching logs:", error);
        document.getElementById("loading-message").style.display = "none";
        document.getElementById("no-logs-message").style.display = "block";
        document.getElementById("calendar-container").style.display = "block";
    });
}

</script>

{% endblock %}
