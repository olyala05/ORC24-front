{% extends "layout.html" %} {% block title %} {{ _('ORC Status - Logs') }} {%
endblock%} {% block extra_css %}

<!-- CSS logs -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/log.css') }}" />

{% endblock %} {% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="log-container">
  <!--  Calendar -->
  <div class="calendar-input-wrapper">
    <!--<input type="text" id="log-date-picker" class="calendar-input" readonly/> -->
    <div class="calendar-wrapper">
      <input type="text" id="log-date-picker" class="calendar-input" readonly />
      <span
        class="calendar-icon"
        data-up="{{ url_for('static', filename='images/svg/up-arrow.svg') }}"
        data-down="{{ url_for('static', filename='images/svg/down-arrow-white.svg') }}"
      >
        <img
          id="calendar-arrow-icon"
          src="{{ url_for('static', filename='images/svg/down-arrow-white.svg') }}"
          alt="arrow"
        />
      </span>
    </div>

    <div class="log-table">
      <div class="log-table-content">
        <!-- Message for navigating back in time İsterler ise aç -->
        <div
          id="info-message"
          style="
            display: none;
            color: #33ff00;
            text-align: center;
            font-size: 14px;
            margin-top: 5px;
          "
        ></div>

        <!-- No Logs message -->
        <div
          id="no-logs-message"
          style="
            display: none;
            color: #ff0f00;
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
          "
        >
          {{ _('No logs found for the selected date.') }}
        </div>

        <table>
          <thead id="log-table-head" style="display: none">
            <tr>
              <th>{{ _('Status')}}</th>
              <th>{{ _('Log Description')}}</th>
              <th>{{ _('Timestamp')}}</th>
            </tr>
          </thead>
          <tbody id="log-table-body">
            <tr
              id="loading-message"
              style="display: none; text-align: center; font-size: 14px"
            >
              <td colspan="3">{{ _('Loading logs...') }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script> 
// Global State
let currentPage = 1;
let isLoading = false;
let hasMoreLogs = true;
let isCalendarOpen = false;
let selectedLogDate = null;

// DOM Elements
const datePicker = $("#log-date-picker");
const calendarIcon = document.getElementById("calendar-arrow-icon");
const calendarIconWrapper = document.querySelector(".calendar-icon");
const logTableBody = document.getElementById("log-table-body");
const logTableHead = document.getElementById("log-table-head");
const loadingMessage = document.getElementById("loading-message");
const noLogsMessage = document.getElementById("no-logs-message");

const upArrowUrl = calendarIconWrapper.dataset.up;
const downArrowUrl = calendarIconWrapper.dataset.down;

// Locale Config
const activeLang = "{{ get_locale() }}";
moment.locale(activeLang);

const calendarLocales = {
  tr: {
    format: "DD MMM YYYY",
    separator: " - ",
    fromLabel: "Başlangıç",
    toLabel: "Bitiş",
    weekLabel: "H",
    firstDay: 1,
    monthNames: [
      "Oca",
      "Şub",
      "Mar",
      "Nis",
      "May",
      "Haz",
      "Tem",
      "Ağu",
      "Eyl",
      "Eki",
      "Kas",
      "Ara",
    ],
    daysOfWeek: ["Paz", "Pzt", "Sal", "Çar", "Per", "Cum", "Cmt"],
  },
  en: {
    format: "DD MMM YYYY",
    separator: " - ",
    fromLabel: "From",
    toLabel: "To",
    weekLabel: "W",
    firstDay: 1,
    monthNames: [
      "Jan",
      "Feb",
      "Mar",
      "Apr",
      "May",
      "Jun",
      "Jul",
      "Aug",
      "Sep",
      "Oct",
      "Nov",
      "Dec",
    ],
    daysOfWeek: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
  },
  de: {
    format: "DD MMM YYYY",
    separator: " - ",
    fromLabel: "Von",
    toLabel: "Bis",
    weekLabel: "W",
    firstDay: 1,
    monthNames: [
      "Jan",
      "Feb",
      "Mär",
      "Apr",
      "Mai",
      "Jun",
      "Jul",
      "Aug",
      "Sep",
      "Okt",
      "Nov",
      "Dez",
    ],
    daysOfWeek: ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"],
  },
};

const predefinedRangesByLang = {
  tr: {
    Bugün: [moment(), moment()],
    Dün: [moment().subtract(1, "days"), moment().subtract(1, "days")],
    "Geçen Hafta": [
      moment().subtract(1, "week").startOf("isoWeek"),
      moment().subtract(1, "week").endOf("isoWeek"),
    ],
    "Geçen Ay": [
      moment().subtract(1, "month").startOf("month"),
      moment().subtract(1, "month").endOf("month"),
    ],
    "Son Üç Ay": [
      moment().subtract(1, "quarter").startOf("quarter"),
      moment().subtract(1, "quarter").endOf("quarter"),
    ],
  },
  en: {
    Today: [moment(), moment()],
    Yesterday: [moment().subtract(1, "days"), moment().subtract(1, "days")],
    "Last Week": [
      moment().subtract(1, "week").startOf("isoWeek"),
      moment().subtract(1, "week").endOf("isoWeek"),
    ],
    "Last Month": [
      moment().subtract(1, "month").startOf("month"),
      moment().subtract(1, "month").endOf("month"),
    ],
    "Last Quarter": [
      moment().subtract(1, "quarter").startOf("quarter"),
      moment().subtract(1, "quarter").endOf("quarter"),
    ],
  },
  de: {
    Heute: [moment(), moment()],
    Gestern: [moment().subtract(1, "days"), moment().subtract(1, "days")],
    "Letzte Woche": [
      moment().subtract(1, "week").startOf("isoWeek"),
      moment().subtract(1, "week").endOf("isoWeek"),
    ],
    "Letzter Monat": [
      moment().subtract(1, "month").startOf("month"),
      moment().subtract(1, "month").endOf("month"),
    ],
    "Letztes Quartal": [
      moment().subtract(1, "quarter").startOf("quarter"),
      moment().subtract(1, "quarter").endOf("quarter"),
    ],
  },
};

const selectedLocale = calendarLocales[activeLang] || calendarLocales["en"];
selectedLocale.customRangeLabel = "";

const predefinedRanges =
  predefinedRangesByLang[activeLang] || predefinedRangesByLang["en"];

// Datepicker Init
datePicker.daterangepicker({
  singleDatePicker: true,
  showDropdowns: false,
  showWeekNumbers: true,
  showISOWeekNumbers: true,
  timePicker: false,
  autoApply: true,
  maxSpan: { days: 7 },
  alwaysShowCalendars: true,
  startDate: moment(),
  endDate: moment(),
  opens: "center",
  buttonClasses: "btn btn-sm",
  applyButtonClasses: "btn btn-primary",
  ranges: predefinedRanges,
  locale: selectedLocale
}, (start) => fetchLogsByDate(start.format("YYYY-MM-DD")));

const picker = datePicker.data("daterangepicker");
datePicker.on("click", e => {
  e.stopPropagation();
  isCalendarOpen ? picker.hide() : picker.show();
  isCalendarOpen = !isCalendarOpen;
});

$(document).on("click", e => {
  if (isCalendarOpen && !$(e.target).closest(".daterangepicker").length) {
    picker.hide();
    isCalendarOpen = false;
  }
});

datePicker.on("show.daterangepicker", () => calendarIcon.src = upArrowUrl);
datePicker.on("hide.daterangepicker", () => calendarIcon.src = downArrowUrl);

document.addEventListener("DOMContentLoaded", () => {
  fetchLogs();
  setLogDateInput();

  document.querySelector(".log-table-content")?.addEventListener("scroll", ({ target }) => {
    if (target.scrollTop + target.clientHeight >= target.scrollHeight - 100) fetchLogs();
  });
});

function fetchLogs() {
  if (isLoading || !hasMoreLogs) return;
  isLoading = true;
  loadingMessage.style.display = "table-row";

  const date = selectedLogDate || moment().format("YYYY-MM-DD");
  const [year, month, day] = date.split("-");

  fetch("/get_logs", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ year, month, day, page: currentPage, per_page: 20 })
  })
    .then(res => res.json())
    .then(data => handleLogResponse(data, true))
    .catch(error => handleLogError(error));
}

function fetchLogsByDate(date) {
  selectedLogDate = date;
  currentPage = 1;
  hasMoreLogs = true;

  const [year, month, day] = date.split("-");
  showLoading("{{ _('Loading logs, please wait...') }}");

  fetch("/get_logs", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ year, month, day, page: 1, per_page: 20 })
  })
    .then(res => res.json())
    .then(data => handleLogResponse(data))
    .catch(error => handleLogError(error))
    .finally(() => hideLoading());
}

function setLogDateInput() {
  const now = new Date();
  fetch("/get_logs", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      year: now.getFullYear(),
      month: now.getMonth() + 1,
      day: now.getDate(),
      page: 1,
      per_page: 1
    })
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success" && data.data.length) {
        const formattedDate = moment(data.data[0].created_at).format("YYYY-MM-DD");
        datePicker.val(formattedDate);
        fetchLogsByDate(formattedDate);
      }
    })
    .catch(console.error);
}

function handleLogResponse(data, append = false) {
  loadingMessage.style.display = "none";
  isLoading = false;

  const logs = Array.isArray(data.data) ? data.data : JSON.parse(data.data || "[]");

  if (data.status === "success" && logs.length) {
    updateTable(logs, append);
    currentPage++;
    hasMoreLogs = data.has_more;
    logTableHead.style.display = "table-header-group";
    noLogsMessage.style.display = "none";
  } else if (!append || currentPage === 1) {
    clearLogs();
  }
}

function handleLogError(error) {
  console.error("Log fetch error:", error);
  isLoading = false;
  loadingMessage.style.display = "none";
  if (currentPage === 1) clearLogs();
}

function clearLogs() {
  logTableBody.innerHTML = "";
  logTableHead.style.display = "none";
  noLogsMessage.style.display = "block";
}

// Statik Dil Çevirme
let tagTranslations = {};
let dataTranslations = {};

// TAG Çevirilerini Yükle
fetch("static/log-trans/tag.json")
  .then((res) => res.json())
  .then((data) => {
    tagTranslations = data;
  })
  .catch((err) => {
    console.error("Tag translation file could not be loaded:", err);
  });

// DATA Çevirilerini Yükle
fetch("static/log-trans/data.json")
  .then((res) => res.json())
  .then((data) => {
    dataTranslations = data;
  })
  .catch((err) => {
    console.error("Data translation file could not be loaded:", err);
  });

function updateTable(logs, append = false) {
  if (!append) logTableBody.innerHTML = "";
  logTableHead.style.display = "table-header-group";

  logs.forEach((log) => {
    const row = document.createElement("tr");
    const logId = `log-${Date.now()}-${Math.random()}`;

    // TAG çevirisi
    const rawTag = log.tag;
    const translatedTag = tagTranslations[rawTag]?.[activeLang] || rawTag;

    // DATA çevirisi
    const rawData = log.data || "N/A";
    const translatedData = dataTranslations[rawData]?.[activeLang] || rawData;

    const text = (translatedTag + " - " + translatedData).replace(
      /[&<>"']/g,
      (c) =>
      ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[c])
    );

    const statusClass = getStatusClass(log.type);
    const needsToggle = text.length > 100;

    row.innerHTML = `
                <td><span class="status-dot ${statusClass}"></span></td>
                <td>
                  <span class="ellipsis" id="${logId}-short">${text}</span>
                  <span class="log-full" id="${logId}-full" style="display:none">${text}</span>
                  ${needsToggle
        ? `<a href="#" class="toggle-link" data-log-id="${logId}">{{ _('Read More') }}</a>`
        : ""
      }
                </td>
                <td style="white-space: nowrap;">${formatDateTime(
        log.created_at
      )}</td>
            `;
    logTableBody.appendChild(row);
  });
}


logTableBody.addEventListener("click", e => {
  if (e.target.classList.contains("toggle-link")) {
    e.preventDefault();
    toggleLog(e.target.dataset.logId, e.target);
  }
});

function toggleLog(id, link) {
  const shortEl = document.getElementById(`${id}-short`);
  const fullEl = document.getElementById(`${id}-full`);
  const isHidden = shortEl.style.display === "none";

  shortEl.style.display = isHidden ? "inline-block" : "none";
  fullEl.style.display = isHidden ? "none" : "inline";

  link.textContent = isHidden ? "{{ _('Read More') }}" : "{{ _('Read Less') }}";
}

function formatDateTime(str) {
  const date = new Date(str);
  return isNaN(date) ? str : `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")} ${String(date.getHours()).padStart(2, "0")}:${String(date.getMinutes()).padStart(2, "0")}:${String(date.getSeconds()).padStart(2, "0")}`;
}

function getStatusClass(type) {
  return {
    1: "status-info",
    2: "status-warning",
    3: "status-exception"
  }[type] || "status-info";
} 
</script>

<style>
  .calendar-wrapper {
    position: relative;
    display: inline-block;
    width: fit-content;
  }

  .calendar-input {
    padding-right: 25px;
    height: 36px;
    border: none;
    border-radius: 6px;
    background-color: #0b1734;
    color: #fff;
    font-size: 14px;
    padding: 0 10px;
  }

  .calendar-icon {
    position: absolute;
    right: 23px;
    top: 58%;
    transform: translateY(-50%);
    pointer-events: none;
  }

  .calendar-icon img {
    width: 15px;
    height: 15px;
  }
  .daterangepicker .ranges li.active {
    background-color: #ef8018;
    color: #fff;
  }
  .daterangepicker td.active,
  .daterangepicker td.active:hover {
    background-color: #ef8018;
    border-color: transparent;
    color: #fff;
  }
</style>
{% endblock %}
