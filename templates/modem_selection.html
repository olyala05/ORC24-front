{% extends "layout.html" %} {% block title %} Modem Selection {% endblock %} {%
block content %}

<div class="header">
  <div class="header-left">
    <!-- Home Butonu -->
    <button class="header-button" onclick="goToDashboard()">
      Home
      <img
        src="{{ url_for('static', filename='images/svg/19.svg') }}"
        alt="Logout"
        width="20"
        height="20"
        style="padding: 7px 7px; background: #0b1734; border-radius: 5px"
      />
    </button>

    <!-- Alarm Butonu -->
    <button class="alarm-button" onclick="goToAlarm()" title="Alarm">
      <div class="alarm-icon-container">
        <img
          src="{{ url_for('static', filename='images/svg/31.svg') }}"
          alt="Alarm"
          width="35"
          height="35"
        />
        <span id="alarm-count" class="alarm-badge" style="display: none"
          >0</span
        >
      </div>
    </button>
  </div>

  <div class="header-logo">
    <img
      src="{{ url_for('static', filename='images/logos/logo-01.webp') }}"
      alt="Pier MTTP Logo"
      class="logo"
    />
  </div>

  <div class="header-right">
    <div class="date-time" id="currentDateTime"></div>
    <div class="report-line">
      <div class="line"></div>
    </div>
    <div class="report-date">Modem Selection</div>
  </div>
</div>

<!-- Sayfa Ä°Ã§eriÄŸi -->
<main class="content">
  <div class="modem-selection">
    <div class="dropdown-container">
      <label for="modem">Select Modem or Device:</label>
      <select id="modem" class="modem-dropdown" onchange="connectDevice()">
        <option value="" disabled selected>Loading devices...</option>
      </select>
    </div>

    <div class="button-container">
      <button class="btn" onclick="goToORCStatus()">ORC Status</button>
      <button class="btn" onclick="goToEquipment()">Equipment</button>
      <button class="btn" onclick="goToSetting()">Settings</button>
    </div>

    <div class="bottom-buttons">
      <button class="btn" onclick="SwitchtTest()">Test</button>
      <button class="btn" onclick="goToData()">Data</button>
    </div>

    <div id="status"></div>
  </div>
</main>

<script>
  // Sayfa yÃ¼klendiÄŸinde cihazlarÄ± getir
  document.addEventListener("DOMContentLoaded", fetchDevices);

  // Dashboard SayfasÄ±na YÃ¶nlendirir
  function goToDashboard() {
    window.location.href = "/dashboard";
  }

  // Active butonu seÃ§me
  document.addEventListener("DOMContentLoaded", function () {
    // TÃ¼m butonlarÄ± seÃ§
    let buttons = document.querySelectorAll(
      ".button-container .btn, .bottom-buttons .btn"
    );

    buttons.forEach((button) => {
      button.addEventListener("click", function () {
        // Ã–nce tÃ¼m butonlardan `active` sÄ±nÄ±fÄ±nÄ± kaldÄ±r
        buttons.forEach((btn) => btn.classList.remove("active"));

        // TÄ±klanan butona `active` sÄ±nÄ±fÄ±nÄ± ekle
        this.classList.add("active");
      });
    });
  });

  function fetchDevices() {
    fetch("/devices")
      .then((response) => response.json())
      .then((data) => {
        let dropdown = document.getElementById("modem");
        dropdown.innerHTML = "";

        let defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.textContent = "Select Modem or Device";
        dropdown.appendChild(defaultOption);

        data.forEach((device) => {
          let option = document.createElement("option");
          option.value = device.ip;
          option.textContent = `${device.ip} (${device.mac})`;
          dropdown.appendChild(option);
        });
      })
      .catch((error) => console.error("CihazlarÄ± alÄ±rken hata:", error));
  }

  // ORC Status
  function goToORCStatus() {
    let dropdown = document.getElementById("modem");
    let selectedDeviceIP = dropdown ? dropdown.value : null;

    if (!selectedDeviceIP) {
      Swal.fire({
        icon: "warning",
        title: "UyarÄ±",
        text: "LÃ¼tfen Ã¶nce bir cihaz seÃ§iniz!",
        confirmButtonText: "Tamam",
      });
      return;
    }

    let loadingOverlay = document.createElement("div");
    loadingOverlay.id = "loading-overlay";
    loadingOverlay.className = "loading-overlay";
    loadingOverlay.innerHTML = `
        <div class="loading-box">
          <p> ORC Status yÃ¼kleniyor...</p>
          <div class="loader"></div>
        </div>`;
    document.body.appendChild(loadingOverlay);

    window.location.href = `/orc-status?ip_address=${selectedDeviceIP}`;

    window.addEventListener("pageshow", function () {
      let loader = document.getElementById("loading-overlay");
      if (loader) loader.remove();
    });
  }

  // Equipment With Model
  function goToEquipment() {
    let dropdown = document.getElementById("modem");
    let selectedDeviceIP = dropdown ? dropdown.value : null;

    if (!selectedDeviceIP) {
      Swal.fire({
        icon: "warning",
        title: "UyarÄ±",
        text: "LÃ¼tfen Ã¶nce bir cihaz seÃ§iniz!",
        confirmButtonText: "Tamam",
      });
      return;
    }

    // **Loading ekranÄ±nÄ± ekleyelim**
    let loadingOverlay = document.createElement("div");
    loadingOverlay.id = "loading-overlay";
    loadingOverlay.className = "loading-overlay";
    loadingOverlay.innerHTML = `
        <div class="loading-box">
          <p> Equipments yÃ¼kleniyor...</p>
          <div class="loader"></div>
        </div>`;
    document.body.appendChild(loadingOverlay);

    console.log("ðŸ“¡ `fetch` baÅŸlatÄ±lÄ±yor: /equipments-with-models");

    fetch("/equipments-with-models", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ip_address: selectedDeviceIP }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Equipment Response:", data);

        if (!data || data.error) {
          console.warn("Backend HatasÄ±:", data.error);
          Swal.fire({
            icon: "error",
            title: "Hata!",
            text: data.error || "Ekipman verisi alÄ±namadÄ±.",
            confirmButtonText: "Tamam",
          });
          return;
        }

        // **SessionStorage iÃ§ine kaydet**
        sessionStorage.setItem("equipment_data", JSON.stringify(data.data));

        // **Yeni sayfaya yÃ¶nlendir**
        window.location.href = "/equipment";
      })
      .catch((error) => {
        console.error("Ekipman verisi alÄ±rken hata oluÅŸtu:", error);
        Swal.fire({
          icon: "error",
          title: "Hata!",
          text: "Equipment verisi alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.",
          confirmButtonText: "Tamam",
        });
      })
      .finally(() => {
        let loader = document.getElementById("loading-overlay");
        if (loader) loader.remove();
      });
  }

  // Setting
  function goToSetting() {
    let dropdown = document.getElementById("modem");
    let selectedDeviceIP = dropdown ? dropdown.value : null;

    if (!selectedDeviceIP) {
      // KullanÄ±cÄ±ya uyarÄ± ver
      Swal.fire({
        icon: "warning",
        title: "UyarÄ±",
        text: "LÃ¼tfen Ã¶nce bir cihaz seÃ§iniz!",
        confirmButtonText: "Tamam",
      });
      return; // Ä°ÅŸlemi durdur
    }

    // **Loading ekranÄ±nÄ± ekleyelim**
    let loadingOverlay = document.createElement("div");
    loadingOverlay.id = "loading-overlay";
    loadingOverlay.className = "loading-overlay";
    loadingOverlay.innerHTML = `
          <div class="loading-box">
            <p> Settings yÃ¼kleniyor...</p>
            <div class="loader"></div>
          </div>`;
    document.body.appendChild(loadingOverlay);

    window.location.href = "/settings";
  }

  // Test SayfasÄ±na YÃ¶nlendirir
  function SwitchtTest() {
    let dropdown = document.getElementById("modem");
    let selectedDeviceIP = dropdown ? dropdown.value : null; // SeÃ§ili cihazÄ±n IP'sini al

    if (!selectedDeviceIP) {
      // KullanÄ±cÄ±ya uyarÄ± ver
      Swal.fire({
        icon: "warning",
        title: "UyarÄ±",
        text: "LÃ¼tfen Ã¶nce bir cihaz seÃ§iniz!",
        confirmButtonText: "Tamam",
      });
      return;
    }

    // **Loading ekranÄ±nÄ± ekleyelim**
    let loadingOverlay = document.createElement("div");
    loadingOverlay.id = "loading-overlay";
    loadingOverlay.className = "loading-overlay";
    loadingOverlay.innerHTML = `
        <div class="loading-box">
          <p> Test yÃ¼kleniyor...</p>
          <div class="loader"></div>
        </div>`;
    document.body.appendChild(loadingOverlay); // **Sayfaya ekle**

    setTimeout(() => {
      window.location.href = "/switch";
    }, 100);
  }

  // data
  function goToData() {
    let dropdown = document.getElementById("modem");
    let selectedDeviceIP = dropdown ? dropdown.value : null; // SeÃ§ili cihazÄ±n IP'sini al

    if (!selectedDeviceIP) {
      // KullanÄ±cÄ±ya uyarÄ± ver
      Swal.fire({
        icon: "warning",
        title: "UyarÄ±",
        text: "LÃ¼tfen Ã¶nce bir cihaz seÃ§iniz!",
        confirmButtonText: "Tamam",
      });
      return; // Ä°ÅŸlemi durdur
    }

    // **Loading ekranÄ±nÄ± ekleyelim**
    let loadingOverlay = document.createElement("div");
    loadingOverlay.id = "loading-overlay";
    loadingOverlay.className = "loading-overlay";
    loadingOverlay.innerHTML = `
        <div class="loading-box">
          <p> Data yÃ¼kleniyor...</p>
          <div class="loader"></div>
        </div>`;
    document.body.appendChild(loadingOverlay);

    window.location.href = "/data";
  }

  function goToEquipmentSetting() {
    let dropdown = document.getElementById("modem");
    let selectedDeviceIP = dropdown ? dropdown.value : null; // SeÃ§ili cihazÄ±n IP'sini al

    if (!selectedDeviceIP) {
      // KullanÄ±cÄ±ya uyarÄ± ver
      Swal.fire({
        icon: "warning",
        title: "UyarÄ±",
        text: "LÃ¼tfen Ã¶nce bir cihaz seÃ§iniz!",
        confirmButtonText: "Tamam",
      });
      return;
    }

    // **Loading ekranÄ±nÄ± ekleyelim**
    let loadingOverlay = document.createElement("div");
    loadingOverlay.id = "loading-overlay";
    loadingOverlay.className = "loading-overlay";
    loadingOverlay.innerHTML = `
        <div class="loading-box">
          <p> Equipments taranÄ±yor...</p>
          <div class="loader"></div>
        </div>`;
    document.body.appendChild(loadingOverlay); // **Sayfaya ekle**

    fetch("/modbus_request", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ ip_address: selectedDeviceIP }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          alert("Hata: " + data.error);
          return;
        }

        // Modbus verilerini Equipment sayfasÄ±na yÃ¶nlendirmeden Ã¶nce sakla
        sessionStorage.setItem("modbus_data", JSON.stringify(data.modbus_data));

        // Equipment sayfasÄ±na yÃ¶nlendir
        window.location.href = "/equipment-setting";
      })
      .catch((error) => {
        console.error("Modbus verisi alÄ±rken hata oluÅŸtu:", error);
        alert("EqÄ±ipment verisi alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.");
      })
      .finally(() => {
        // **Loading ekranÄ±nÄ± kaldÄ±r**
        let loader = document.getElementById("loading-overlay");
        if (loader) loader.remove();
      });
  }

  function updateDateTime() {
    const now = new Date();

    // GÃ¼n, ay, yÄ±l formatÄ±nda al (DD Month YYYY)
    const options = { day: "2-digit", month: "long", year: "numeric" };
    const formattedDate = now.toLocaleDateString("tr-TR", options);

    // Saat ve dakikayÄ± ekle (HH:MM formatÄ±nda)
    const formattedTime = now.toLocaleTimeString("tr-TR", {
      hour: "2-digit",
      minute: "2-digit",
    });

    // HTML iÃ§ine ekle
    document.getElementById(
      "currentDateTime"
    ).textContent = `${formattedDate} ${formattedTime}`;
  }

  updateDateTime();

  setInterval(updateDateTime, 60000);

  window.addEventListener("pageshow", function (event) {
    let loader = document.getElementById("loading-overlay");
    if (loader) {
      loader.remove();
    }
  });

  // Alarm SayfasÄ±na YÃ¶nlendirir
  function goToAlarm() {
    let dropdown = document.getElementById("modem");
    let selectedDeviceIP = dropdown ? dropdown.value : null;

    // EÄŸer cihaz seÃ§ilmemiÅŸse kesinlikle yÃ¶nlendirme yapma ve uyarÄ± ver
    if (!selectedDeviceIP) {
      Swal.fire({
        icon: "warning",
        title: "UyarÄ±",
        text: "LÃ¼tfen Ã¶nce bir cihaz seÃ§iniz!",
        confirmButtonText: "Tamam",
      });
      return;
    }

    // **Loading ekranÄ±nÄ± ekleyelim**
    let loadingOverlay = document.createElement("div");
    loadingOverlay.id = "loading-overlay";
    loadingOverlay.className = "loading-overlay";
    loadingOverlay.innerHTML = `
        <div class="loading-box">
          <p> Alarm sayfasÄ±na yÃ¶nlendiriliyor...</p>
          <div class="loader"></div>
        </div>`;
    document.body.appendChild(loadingOverlay);

    // **Cihaz bilgisi Ã§ekilip yÃ¶nlendirme yapÄ±lacak**
    fetch("/get_selected_device")
      .then((response) => response.json())
      .then((data) => {
        if (!data.ip_address) {
          Swal.fire({
            icon: "warning",
            title: "UyarÄ±",
            text: "LÃ¼tfen Ã¶nce bir cihaz seÃ§iniz!",
            confirmButtonText: "Tamam",
          });
          return;
        }

        window.location.href = `/alarm?ip_address=${data.ip_address}`;
      })
      .catch((error) => {
        console.error("Cihaz seÃ§me hatasÄ±:", error);
        Swal.fire({
          icon: "error",
          title: "Hata!",
          text: "Cihaz bilgisi alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.",
          confirmButtonText: "Tamam",
        });
      })
      .finally(() => {
        let loader = document.getElementById("loading-overlay");
        if (loader) loader.remove();
      });
  }

  // ðŸ“Œ AbortController deÄŸiÅŸkenleri (Ä°lk baÅŸta boÅŸ)
  let networkAlarmController = new AbortController();
  let electricAlarmController = new AbortController();
  let alarmUpdateInterval = null; // ðŸ”¹ Interval ID'yi saklayacaÄŸÄ±z

  function updateAlarmCount() {
    let selectedDeviceIP = sessionStorage.getItem("selected_device_ip");
    let alarmBadge = document.getElementById("alarm-count");

    // ðŸ“Œ EÄŸer cihaz seÃ§ili deÄŸilse API Ã§aÄŸrÄ±larÄ±nÄ± durdur ve alarmÄ± sÄ±fÄ±rla
    if (!selectedDeviceIP || selectedDeviceIP.trim() === "") {
      console.warn("Cihaz seÃ§ili deÄŸil, alarm sÄ±fÄ±rlandÄ±!");

      // ðŸ”¹ Eski istekleri iptal et
      networkAlarmController.abort();
      electricAlarmController.abort();

      // ðŸ”¹ Yeni istekler iÃ§in yeni AbortController oluÅŸtur
      networkAlarmController = new AbortController();
      electricAlarmController = new AbortController();

      // ðŸ”¹ Interval Ã§alÄ±ÅŸÄ±yorsa durdur
      if (alarmUpdateInterval) {
        clearInterval(alarmUpdateInterval);
        alarmUpdateInterval = null;
      }

      // ðŸ”¹ Alarm sayÄ±sÄ±nÄ± sÄ±fÄ±rla
      localStorage.removeItem("last_alarm_count");
      alarmBadge.textContent = "0";
      alarmBadge.style.display = "inline-block";
      return;
    }

    console.log("SeÃ§ili cihaz:", selectedDeviceIP);

    let totalAlarms = 0;
    let errorOccurred = false;

    // **Network AlarmlarÄ±nÄ± Ã‡ek**
    fetch(`/get_network_alarm_data?ip=${selectedDeviceIP}`, {
      signal: networkAlarmController.signal,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          totalAlarms += data.data.length;
        } else {
          console.error("Network alarm verisi alÄ±namadÄ±:", data.message);
          errorOccurred = true;
        }
        return fetch(`/get_electric_alarm_data?ip=${selectedDeviceIP}`, {
          signal: electricAlarmController.signal,
        });
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          totalAlarms += data.data.length;
        } else {
          console.error("Electric alarm verisi alÄ±namadÄ±:", data.message);
          errorOccurred = true;
        }

        // ðŸ“Œ EÄŸer hata olduysa alarm sayÄ±sÄ±nÄ± sÄ±fÄ±rla
        if (errorOccurred) {
          console.warn("Hata oluÅŸtuÄŸu iÃ§in alarm sÄ±fÄ±rlandÄ±.");
          totalAlarms = 0;
        }

        // ðŸ“Œ Alarm deÄŸerini gÃ¶ster
        alarmBadge.textContent = totalAlarms;
        alarmBadge.style.display = "inline-block";

        // ðŸ“Œ Yeni alarm deÄŸerini localStorage'a kaydet
        localStorage.setItem("last_alarm_count", totalAlarms);
      })
      .catch((error) => {
        if (error.name === "AbortError") {
          console.warn("Alarm verisi isteÄŸi iptal edildi.");
        } else {
          console.error("SeÃ§ilen cihaz iÃ§in alarm verisi alÄ±namadÄ±:", error);
        }

        // ðŸ“Œ Hata durumunda alarmÄ± sÄ±fÄ±rla
        alarmBadge.textContent = "0";
        alarmBadge.style.display = "inline-block";
      });
  }

  // ðŸ“Œ Cihaz SeÃ§me Fonksiyonu
  function connectDevice() {
    let dropdown = document.getElementById("modem");
    let selectedDevice = dropdown.value;

    // ðŸ“Œ EÄŸer cihaz seÃ§ilmediyse her ÅŸeyi sÄ±fÄ±rla ve Ã§Ä±k
    if (!selectedDevice || selectedDevice.trim() === "") {
      console.warn("Cihaz seÃ§ilmedi, alarm sÄ±fÄ±rlanÄ±yor.");

      sessionStorage.removeItem("selected_device_ip");
      localStorage.removeItem("last_alarm_count");

      // ðŸ”¹ Eski istekleri iptal et
      networkAlarmController.abort();
      electricAlarmController.abort();

      // ðŸ”¹ Yeni istekler iÃ§in controller oluÅŸtur
      networkAlarmController = new AbortController();
      electricAlarmController = new AbortController();

      document.getElementById("alarm-count").textContent = "0";
      document.getElementById("alarm-count").style.display = "inline-block";

      return;
    }

    //  Cihaz baÄŸlanÄ±rken alarm isteklerini resetle
    fetch("/connect_device", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ip_address: selectedDevice }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          sessionStorage.setItem("selected_device_ip", selectedDevice);

          // ðŸ”¹ Eski istekleri iptal et ve yenilerini baÅŸlat
          networkAlarmController.abort();
          electricAlarmController.abort();

          networkAlarmController = new AbortController();
          electricAlarmController = new AbortController();

          updateAlarmCount();

          // ðŸ”¹ Alarm sayÄ±sÄ±nÄ± 10 saniyede bir gÃ¼ncellemek iÃ§in setInterval baÅŸlat (Tekrar Ã§aÄŸrÄ±lmasÄ±nÄ± Ã¶nlemek iÃ§in Ã¶nce temizliyoruz)
          if (alarmUpdateInterval) {
            clearInterval(alarmUpdateInterval);
          }
          alarmUpdateInterval = setInterval(updateAlarmCount, 10000000000000);
        } else {
          sessionStorage.removeItem("selected_device_ip");
          console.error("BaÄŸlantÄ± hatasÄ±:", data.error);
          document.getElementById("alarm-count").textContent = "0";
        }
      })
      .catch((error) => {
        console.error("BaÄŸlantÄ± hatasÄ±:", error);
        sessionStorage.removeItem("selected_device_ip");
        document.getElementById("alarm-count").textContent = "0";
      });
  }

  // Sayfa YÃ¼klendiÄŸinde Ã‡alÄ±ÅŸtÄ±r
  document.addEventListener("DOMContentLoaded", function () {
    let selectedDeviceIP = sessionStorage.getItem("selected_device_ip");
    let alarmBadge = document.getElementById("alarm-count");

    if (!selectedDeviceIP) {
      console.warn("Sayfa yenilendi, cihaz yok, alarm sÄ±fÄ±rlandÄ±!");

      networkAlarmController.abort();
      electricAlarmController.abort();

      networkAlarmController = new AbortController();
      electricAlarmController = new AbortController();

      localStorage.removeItem("last_alarm_count");

      alarmBadge.textContent = "0";
      alarmBadge.style.display = "inline-block";
    } else {
      updateAlarmCount();
    }
  });
</script>

<style>
  div:where(.swal2-container) div:where(.swal2-popup) {
    width: 28em;
  }

  div:where(.swal2-container) h2:where(.swal2-title) {
    padding: 0.1em 0;
  }

  div:where(.swal2-icon) {
    width: 4em;
    height: 4em;
    margin: 0.8em auto 0.6em;
  }
  div:where(.swal2-container) div:where(.swal2-actions) {
    margin: 0.25em auto 0;
  }

  div:where(.swal2-container) div:where(.swal2-html-container) {
    padding: 0.25em 1.4em 0.2em;
  }

  div:where(.swal2-icon).swal2-error [class^="swal2-x-mark-line"] {
    display: block;
    position: absolute;
    top: 2em;
    width: 1.9375em;
    height: 0.3125em;
    border-radius: 0.125em;
    background-color: #f27474;
  }
</style>
{% endblock %}
