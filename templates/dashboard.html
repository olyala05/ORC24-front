{% extends "layout.html" %} 

{% block title %} ORC 24 Dashboard {% endblock title%} 

{% block content %}
<!-- Echarts -->
<script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
<header class="header">
  <div class="header-left">
    <!-- Menu butonunu modem-selection sayfasına yönlendirme -->
    <form action="{{ url_for('login') }}" method="GET">
      <button type="submit" class="header-button" style="gap: 0">
      <span style="padding: 14px 13px">{{ _('Login') }}</span>
        <img
          src="{{ url_for('static', filename='images/svg/36.svg') }}"
          alt="Logout"
          width="30"
          height="30"
          style="padding: 7px 9px; background: #0b1734; border-radius: 5px"
        />
      </button>
    </form>

              <!-- Dil Seçici -->
          <div class="language-switcher fixed-top-right" id="languageSwitcher">
            <button type="button" class="language-toggle" id="languageToggle">
              <img
                src="{{ url_for('static', filename='images/svg/globe.svg') }}"
                width="24"
                height="24"
                alt="Globe Icon"
              />
              <span class="selected-lang-txt" id="selectedLangLabel">
                {{ g.lang.upper() }}
              </span>
            </button>

            <div class="language-dropdown" id="languageDropdown">
              <div class="dropdown-arrow"></div>

              <!-- Türkçe -->
              <button
                type="button"
                class="lang-btn {% if g.get('lang') == 'tr' %}selected{% endif %}"
                data-lang="tr"
                onclick="setLanguage('tr')"
              >
                <div class="lang-content">
                  <img
                    src="{{ url_for('static', filename='images/flags/tr.png') }}"
                    width="20"
                  />
                  <span>TR</span>
                </div>

                <div class="radio-indicator-cover">
                <span class="radio-indicator"></span>

                </div>
              </button>

              <!-- English -->
              <button
                type="button"
                class="lang-btn {% if g.get('lang') == 'en' %}selected{% endif %}"
                data-lang="en"
                onclick="setLanguage('en')"
              >
                <div class="lang-content">
                  <img
                    src="{{ url_for('static', filename='images/flags/uk.png') }}"
                    width="20"
                  />
                  <span>EN</span>
                </div>
                <div class="radio-indicator-cover">
                <span class="radio-indicator"></span>
              </button>

              <!-- Deutsch -->
              <button
                type="button"
                class="lang-btn {% if g.get('lang') == 'de' %}selected{% endif %}"
                data-lang="de"
                onclick="setLanguage('de')"
              >
                <div class="lang-content">
                  <img
                    src="{{ url_for('static', filename='images/flags/de.png') }}"
                    width="20"
                  />
                  <span>DE</span>
                </div>
                <div class="radio-indicator-cover">
                <span class="radio-indicator"></span>
              </button>
            </div>
          </div>
  </div>

  <div class="header-logo">
    <img
      src="{{ url_for('static', filename='images/logos/logo-02.png') }}"
      alt="Pier MTTP Logo"
      class="logo"
    />
  </div>
  
  <div class="header-right-dashboard">
    <div class="date-time" id="current-date-time">{{ _('Loading...') }}</div>
    <div class="report-line">
      <div class="line"></div>
    </div>
    <div class="report-date" id="report-date">
      <span style="color: #6384d1">{{ _('Report Date') }}:</span> {{ _('Loading...') }}
    </div>
  </div>
</header>

<!-- Ana Tablo -->
<section class="dashboard">
  <div class="energy-table">
    <div class="energy-header">
      <div>{{ _('Energy Drawn From The Grid') }}</div>
      <div style="margin-right: 79px">{{ _('Generated Energy') }}</div>
      <div>{{ _('Consumed Energy') }}</div>
    </div>
    <div class="energy-row">
      <div>
        <img
          src="{{ url_for('static', filename='images/svg/08.svg') }}"
          alt="Energy"
        />
        80.158,68 kWh
      </div>
      <div>
        <img
          src="{{ url_for('static', filename='images/svg/08.svg') }}"
          alt="Energy"
        />
        80.158,68 kWh
      </div>
      <div>
        <img
          src="{{ url_for('static', filename='images/svg/08.svg') }}"
          alt="Energy"
        />
        80.158,68 kWh
      </div>
    </div>

    <div class="energy-row">
      <div>
        <img
          src="{{ url_for('static', filename='images/svg/09.svg') }}"
          alt="Industry"
        />
        80.158,68 TEP
      </div>
      <div>
        <img
          src="{{ url_for('static', filename='images/svg/09.svg') }}"
          alt="Industry"
        />
        80.158,68 TEP
      </div>
      <div>
        <img
          src="{{ url_for('static', filename='images/svg/09.svg') }}"
          alt="Industry"
        />
        80.158,68 TEP
      </div>
    </div>

    <div class="energy-row">
      <div>
        <img
          src="{{ url_for('static', filename='images/svg/10.svg') }}"
          alt="Cloud"
        />
        80.158,68 Ton
      </div>
      <div>
        <img
          src="{{ url_for('static', filename='images/svg/10.svg') }}"
          alt="Cloud"
        />
        80.158,68 Ton
      </div>
      <div>
        <img
          src="{{ url_for('static', filename='images/svg/10.svg') }}"
          alt="Cloud"
        />
        80.158,68 Ton
      </div>
    </div>
  </div>

  <div class="device-status">
    <div class="dashboard-container">
      <!-- Voltaj ve Akım Kutuları -->
      <div class="voltage-section">
        <div class="voltage-table">
          <div class="voltage-box">
            <span class="icon">
              <img
                src="{{ url_for('static', filename='images/svg/33.svg') }}"
                alt="Voltage"
              />
            </span>
            <span class="value">220 V</span>
            <span class="phase">V1-N</span>
          </div>
          <div class="voltage-box">
            <span class="icon">
              <img
                src="{{ url_for('static', filename='images/svg/33.svg') }}"
                alt="Voltage"
              />
            </span>
            <span class="value">220 V</span>
            <span class="phase">V2-N</span>
          </div>
          <div class="voltage-box">
            <span class="icon">
              <img
                src="{{ url_for('static', filename='images/svg/33.svg') }}"
                alt="Voltage"
              />
            </span>
            <span class="value">220 V</span>
            <span class="phase">V3-N</span>
          </div>
        </div>

        <div class="voltage-table">
          <div class="voltage-box">
            <span class="icon">
              <img
                src="{{ url_for('static', filename='images/svg/34.svg') }}"
                alt="Current"
              />
            </span>
            <span class="value">300 A</span>
            <span class="phase">I1-N</span>
          </div>
          <div class="voltage-box">
            <span class="icon">
              <img
                src="{{ url_for('static', filename='images/svg/34.svg') }}"
                alt="Current"
              />
            </span>
            <span class="value">250 A</span>
            <span class="phase">I2-N</span>
          </div>
          <div class="voltage-box">
            <span class="icon">
              <img
                src="{{ url_for('static', filename='images/svg/34.svg') }}"
                alt="Current"
              />
            </span>
            <span class="value">220 A</span>
            <span class="phase">I3-N</span>
          </div>
        </div>
      </div>

      <!-- ECHARTS -->
        <div id="frequencyGauge" style="width: 130px; height: 130px;"></div>

        <div id="reactiveStatus" style="width: 130px; height: 120px;"></div>

        <div id="powerFactorGauge" style="width: 130px; height: 130px"></div>

      </div>
    </div>
  </div>
</section>

<script>
  // Dil değiştirildiğinde çağrılacak fonksiyon
    document.addEventListener("DOMContentLoaded", function () {
    // Sayfa yüklendiğinde aktif dilin gösterilmesini sağla
    const lang = "{{ g.get('lang', 'EN') }}"; // Flask'tan alınan aktif dil
    const selectedLangLabel = document.getElementById("selectedLangLabel");

    // Globe üzerindeki dil kodunu güncelle
    if (selectedLangLabel) {
      selectedLangLabel.innerText = lang.toUpperCase(); // Globe üzerindeki dil kodunu güncelle
      console.log(
        "Globe üzerindeki dil kodu (sayfa yüklendi):",
        lang.toUpperCase()
      ); // Log ekledik
    }

    // Dil seçeneği değiştirildiğinde çalışan fonksiyon
    function setLanguage(lang) {
      console.log("Dil değiştiriliyor:", lang); // Dil değişikliği yapılmadan önce log

      // Tüm dil butonlarından selected sınıfını kaldır
      document
        .querySelectorAll(".lang-btn")
        .forEach((btn) => btn.classList.remove("selected"));

      // Seçilen dil butonuna selected sınıfını ekle
      const selectedBtn = document.querySelector(
        `.lang-btn[data-lang="${lang}"]`
      );
      if (selectedBtn) {
        selectedBtn.classList.add("selected");
      }

      // Globe yanındaki TR / EN / DE yazısını güncelle
      if (selectedLangLabel) {
        selectedLangLabel.innerText = lang.toUpperCase(); // Globe üzerindeki dil kodunu değiştir
      }

      // Backend dil güncellemesi yap
      fetch("{{ url_for('set_language') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: "lang=" + lang,
      }).then(() => {
        console.log("Backend'e gönderilen dil:", lang); // Dil backend'e gönderildiğini logla
        window.location.reload(); // Yeni dilin yüklendiği halini göster
      });
    }

    // Dil butonlarına tıklandığında setLanguage fonksiyonunu çalıştır
    document.querySelectorAll(".lang-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const lang = button.getAttribute("data-lang");
        setLanguage(lang); // Seçilen dil ile setLanguage fonksiyonunu çağır
      });
    });

    // Dil seçici butonunun tıklama olayı
    const toggle = document.getElementById("languageToggle");
    const switcher = document.getElementById("languageSwitcher");

    toggle.addEventListener("click", function (event) {
      event.stopPropagation();
      switcher.classList.toggle("active");
    });

    document.addEventListener("click", function (e) {
      if (!switcher.contains(e.target)) {
        switcher.classList.remove("active");
      }
    });
  });
  
  document.addEventListener("DOMContentLoaded", function () {
    function updateDateTime() {
      const userLang = document.body.dataset.lang || "en"; 
      const now = new Date();
      const monthShort = now
        .toLocaleString(userLang, { month: "long" })
        .substring(0, 5);
      const formattedDateTime = `${monthShort} ${now.getDate()}, ${now.getFullYear()}, ${now.getHours()}:${now
        .getMinutes()
        .toString()
        .padStart(2, "0")}`;
      document.getElementById("current-date-time").innerText =
        formattedDateTime;

      const lastMonth = new Date();
      lastMonth.setDate(lastMonth.getDate() - 30);

      const reportStartMonth = lastMonth
        .toLocaleString(userLang, { month: "long" })
        .substring(0, 5);
      const reportEndMonth = now
        .toLocaleString(userLang, { month: "long" })
        .substring(0, 5);

      const reportStart = `${reportStartMonth} ${lastMonth.getDate()}`;
      const reportEnd = `${reportEndMonth} ${now.getDate()}`;

      const reportDateEl = document.getElementById("report-date");
      reportDateEl.innerHTML = `<span style="color: #6384D1;">{{ _('Report Date') }}:</span> <span style="color: #fff;">${reportStart} - ${reportEnd}</span>`;
    }

    updateDateTime();
    setInterval(updateDateTime, 60000);
  });

    

    // Eğer dili almanca ise chartdaki fontsize ler 12px olsun
    var currentLang = "{{ get_locale() }}";
    var isGerman = currentLang === "de";

    // Echarts 1 Frekans (Hz)
    var chart = echarts.init(document.getElementById("frequencyGauge"));
    var option = {
      graphic: [
        {
          type: "circle",
          left: "center",
          top: "center",
          shape: {
            r: 60,
          },
          style: {
            fill: "#0B1734",
            stroke: "#0D1A36",
            lineWidth: 4,
          },
          z: 0,
        }
      ],
      series: [
        {
          type: "gauge",
          startAngle: 180,
          endAngle: 0,
          radius: "88%",
          center: ["50%", "52%"],

          progress: {
            show: true,
            width: 12,
            itemStyle: {
              color: "#0EB100",
            },
            animation: false,
          },

          axisLine: {
            lineStyle: {
              width: 12,
              color: [
                [0.5, "#1C2747"],
                [1, "#f57c00"],
              ],
            },
          },

          pointer: {
            show: false,
          },

          axisTick: {
            show: false,
          },

          splitLine: {
            show: false,
          },

          axisLabel: {
            show: false,
          },

          title: {
            show: false,
          },

          detail: {
            valueAnimation: true,
            formatter: function (value) {
              return `{line1|${value.toFixed(2)}}\n{line2|{{ _('Frequency') }}}\n{line3|(Hz)}`;
            },
            rich: {
              line1: {
                fontSize: isGerman ? 14 : 16,
                fontWeight: "bold",
                color: "#ffffff",
                lineHeight: 22,
              },
              line2: {
                fontSize: isGerman ? 14 : 16,
                color: "#ffffff",
                lineHeight: 22,
              },
              line3: {
                fontSize: isGerman ? 14 : 14,
                color: "#ffffff",
                lineHeight: 22,
              },
            },
            offsetCenter: [0, "20%"],
          },

          data: [
            {
              value: 50.04,
            },
          ],
        },
      ],
    };
    chart.setOption(option);

    // Echarts 2 
    var chart = echarts.init(document.getElementById("reactiveStatus"));
    var option = {
      graphic: [
        {
          type: "circle",
          left: "center",
          top: "center",
          shape: {
            r: 58,
          },
          style: {
            fill: "transparent",
            stroke: "#00a000",
            lineWidth: 4,
          },
          z: 1,
        },
        {
          type: "circle",
          left: "center",
          top: "center",
          shape: {
            r: 52,
          },
          style: {
            fill: "green",
            stroke: "none",
          },
          z: 2,
        },
        {
          type: "text",
          left: "center",
          top: "center",
          style: {
            text: `{line1|{{ _('Reactive') }}}\n{line2|{{ _('Penalty') }}}\n{line3|{{ _('Not Exist') }}}`,
            fill: "#fff",
            textAlign: "center",
            textVerticalAlign: "middle",
            rich: {
              line1: {
                fontSize: isGerman ? 13 : 16,
                fontWeight: "bold",
                lineHeight: 20,
              },
              line2: {
                fontSize: isGerman ? 13 : 16,
                fontWeight: "bold",
                lineHeight: 20,
              },
              line3: {
                fontSize: isGerman ? 12 : 14,
                lineHeight: 18,
              },
            },
          },
          z: 3,
        },
      ],
    };
    chart.setOption(option);


    // Echarts 3 Güç Faktörü
    var chart = echarts.init(document.getElementById("powerFactorGauge"));
    var option = {
      graphic: [
        {
          type: "circle",
          left: "center",
          top: "center",
          shape: {
            r: 60,
          },
          style: {
            fill: "#0B1734",
          },
          z: 0,
        }
      ],
      series: [
        {
          type: "gauge",
          radius: "82%",
          center: ["50%", "50%"],
          startAngle: 225,
          endAngle: -45,

          progress: {
            show: true,
            width: 12,
            itemStyle: {
              color: "#f57c00",
            },
          },

          axisLine: {
            lineStyle: {
              width: 12,
              color: [[1, "#2b2f4b"]],
            },
          },

          pointer: {
            show: false,
          },

          axisTick: {
            show: false,
          },

          splitLine: {
            show: false,
          },

          axisLabel: {
            show: false,
          },

          title: {
            show: false,
          },

          detail: {
            valueAnimation: true,
            formatter: function (value) {
              return `{line1|{{ _('Power') }}}\n{line2|{{ _('Factor') }}}\n{line3|${value.toFixed(2)}%}`;
            },
            rich: {
              line1: {
                fontSize: isGerman ? 13 : 16,
                fontWeight: "bold",
                color: "#fff",
                lineHeight: 20,
              },
              line2: {
                fontSize: isGerman ? 13 : 16,
                color: "#fff",
                lineHeight: 20,
              },
              line3: {
                fontSize: isGerman ? 13 : 16,
                fontWeight: "bold",
                color: "#fff",
                lineHeight: 20,
              },
            },
            offsetCenter: [0, "10%"],
          },

          data: [
            {
              value: 87.45,
            },
          ],
        },
      ],
    };

    chart.setOption(option);

</script>


{% endblock content %}
