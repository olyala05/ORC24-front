{% extends "layout.html" %} 

{% block title %} ORC 24 Dashboard {% endblock title%} 

{% block content %}
<!-- Echarts -->
<script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
<header class="header">
  <div class="header-left">
        <!-- Login yerine yönlendirme kontrolü -->
    <form action="{{ url_for('auth.check_login_redirect') }}" method="GET">
      <button type="submit" class="header-button" style="gap: 0">
        <span style="padding: 14px 13px">{{ _('Login') }}</span>
        <img
          src="{{ url_for('static', filename='images/svg/36.svg') }}"
          alt="Logout"
          width="30"
          height="30"
          style="padding: 7px 9px; background: #0b1734; border-radius: 5px"
        />
      </button>
    </form>
          <!-- Dil Seçici -->
          <div class="language-switcher fixed-top-right" id="languageSwitcher" class="lang-back" style= "background-color: #EF8018; padding: 10px; border-radius: 5px;">
            <button type="button" class="language-toggle" id="languageToggle" style="color: #0B1734;font-weight: 600;">
              <img
                src="{{ url_for('static', filename='images/svg/globe-black.svg') }}"
                width="30"
                height="30"
                alt="Globe Icon"
              />
              <span class="selected-lang-txt" id="selectedLangLabel">
                {{ g.lang.upper() }}
              </span>
            </button>

            <div class="language-dropdown" id="languageDropdown" style="min-width: 90px; top: 119%; display: none;">
              <div class="dropdown-arrow"></div>

              <!-- Türkçe -->
              <button
                type="button"
                class="lang-btn {% if g.get('lang') == 'tr' %}selected{% endif %}"
                data-lang="tr"
                onclick="setLanguage('tr')"
              >
                <div class="lang-content">
                  <img
                    src="{{ url_for('static', filename='images/flags/tr.png') }}"
                    width="20"
                  />
                  <span>TR</span>
                </div>

                <div class="radio-indicator-cover">
                <span class="radio-indicator"></span>

                </div>
              </button>

              <!-- English -->
              <button
                type="button"
                class="lang-btn {% if g.get('lang') == 'en' %}selected{% endif %}"
                data-lang="en"
                onclick="setLanguage('en')"
              >
                <div class="lang-content">
                  <img
                    src="{{ url_for('static', filename='images/flags/uk.png') }}"
                    width="20"
                  />
                  <span>EN</span>
                </div>
                <div class="radio-indicator-cover">
                <span class="radio-indicator"></span>
              </button>

              <!-- Deutsch -->
              <button
                type="button"
                class="lang-btn {% if g.get('lang') == 'de' %}selected{% endif %}"
                data-lang="de"
                onclick="setLanguage('de')"
              >
                <div class="lang-content">
                  <img
                    src="{{ url_for('static', filename='images/flags/de.png') }}"
                    width="20"
                  />
                  <span>DE</span>
                </div>
                <div class="radio-indicator-cover">
                <span class="radio-indicator"></span>
              </button>
            </div>
          </div>
  </div>

  <div class="header-logo">
    <img
      src="{{ url_for('static', filename='images/logos/logo-02.png') }}"
      alt="Pier MTTP Logo"
      class="logo"
    />
  </div>
  
  <div class="header-right-dashboard">
    <div class="date-time" id="current-date-time">{{ _('Loading...') }}</div>
    <div class="report-line">
      <div class="line"></div>
    </div>
    <div class="report-date" id="report-date">
      <span style="color: #6384d1">{{ _('Report Date') }}:</span> {{ _('Loading...') }}
    </div>
  </div>
</header>

<!-- Ana Tablo -->
<section class="dashboard">
  <div class="energy-table">
  <div class="energy-header">
    <div>{{ _('Energy Drawn From The Grid') }}</div>
    <div style="margin-right: 79px">{{ _('Generated Energy') }}</div>
    <div>{{ _('Consumed Energy') }}</div>
  </div>

  <!-- Row 1: kWh -->
  <div class="energy-row">
    <div>
      <img src="{{ url_for('static', filename='images/svg/08.svg') }}" alt="Energy" />
      {{ "{:,.2f}".format(from_grid.kwh).replace(",", "X").replace(".", ",").replace("X", ".") }} kWh
    </div>
    <div>
      <img src="{{ url_for('static', filename='images/svg/08.svg') }}" alt="Energy" />
      {{ "{:,.2f}".format(total_generated.kwh).replace(",", "X").replace(".", ",").replace("X", ".") }} kWh
    </div>
    <div>
      <img src="{{ url_for('static', filename='images/svg/08.svg') }}" alt="Energy" />
      {{ "{:,.2f}".format(total_consumed.kwh).replace(",", "X").replace(".", ",").replace("X", ".") }} kWh
    </div>
  </div>

  <!-- Row 2: TEP -->
  <div class="energy-row">
    <div>
      <img src="{{ url_for('static', filename='images/svg/09.svg') }}" alt="TEP" />
      {{ "{:,.2f}".format(from_grid.tep).replace(",", "X").replace(".", ",").replace("X", ".") }} TEP
    </div>
    <div>
      <img src="{{ url_for('static', filename='images/svg/09.svg') }}" alt="TEP" />
      {{ "{:,.2f}".format(total_generated.tep).replace(",", "X").replace(".", ",").replace("X", ".") }} TEP
    </div>
    <div>
      <img src="{{ url_for('static', filename='images/svg/09.svg') }}" alt="TEP" />
      {{ "{:,.2f}".format(total_consumed.tep).replace(",", "X").replace(".", ",").replace("X", ".") }} TEP
    </div>
  </div>

  <!-- Row 3: Carbon (Ton) -->
  <div class="energy-row">
    <div>
      <img src="{{ url_for('static', filename='images/svg/10.svg') }}" alt="CO2" />
      {{ "{:,.2f}".format(from_grid.carbonTon).replace(",", "X").replace(".", ",").replace("X", ".") }} Ton
    </div>
    <div>
      <img src="{{ url_for('static', filename='images/svg/10.svg') }}" alt="CO2" />
      {{ "{:,.2f}".format(total_generated.carbonTon).replace(",", "X").replace(".", ",").replace("X", ".") }} Ton
    </div>
    <div>
      <img src="{{ url_for('static', filename='images/svg/10.svg') }}" alt="CO2" />
      {{ "{:,.2f}".format(total_consumed.carbonTon).replace(",", "X").replace(".", ",").replace("X", ".") }} Ton
    </div>
  </div>
</div>


  <div class="device-status">
    <div class="dashboard-container">
    <!-- Voltaj ve Akım Kutuları -->
    <div class="voltage-section">
      <!-- Voltajlar -->
      <div class="voltage-table">
        <div class="voltage-box">
          <span class="icon">
            <img src="{{ url_for('static', filename='images/svg/33.svg') }}" alt="Voltage" />
          </span>
          <span class="value">
            {{ "{:,.2f}".format(voltages.l1n).replace(",", "X").replace(".", ",").replace("X", ".") }} V
          </span>
          <span class="phase">V1-N</span>
        </div>
        <div class="voltage-box">
          <span class="icon">
            <img src="{{ url_for('static', filename='images/svg/33.svg') }}" alt="Voltage" />
          </span>
          <span class="value">
            {{ "{:,.2f}".format(voltages.l2n).replace(",", "X").replace(".", ",").replace("X", ".") }} V
          </span>
          <span class="phase">V2-N</span>
        </div>
        <div class="voltage-box">
          <span class="icon">
            <img src="{{ url_for('static', filename='images/svg/33.svg') }}" alt="Voltage" />
          </span>
          <span class="value">
            {{ "{:,.2f}".format(voltages.l3n).replace(",", "X").replace(".", ",").replace("X", ".") }} V
          </span>
          <span class="phase">V3-N</span>
        </div>
      </div>

      <!-- Akımlar -->
      <div class="voltage-table">
        <div class="voltage-box">
          <span class="icon">
            <img src="{{ url_for('static', filename='images/svg/34.svg') }}" alt="Current" />
          </span>
          <span class="value">
            {{ "{:,.2f}".format(currents.l1n).replace(",", "X").replace(".", ",").replace("X", ".") }} A
          </span>
          <span class="phase">I1-N</span>
        </div>
        <div class="voltage-box">
          <span class="icon">
            <img src="{{ url_for('static', filename='images/svg/34.svg') }}" alt="Current" />
          </span>
          <span class="value">
            {{ "{:,.2f}".format(currents.l2n).replace(",", "X").replace(".", ",").replace("X", ".") }} A
          </span>
          <span class="phase">I2-N</span>
        </div>
        <div class="voltage-box">
          <span class="icon">
            <img src="{{ url_for('static', filename='images/svg/34.svg') }}" alt="Current" />
          </span>
          <span class="value">
            {{ "{:,.2f}".format(currents.l3n).replace(",", "X").replace(".", ",").replace("X", ".") }} A
          </span>
          <span class="phase">I3-N</span>
        </div>
      </div>
    </div>

      <!-- ECHARTS -->
        <div id="frequencyGauge" style="width: 130px; height: 130px;"></div>

        <div id="reactiveStatus" style="width: 130px; height: 120px;"></div>

        <div id="powerFactorGauge" style="width: 130px; height: 130px"></div>

      </div>
    </div>
  </div>
</section>

<script>
    const frequencyValue = {{ "%.2f"|format(frequency) }};
    const powerFactorValue = {{ "%.2f"|format(power_factor) }};
    const penaltyExists = {{ 'true' if penalty_status else 'false' }};

    // Dil değiştirildiğinde çağrılacak fonksiyon
    document.addEventListener("DOMContentLoaded", function () {
        const lang = "{{ g.get('lang', 'EN') }}";
        const selectedLangLabel = document.getElementById("selectedLangLabel");
        if (selectedLangLabel) {
            selectedLangLabel.innerText = lang.toUpperCase();
        }

        function setLanguage(lang) {
            // Tüm butonlardan seçimi kaldır
            document.querySelectorAll(".lang-btn").forEach((btn) => btn.classList.remove("selected"));

            // Seçilen butonu işaretle
            const selectedBtn = document.querySelector(`.lang-btn[data-lang="${lang}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add("selected");
            }

            // Seçilen dili etiketle göster
            const selectedLangLabel = document.getElementById("selectedLangLabel");
            if (selectedLangLabel) {
                selectedLangLabel.innerText = lang.toUpperCase();
            }

            // Dropdown kapansın
            document.getElementById("languageDropdown").style.display = "none";

            // 📌 Loading Göster
            showLoading("{{ _('Changing language...') }}");

            // Form oluşturarak POST isteği gönder
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('set_language') }}";

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'lang';
            input.value = lang;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        // Dil butonlarına tıklama eventi
        document.querySelectorAll(".lang-btn").forEach((button) => {
            button.addEventListener("click", function () {
                const lang = button.getAttribute("data-lang");
                setLanguage(lang);
            });
        });

        // Dropdown toggle işlemi
        const toggle = document.getElementById("languageToggle");
        const dropdown = document.getElementById("languageDropdown");

        toggle.addEventListener("click", function (event) {
            event.stopPropagation();
            dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
        });

        // Sayfa dışına tıklanınca dropdown kapansın
        document.addEventListener("click", function (e) {
            if (!toggle.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = "none";
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
      function updateDateTime() {
        const userLang = document.body.dataset.lang || "en"; 
        const now = new Date();
        const monthShort = now
          .toLocaleString(userLang, { month: "long" })
          .substring(0, 5);
        const formattedDateTime = `${monthShort} ${now.getDate()}, ${now.getFullYear()}, ${now.getHours()}:${now
          .getMinutes()
          .toString()
          .padStart(2, "0")}`;
        document.getElementById("current-date-time").innerText =
          formattedDateTime;

        const lastMonth = new Date();
        lastMonth.setDate(lastMonth.getDate() - 30);

        const reportStartMonth = lastMonth
          .toLocaleString(userLang, { month: "long" })
          .substring(0, 5);
        const reportEndMonth = now
          .toLocaleString(userLang, { month: "long" })
          .substring(0, 5);

        const reportStart = `${reportStartMonth} ${lastMonth.getDate()}`;
        const reportEnd = `${reportEndMonth} ${now.getDate()}`;

        const reportDateEl = document.getElementById("report-date");
        reportDateEl.innerHTML = `<span style="color: #6384D1;">{{ _('Report Date') }}:</span> <span style="color: #fff;">${reportStart} - ${reportEnd}</span>`;
      }

      updateDateTime();
      setInterval(updateDateTime, 60000);
    });

    // Eğer dili almanca ise chartdaki fontsize ler 12px olsun
    var currentLang = "{{ get_locale() }}";
    var isGerman = currentLang === "de";

    function getFrequencyColor(value) {
      if (value < 45) return "#ff0000";
      if (value > 55) return "#f57c00";
      return "#0EB100";
    }

    // Echarts 1 Frekans (Hz)
    const frequencyChart = echarts.init(document.getElementById("frequencyGauge"));
    frequencyChart.setOption({
      graphic: [
        {
          type: "circle",
          left: "center",
          top: "center",
          shape: { r: 60 },
          style: {
            fill: "#0B1734",
            stroke: "#0D1A36",
            lineWidth: 4,
          },
          z: 0,
        }
      ],
      series: [
        {
          type: "gauge",
          startAngle: 180,
          endAngle: 0,
          radius: "88%",
          data: [{ value: frequencyValue }],
          progress: {
            show: true,
            width: 12,
            itemStyle: {
              color: getFrequencyColor(frequencyValue),
            },
            animation: false,
          },
          axisLine: {
            lineStyle: {
              width: 12,
              color: [[1, "#1C2747"]],
            },
          },
          pointer: { show: false },
          axisTick: { show: false },
          splitLine: { show: false },
          axisLabel: { show: false },
          title: { show: false },
          detail: {
            valueAnimation: true,
            formatter: function (val) {
              return `{line1|${val.toFixed(2)}}\n{line2|{{ _('Frequency') }}}\n{line3|(Hz)}`;
            },
            rich: {
              line1: {
                fontSize: isGerman ? 14 : 16,
                fontWeight: "bold",
                color: "#ffffff",
                lineHeight: 22,
              },
              line2: {
                fontSize: isGerman ? 14 : 16,
                color: "#ffffff",
                lineHeight: 22,
              },
              line3: {
                fontSize: isGerman ? 14 : 14,
                color: "#ffffff",
                lineHeight: 22,
              },
            },
            offsetCenter: [0, "20%"],
          },
        },
      ],
    });

    // Echarts 2 
    const reactiveChart = echarts.init(document.getElementById("reactiveStatus"));
    const reactiveColor = penaltyExists ? "red" : "green";
    const reactiveStroke = penaltyExists ? "#ff0000" : "#00a000";
    const reactiveText = penaltyExists
      ? `{line1|{{ _('Reactive') }}}\n{line2|{{ _('Penalty') }}}`
      : `{line1|{{ _('Reactive') }}}\n{line2|{{ _('Penalty') }}}\n{line3|{{ _('Not Exist') }}}`;

    reactiveChart.setOption({
      graphic: [
        {
          type: "circle",
          left: "center",
          top: "center",
          shape: { r: 58 },
          style: {
            fill: "transparent",
            stroke: reactiveStroke,
            lineWidth: 4,
          },
          z: 1,
        },
        {
          type: "circle",
          left: "center",
          top: "center",
          shape: { r: 52 },
          style: {
            fill: reactiveColor,
            stroke: "none",
          },
          z: 2,
        },
        {
          type: "text",
          left: "center",
          top: "center",
          style: {
            text: reactiveText,
            fill: "#fff",
            textAlign: "center",
            textVerticalAlign: "middle",
            rich: {
              line1: { fontSize: isGerman ? 13 : 16, fontWeight: "bold", lineHeight: 20 },
              line2: { fontSize: isGerman ? 13 : 16, fontWeight: "bold", lineHeight: 20 },
              line3: { fontSize: isGerman ? 12 : 14, lineHeight: 18 },
            },
          },
          z: 3,
        },
      ],
    });

    // Echarts 3 Güç Faktörü
    const pfChart = echarts.init(document.getElementById("powerFactorGauge"));

    pfChart.setOption({
      graphic: [
        {
          type: "circle",
          left: "center",
          top: "center",
          shape: { r: 60 },
          style: { fill: "#0B1734" },
          z: 0,
        }
      ],
      series: [
        {
          type: "gauge",
          radius: "82%",
          center: ["50%", "50%"],
          startAngle: 225,
          endAngle: -45,
          progress: {
            show: true,
            width: 12,
            itemStyle: { color: "#f57c00" },
          },
          axisLine: {
            lineStyle: { width: 12, color: [[1, "#2b2f4b"]] },
          },
          pointer: { show: false },
          axisTick: { show: false },
          splitLine: { show: false },
          axisLabel: { show: false },
          title: { show: false },
          detail: {
            valueAnimation: true,
            formatter: function (value) {
              return `{line1|{{ _('Power') }}}\n{line2|{{ _('Factor') }}}\n{line3|${value.toFixed(2)}%}`;
            },
            rich: {
              line1: {
                fontSize: isGerman ? 13 : 16,
                fontWeight: "bold",
                color: "#fff",
                lineHeight: 20,
              },
              line2: {
                fontSize: isGerman ? 13 : 16,
                color: "#fff",
                lineHeight: 20,
              },
              line3: {
                fontSize: isGerman ? 13 : 16,
                fontWeight: "bold",
                color: "#fff",
                lineHeight: 20,
              },
            },
            offsetCenter: [0, "10%"],
          },
          data: [{ value: powerFactorValue }],
        },
      ],
    });
</script>
{% endblock content %}
