{% extends "layout.html" %} {% block title %} {{ _('Test Details')}} {% endblock
%} {% block content %}
<!-- Header -->
{% include 'partials/header.html' %}
<!-- Virtual Keyboard -->
<div id="keyboard-container" class="simple-keyboard"></div>

<!-- Yeni İçerik (İlk başta gizli olacak) -->
<div class="test-switch-content">
  <!-- Sidebar Buttons -->
  <div class="test-sidebar-switch">
    <button class="switch-btn-test" data-target="wifi-test">
      {{ _('Wifi / Ethernet Connection Test')}}
    </button>
    <button class="switch-btn-test" data-target="equipment-test">
      {{ _('Equipment')}}
    </button>
    <button class="switch-btn-test" data-target="cloud-test">
      {{ _('Cloud Connection Test')}}
    </button>
    <button class="switch-btn-test" data-target="read">{{ _('Read')}}</button>
    <button class="switch-btn-test" data-target="write">{{ _('Write')}}</button>
  </div>

  <div class="switch-content-area">
    <!-- Wi-Fi Test -->
    <div id="wifi-test" class="tab-content-test">
      <div class="wifi-container-test">
        <!-- Wi-Fi Bölümü -->
        <div class="wifi-test-box">
          <!-- ICON -->
          <div class="wifi-test-head">
            <img
              src="{{ url_for('static', filename='images/svg/41.svg') }}"
              alt="No Wi-Fi"
              class="wifi-orange-icon"
            />
            <label class="orange-text">{{ _('Wi-Fi Connection Test')}}</label>
          </div>

          <!-- Network Name -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">{{ _('Network Name')}}</label>
            <span class="wifi-test-value" id="wifiNetworkName">-</span>
          </div>

          <!-- Password -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">{{ _('Password')}}</label>
            <span class="wifi-test-value" id="wifiPasswordDisplay">-</span>
          </div>

          <!-- Connection Status -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">{{ _('Connection Status')}}</label>
            <span
              class="wifi-test-value"
              id="wifiConnectionStatus"
              style="color: #ef4444"
              >{{ _('No connection')}}</span
            >
          </div>

          <!-- Connection Mac -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">{{ _('Connection Mac')}}</label>
            <span class="wifi-test-value" id="wifiMacAddress">-</span>
          </div>

          <!-- Test Button ve WiFi Status -->
          <div class="wifi-test-action">
            <button class="wifi-test-btn">{{ _('Test')}}</button>
          </div>
        </div>

        <!-- Available Wi-Fi -->
        <div class="network-box-test">
          <div class="wifi-list-test" id="wifiList" style="display: block">
            <div class="wifi-category-test">
              {{ _('Available Wi-Fi') }}
              <img
                src="{{ url_for('static', filename='images/svg/43.svg') }}"
                alt="Wi-Fi Icon"
              />
            </div>
            <ul id="dynamicWifiList">
              <!-- Dinamik olarak li elemanları JS ile eklenecek -->
              <li>{{ _('Loading available networks...') }}</li>
            </ul>
          </div>
        </div>

        <!-- Wi-Fi Şifre Giriş Popup -->
        <div id="wifiPopup" class="popup-overlay" style="display: none">
          <div class="popup-content">
            <h3>
              <img
                src="{{ url_for('static', filename='images/svg/12.svg') }}"
                alt="Wi-Fi"
              />
              {{ _('Enter the Wi-Fi password for')}} '<span id="wifiName"></span
              >'
            </h3>
            <label for="wifiPassword">{{ _('Password')}}</label>
            <input type="password" id="wifiPassword" placeholder="Password" />
            <div class="text-show-pass">
              <input type="checkbox" id="showPassword" />{{ _(' Show
              Password')}}
            </div>
            <div class="popup-buttons">
              <button class="cancel-btn" onclick="closeWifiPopup()">
                {{ _('Cancel')}}
              </button>
              <button id="joinWifiBtn" class="join-btn">
                <span class="button-text">{{ _('Join')}}</span>
                <span class="spinner" style="display: none"></span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Ethernet Bölümü -->
      <div id="ethernet-test">
        <div class="ethernet-container-test">
          <!-- Ethernet Test Paneli -->
          <div class="ethernet-test-box">
            <!-- ICON -->
            <div class="wifi-test-head">
              <img
                src="{{ url_for('static', filename='images/svg/44.svg') }}"
                alt="No Wi-Fi"
                class="wifi-orange-icon"
              />
              <label class="orange-text">{{ _('Wi-Fi Connection Test')}}</label>
            </div>
            <!-- Connection Status -->
            <div class="ethernet-test-row">
              <label class="ethernet-test-label"
                >{{ _('Connection Status')}}</label
              >
              <span
                id="ethernetConnectionStatus"
                class="ethernet-test-value"
                style="color: #ef4444"
                >{{ _('No connection')}}</span
              >
            </div>

            <!-- Connection Mac -->
            <div class="ethernet-test-row">
              <label class="ethernet-test-label"
                >{{ _('Connection Mac')}}</label
              >
              <span id="ethernetMacAddress" class="ethernet-test-value">-</span>
            </div>

            <!-- Test Button ve Ethernet Status -->
            <div class="ethernet-test-action">
              <button id="testEthernetBtn" class="ethernet-test-btn">
                {{ _('Test')}}
              </button>
              <div style="display: flex; flex-direction: column; gap: 5px">
                <span
                  id="ethernetSuccess"
                  class="ethernet-success"
                  style="display: none"
                >
                  <img
                    src="{{ url_for('static', filename='images/svg/15.svg') }}"
                    alt="Ethernet Connected"
                    class="ethernet-icon"
                  />
                  {{ _('Ethernet Connection Successful.')}}
                </span>
                <span
                  id="ethernetFailed"
                  class="ethernet-failed"
                  style="display: none"
                >
                  <img
                    src="{{ url_for('static', filename='images/svg/16.svg') }}"
                    alt="Ethernet Disconnected"
                    class="ethernet-icon"
                  />
                  {{ _('Ethernet Connection Failed.')}}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Equipment Test -->
    <div id="equipment-test" class="tab-content-test">
      <!-- Equipment Container -->
      <div class="equipment-test-container">
        <div class="equipment-test-card">
          <!-- Tablonun Başlangıcı -->
          <table class="equipment-table">
            <thead>
              <tr>
                <th>{{ _('Serial Number')}}</th>
                <th>{{ _('SID/IP')}}</th>
                <th>{{ _('Status')}}</th>
                <th>{{ _('Configuration Connection')}}</th>
                <th>{{ _('Connection Protocol')}}</th>
                <th>{{ _('Equipment Date / Connection Date')}}</th>
              </tr>
            </thead>
            <tbody id="equipment-table-body">
              <!-- Dinamik veriler buraya eklenecek -->
            </tbody>
          </table>
          <!-- Tablonun Sonu -->
        </div>
      </div>

      <!-- Butonlar ve Durum Bilgileri (Dışarı Çekildi) -->
      <div class="equipment-actions">
        <div class="equipment-scan-status">
          <button
            class="equipment-scan-btn"
            onclick="startScanning()"
            id="scan-btn"
          >
            {{ _('Perform a scanning test') }}
            
          </button>
          <span id="scan-status" style="display: none; color: #00c16a">
            {{ _('Scanning Equipments') }}
          </span>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="equipmentModal" class="popup-overlay" style="display: none">
      <div class="popup-content" style="width: 500px">
        <!-- Tarama tamamlandığında sadece varsa gösterilecek -->
        <h3 id="equipment-found-title" style="color: #ef8018; margin-bottom: 10px; display: none;">
          <i class="fa-solid fa-circle-exclamation" style="color: orange; margin: 8px; font-size: 22px"></i>
          {{ _('New Equipment Found') }}
        </h3>

        <!-- Tarama sonucu bulunamadı mesajı -->
        <p id="equipment-not-found-message" style="color: #ef4444; text-align: center; display: none;">
          Ekipman bulunamadı.
        </p>

        <!-- Spinner + Loading -->
        <div id="equipment-loading" style="text-align: center; padding: 20px">
          <p style="margin-top: 10px">{{ _('Scanning Equipments') }}</p>
          <div class="spinner" style="margin: 0 auto"></div>
        </div>

        <!-- Tablo -->
        <table
          id="equipment-table"
          style="width: 100%; color: #fff; border-spacing: 0 10px; text-align: center; display: none;">
          <thead>
            <tr>
              <th>Serial:</th>
              <th>SID/IP:</th>
              <th>Protokol:</th>
            </tr>
          </thead>
          <tbody id="modalEquipmentBody"></tbody>
        </table>

        <div id="equipment-ok-button" style="margin-top: 20px; text-align: center; display: none;">
          <button onclick="closeEquipmentModal()" class="close-equipment-modal">
            {{ _('Ok') }}
          </button>
        </div>
      </div>
    </div>

    <!-- Cloud Connection Test -->
    <div id="cloud-test" class="cloud-test-container tab-content-test">
      <div class="cloud-test-card">
        <table class="cloud-test-table">
          <thead>
            <tr>
              <th>{{ _('Archive') }}</th>
              <th>{{ _('End') }}</th>
              <th>{{ _('Connection')}}</th>
              <th>{{ _('Date')}}</th>
            </tr>
          </thead>
          <tbody>
            <tr data-status="A">
              <td class="cloud-test-status"></td>
              <td class="cloud-test-status"></td>
              <td>Cloud {{ _('Connection')}}</td>
              <td class="last-connection">{{ _('Checking...')}}</td>
              <!-- Dinamik olarak güncellenecek -->
            </tr>

            <tr data-status="P">
              <td class="cloud-test-status"></td>
              <td class="cloud-test-status"></td>
              <td>{{ _('Rabbit MQ')}}</td>
              <!-- Bağlıysa yeşil, değilse kırmızı olacak -->
              <td>2024-04-03 13:55:11</td>
            </tr>
            <tr data-status="A">
              <td class="cloud-test-status"></td>
              <td class="cloud-test-status"></td>
              <td>{{ _('VPN Port')}}</td>
              <td>2024-04-03 13:55:14</td>
            </tr>
          </tbody>
        </table>
        <p class="cloud-test-info">
          {{ _('*Does the ORC have connection with cloud and other devices or
          not?')}}
        </p>

        <!-- Buton ve Yazıları Yan Yana Düzenleme -->
        <div class="cloud-test-footer">
          <button class="cloud-test-button" onclick="updateRabbitMQStatus()">
            {{ _('Perform a scanning test')}}
          </button>
          <div class="cloud-test-status-text">
            <p class="cloud-test-success">
              {{ _('Local Network Connection Scan Successful.')}}
            </p>
            <p class="cloud-test-failed">
              {{ _('Local Network Connection Scan Failed.')}}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Read Test -->
    <div id="read" class="read-test-container tab-content-test">
      <div class="read-test-card">
        <div class="read-test-grid">
          <div class="read-test-group">
            <label for="port">Port</label>
            <select id="port">
              <option value="/dev/ttyUSB0" selected>/dev/ttyUSB0</option>
              <option value="/dev/ttyUSB1">/dev/ttyUSB1</option>
              <option value="/dev/ttyS0">/dev/ttyS0</option>
              <option value="/dev/ttyS1">/dev/ttyS1</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="baud-rate">Baud Rate</label>
            <select id="baud-rate">
              <option value="19200" selected>19200</option>
              <option value="9600">9600</option>
              <option value="115200">115200</option>
              <option value="38400">38400</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="parity">Parity</label>
            <select id="parity">
              <option value="N" selected>N</option>
              <option value="E">E</option>
              <option value="O">O</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="stop-bit">Stop Bits</label>
            <select id="stop-bit">
              <option value="1" selected>1</option>
              <option value="2">2</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="bytesize">Byte Size</label>
            <select id="bytesize">
              <option value="8" selected>8</option>
              <option value="7">7</option>
              <option value="6">6</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="timeout">Timeout</label>
            <select id="timeout">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="5">5</option>
            </select>
          </div>

          <!-- 📌 INPUT olarak değiştirildi -->
          <div class="read-test-group">
            <label for="register">Register</label>
            <input type="number" id="register" value="1" min="0" step="1" />
          </div>

          <div class="read-test-group">
            <label for="count">Count</label>
            <input type="number" id="count" value="1" min="1" step="1" />
          </div>

          <div class="read-test-group">
            <label for="slave-id">Slave ID</label>
            <input type="number" id="slave-id" value="3" min="1" step="1" />
          </div>

          <!-- Data Type -->
          <div class="read-test-group">
            <label for="read-data-type">Data Type</label>
            <select id="read-data-type"></select>
          </div>

          <!-- Byte Order -->
          <div class="read-test-group">
            <label for="read-byte-order">Byte Order</label>
            <select id="read-byte-order">
              <option value="little" selected>little</option>
              <option value="big">big</option>
            </select>
          </div>

          <!-- Word Order -->
          <div class="read-test-group">
            <label for="read-word-order">Word Order</label>
            <select id="read-word-order">
              <option value="little" selected>little</option>
              <option value="big">big</option>
            </select>
          </div>
        </div>

        <div class="read-test-footer">
          <button class="read-test-button" onclick="sendModbusRequest()">
            {{ _('Send Modbus Request')}}
          </button>
          <span id="status-message" class="status-message"></span>
          <!-- Durum mesajı için -->
        </div>

        <div class="read-test-terminal">
          <label for="terminal">{{ _('Terminal')}}</label>
          <textarea id="terminal" readonly>
            {{ _('Waiting for response...')}}</textarea
          >
        </div>
      </div>
    </div>

    <!-- Write Test -->
    <div id="write" class="write-test-container tab-content-test">
      <div class="write-test-card">
        <div class="write-test-grid">
          <div class="write-test-group">
            <label for="port">Port</label>
            <select id="port">
              <option value="/dev/ttyUSB0" selected>/dev/ttyUSB0</option>
              <option value="/dev/ttyUSB1">/dev/ttyUSB1</option>
              <option value="/dev/ttyS0">/dev/ttyS0</option>
              <option value="/dev/ttyS1">/dev/ttyS1</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="baud-rate">Baud Rate</label>
            <select id="baud-rate">
              <option value="19200" selected>19200</option>
              <option value="9600">9600</option>
              <option value="115200">115200</option>
              <option value="38400">38400</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="parity">Parity</label>
            <select id="parity">
              <option value="N" selected>N</option>
              <option value="E">E</option>
              <option value="O">O</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="stop-bit">Stop Bits</label>
            <select id="stop-bit">
              <option value="1" selected>1</option>
              <option value="2">2</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="bytesize">Byte Size</label>
            <select id="bytesize">
              <option value="8" selected>8</option>
              <option value="7">7</option>
              <option value="6">6</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="timeout">Timeout</label>
            <select id="timeout">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="5">5</option>
            </select>
          </div>

          <!-- 📌 INPUT olarak değiştirildi -->
          <div class="write-test-group">
            <label for="register">Register</label>
            <input type="number" id="register" value="1" min="0" step="1" />
          </div>

          <!-- Data -->
          <div class="write-test-group">
            <label for="write-data">Data</label>
            <input type="text" id="write-data" placeholder="Enter value" />
          </div>

          <div class="write-test-group">
            <label for="slave-id">Slave ID</label>
            <input type="number" id="slave-id" value="3" min="1" step="1" />
          </div>

          <!-- Data Type -->
          <div class="write-test-group">
            <label for="write-data-type">Data Type</label>
            <select id="write-data-type"></select>
          </div>

          <!-- Byte Order -->
          <div class="write-test-group">
            <label for="write-byte-order">Byte Order</label>
            <select id="write-byte-order">
              <option value="little" selected>little</option>
              <option value="big">big</option>
            </select>
          </div>

          <!-- Word Order -->
          <div class="write-test-group">
            <label for="write-word-order">Word Order</label>
            <select id="write-word-order">
              <option value="little" selected>little</option>
              <option value="big">big</option>
            </select>
          </div>
        </div>

        <div class="write-test-footer">
          <button class="write-test-button" onclick="sendWriteModbusRequest()">
            {{ _('Send Write Request')}}
          </button>
          <span id="write-status-message" class="status-message"></span>
        </div>

        <div class="write-test-terminal">
          <label for="write-terminal">{{ _('Terminal')}}</label>
          <textarea id="write-terminal" readonly>
            {{ _('Waiting for response...')}}</textarea
          >
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // JavaScript for toggling the dropdown and Pop Up password
  document.addEventListener("DOMContentLoaded", function () {
    const wifiList = document.getElementById("wifiList");
    const wifiPopup = document.getElementById("wifiPopup");
    const wifiName = document.getElementById("wifiName");
    const passwordInput = document.getElementById("wifiPassword");
    const showPasswordCheckbox = document.getElementById("showPassword");

    // İlk başta popup'ı kesinlikle gizli yap
    wifiPopup.style.display = "none";

    // Wi-Fi listesinde her öğeye tıklanınca popup aç
    document.querySelectorAll(".wifi-item-test").forEach((item) => {
      item.addEventListener("click", function () {
        const networkName = item.getAttribute("data-wifi");
        wifiName.textContent = networkName;
        passwordInput.value = "";
        wifiPopup.style.display = "flex";
      });
    });

    // Popup kapatma
    window.closeWifiPopup = function () {
      wifiPopup.style.display = "none";
    };

    // Şifre göster/gizle
    showPasswordCheckbox.addEventListener("change", function () {
      passwordInput.type = this.checked ? "text" : "password";
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const wifiPopup = document.getElementById("wifiPopup");
    const wifiName = document.getElementById("wifiName");
    const passwordInput = document.getElementById("wifiPassword");
    const showPasswordCheckbox = document.getElementById("showPassword");
    const joinButton = document.getElementById("joinWifiBtn");

    const networkNameSpan = document.getElementById("wifiNetworkName");
    const passwordSpan = document.getElementById("wifiPasswordDisplay");
    const connectionStatusSpan = document.getElementById(
      "wifiConnectionStatus"
    );
    const macAddressSpan = document.getElementById("wifiMacAddress");
    const wifiSuccess = document.getElementById("wifiSuccess");
    const wifiFailed = document.getElementById("wifiFailed");

    const ethernetStatusSpan = document.getElementById(
      "ethernetConnectionStatus"
    );
    const ethernetMacSpan = document.getElementById("ethernetMacAddress");
    const ethernetSuccess = document.getElementById("ethernetSuccess");
    const ethernetFailed = document.getElementById("ethernetFailed");

    const wifiListContainer = document.getElementById("dynamicWifiList");

    function getNetworkDetails(updateList = false) {
      fetch("/wi-fi-list", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success" && data.data) {
            const connectedSSID = data.data.connected_ssid;
            const macAddress = data.data.wifi_mac;
            const password = data.data.wifi_password;
            const ethernetConnected = data.data.ethernet_connected;
            const ethernetMac = data.data.ethernet_mac;

            if (connectedSSID) {
              networkNameSpan.textContent = connectedSSID;
              passwordSpan.textContent = password
                ? password
                : "{{ _('No Password')}}";
              connectionStatusSpan.textContent = "{{ _('Connected')}}";
              connectionStatusSpan.style.color = "#00C16A";
              macAddressSpan.textContent = macAddress || "{{ _('Unknown')}}";
              wifiSuccess.style.display = "block";
              wifiFailed.style.display = "none";
            } else {
              connectionStatusSpan.textContent = "{{ _('No connection')}}";
              connectionStatusSpan.style.color = "#EF4444";
              wifiSuccess.style.display = "none";
              wifiFailed.style.display = "block";
            }

            // Ethernet Bilgilerini Güncelle
            if (ethernetConnected) {
              ethernetStatusSpan.textContent = "{{ _('Connected')}}";
              ethernetStatusSpan.style.color = "#00C16A";
              ethernetMacSpan.textContent = ethernetMac || "{{ _('Unknown')}}";
              ethernetSuccess.style.display = "block";
              ethernetFailed.style.display = "none";
            } else {
              ethernetStatusSpan.textContent = "{{ _('No connection')}}";
              ethernetStatusSpan.style.color = "#EF4444";
              ethernetSuccess.style.display = "none";
              ethernetFailed.style.display = "block";
            }

            if (updateList)
              updateWifiList(data.data.wifi_networks, connectedSSID);
          }
        })
        .catch((error) =>
          console.error("{{ _('Error fetching network details')}}:", error)
        );
    }

    function updateWifiList(networks, connectedSSID) {
      const wifiListContainer = document.getElementById("dynamicWifiList");
      wifiListContainer.innerHTML = "";

      if (!networks || networks.length === 0) {
        wifiListContainer.innerHTML = `<li>{{ _('No available networks found') }}</li>`;
        return;
      }

      networks.sort((a, b) =>
        a === connectedSSID ? -1 : b === connectedSSID ? 1 : 0
      );

      networks.forEach((ssid) => {
        const isConnected = ssid === connectedSSID ? "wifi-connected" : "";
        const wifiItem = document.createElement("li");

        wifiItem.classList.add(isConnected);
        wifiItem.setAttribute("onclick", `selectWifi('${ssid}')`);
        wifiItem.innerHTML = `
            <img src="/static/images/svg/25.svg" alt="Wi-Fi"/>
            <span>${ssid}</span>
            <img src="/static/images/svg/26.svg" alt="Lock"/>
          `;

        wifiListContainer.appendChild(wifiItem);
      });
    }

    getNetworkDetails(true);

    window.openWifiPopup = function (ssid) {
      wifiName.textContent = ssid;
      passwordInput.value = "";
      wifiPopup.style.display = "flex";
    };

    window.closeWifiPopup = function () {
      wifiPopup.style.display = "none";
    };

    showPasswordCheckbox.addEventListener("change", function () {
      passwordInput.type = this.checked ? "text" : "password";
    });

    joinButton.addEventListener("click", function () {
      const ssid = wifiName.textContent.trim();
      const password = passwordInput.value.trim();

      if (!ssid) {
        Swal.fire({
          icon: "error",
          title: "Wi-Fi Not Selected",
          text: "Please select a Wi-Fi network first!",
        });
        return;
      }

      joinButton.innerHTML = `<span class="spinner"></span> {{ _('Connecting...')}}`;
      joinButton.disabled = true;

      fetch("/connect_wifi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ssid, password }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            Swal.fire({
              icon: "success",
              title: `{{_('Connected!')}}`,
              text: `{{ _('Successfully connected to')}} ${ssid}.`,
            });

            networkNameSpan.textContent = ssid;
            passwordSpan.textContent = password ? password : "No Password";
            connectionStatusSpan.textContent = `{{_('Connected')}}`;
            connectionStatusSpan.style.color = "#00C16A";

            getNetworkDetails(true);
            closeWifiPopup();
          } else {
            Swal.fire({
              icon: "error",
              title: "{{ _('Connection Failed')}}",
              text: data.message || "{{ _('Failed to connect to Wi-Fi.')}}",
            });
            connectionStatusSpan.textContent = "No connection";
            connectionStatusSpan.style.color = "#EF4444";
          }
        })
        .catch((error) => {
          console.error("Error connecting to Wi-Fi:", error);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "An error occurred while connecting to Wi-Fi.",
          });
          connectionStatusSpan.textContent = "No connection";
          connectionStatusSpan.style.color = "#EF4444";
        })
        .finally(() => {
          joinButton.innerHTML = "Join";
          joinButton.disabled = false;
        });
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const tabButtons = document.querySelectorAll(".switch-btn-test");
    const tabContents = document.querySelectorAll(".tab-content-test");

    console.log(document.querySelectorAll(".switch-btn-test"));
    console.log(document.querySelectorAll(".tab-content-test"));

    tabButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");
        console.log(targetId);

        // Tüm içerikleri gizle
        tabContents.forEach((content) => (content.style.display = "none"));

        console.log(tabContents);

        // Tüm butonlardaki "active" sınıfını kaldır
        tabButtons.forEach((btn) => btn.classList.remove("active"));
        console.log(tabButtons);

        // Seçilen butona "active" sınıfı ekle
        this.classList.add("active");

        // İlgili içeriği göster
        const targetElement = document.getElementById(targetId);
        console.log(targetElement);
        if (targetElement) {
          targetElement.style.display = "block";
          console.log(targetElement);
        }
      });
    });

    // Sayfa yüklendiğinde ilk butonu otomatik tıklat
    if (tabButtons.length > 0) {
      tabButtons[0].click();
      console.log(tabButtons[0]);
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    function setCloudConnectionStatus(isConnected) {
      const cloudStatusRow = document.querySelector(
        "tr[data-status='A']:nth-child(1)"
      ); // Cloud Connection satırı
      const statusCells = cloudStatusRow.querySelectorAll(".cloud-test-status");

      statusCells.forEach((cell) => {
        cell.innerHTML = isConnected
          ? '<span class="status-indicator status-green"></span>'
          : '<span class="status-indicator status-red"></span>';
      });
    }

    function updateRabbitMQStatus() {
      fetch("/rabbitmq-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      })
        .then((response) => response.json())
        .then((data) => {
          const rabbitmqStatusRow = document.querySelector(
            "tr[data-status='P']"
          );
          const statusCells =
            rabbitmqStatusRow.querySelectorAll(".cloud-test-status");

          if (data.status === "success" && data.data.rabbitmq_connected) {
            statusCells.forEach((cell) => {
              cell.innerHTML =
                '<span class="status-indicator status-green"></span>';
            });
          } else {
            statusCells.forEach((cell) => {
              cell.innerHTML =
                '<span class="status-indicator status-red"></span>';
            });
          }
        })
        .catch((error) =>
          console.error("Error fetching RabbitMQ status:", error)
        );
    }

    function updateVPNStatus() {
      fetch("/vpn-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      })
        .then((response) => response.json())
        .then((data) => {
          const vpnStatusRow = document.querySelector(
            "tr[data-status='A']:nth-child(3)"
          ); // VPN Port satırı
          const statusCells =
            vpnStatusRow.querySelectorAll(".cloud-test-status");

          if (data.status === "success" && data.data.vpn_connected) {
            statusCells.forEach((cell) => {
              cell.innerHTML =
                '<span class="status-indicator status-green"></span>';
            });
          } else {
            statusCells.forEach((cell) => {
              cell.innerHTML =
                '<span class="status-indicator status-red"></span>';
            });
          }
        })
        .catch((error) => console.error("Error fetching VPN status:", error));
    }

    // 📌 **Cloud varsayılan olarak kırmızı olacak**
    setCloudConnectionStatus(false);

    // 📌 **RabbitMQ ve VPN bağlantılarını kontrol et**
    updateRabbitMQStatus();
    updateVPNStatus();
  });

  document
    .querySelectorAll(
      ".equipment-table tbody tr td:nth-child(3), .equipment-table tbody tr td:nth-child(4)"
    )
    .forEach((td) => {
      let text = td.innerText.trim();

      if (text === "A") {
        td.style.color = "#00C16A";
        td.style.fontWeight = "bold";
      } else if (text === "P") {
        td.style.color = "#ef4444";
        td.style.fontWeight = "bold";
      }
    });

  document.addEventListener("DOMContentLoaded", function () {
    console.log("Page Loaded, Fetching Equipments...");
    fetchEquipments();
  });

  let previousEquipmentData = [];

function startScanning() {
  // Sadece modal gösterimi
  document.getElementById("equipmentModal").style.display = "flex";
  document.getElementById("equipment-loading").style.display = "block";
  document.getElementById("equipment-found-title").style.display = "none";
  document.getElementById("equipment-not-found-message").style.display = "none";
  document.getElementById("equipment-table").style.display = "none";
  document.getElementById("equipment-ok-button").style.display = "none";

  fetch("/get_slave_data", {
    method: "GET",
    headers: { "Content-Type": "application/json" },
  })
    .then((response) => response.json())
    .then((data) => {
      if (
        data.status === "success" &&
        Array.isArray(data.data) &&
        data.data.length > 0
      ) {
        const newEquipments = data.data.filter(
          (item) =>
            !previousEquipmentData.some(
              (prev) =>
                prev.slave_id === item.slave_id &&
                prev.model_name === item.model_name &&
                prev.ip === item.ip
            )
        );

        previousEquipmentData = [...previousEquipmentData, ...newEquipments];

        if (newEquipments.length > 0) {
          showEquipmentModal(newEquipments);
        } else {
          document.getElementById("equipment-loading").style.display = "none";
          document.getElementById("equipment-not-found-message").style.display = "block";
          document.getElementById("equipment-ok-button").style.display = "block";
        }
      } else {
        document.getElementById("equipment-loading").style.display = "none";
        document.getElementById("equipment-not-found-message").style.display = "block";
        document.getElementById("equipment-ok-button").style.display = "block";
      }
    })
    .catch((error) => {
      console.error("Error during scanning:", error);
      document.getElementById("equipment-loading").style.display = "none";
      const msg = document.getElementById("equipment-not-found-message");
      msg.textContent = "Tarama sırasında hata oluştu.";
      msg.style.display = "block";
      msg.style.color = "#ef4444";
      document.getElementById("equipment-ok-button").style.display = "block";
    });
}


function showEquipmentModal(equipments) {
  const modalBody = document.getElementById("modalEquipmentBody");
  modalBody.innerHTML = "";

  equipments.forEach((item) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.model_name || "-"}</td>
      <td>${item.ip || "-"}</td>
      <td>Modbus</td>
    `;
    modalBody.appendChild(row);
  });

  // Tarama tamamlandıktan sonra yükleme kapanır, tablo ve başlık gösterilir
  document.getElementById("equipment-loading").style.display = "none";
  document.getElementById("equipment-not-found-message").style.display = "none";
  document.getElementById("equipment-found-title").style.display = "block";
  document.getElementById("equipment-table").style.display = "table";
  document.getElementById("equipment-ok-button").style.display = "block";
}

function closeEquipmentModal() {
  document.getElementById("equipmentModal").style.display = "none";
}

function addNewDataToTable(newData) {
  console.log("Yeni cihazlar sadece popup'ta gösterilecek...");

  const newEquipments = newData.filter(
    (item) =>
      !previousEquipmentData.some(
        (prev) =>
          prev.slave_id === item.slave_id &&
          prev.model_name === item.model_name &&
          prev.ip === item.ip
      )
  );

  if (newEquipments.length === 0) {
    console.log("Yeni veri bulunamadı.");
    return;
  }

  // ✅ Modal'da yeni cihazları göster
  showEquipmentModal(newEquipments);

  // ✅ Yeni verileri belleğe ekle
  previousEquipmentData = [...previousEquipmentData, ...newEquipments];
}

  function closeEquipmentModal() {
    document.getElementById("equipmentModal").style.display = "none";
  }

  function fetchEquipments() {
    console.log("fetchEquipments() çağrıldı!");
    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

    if (!selectedDeviceIP) {
      console.warn("⚠ No device selected for fetching equipments.");
      document.getElementById("equipment-table-body").innerHTML =
        "<tr><td colspan='6' style='color: #ef4444;'>⚠ No device selected.</td></tr>";
      return;
    }

    fetch("/equipments-with-models", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ip_address: selectedDeviceIP }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Equipment Data Fetched:", data);

        if (
          data.status === "success" &&
          Array.isArray(data.data) &&
          data.data.length > 0
        ) {
          updateEquipmentTable(data.data);
        } else {
          console.warn("No equipments found.");
          document.getElementById("equipment-table-body").innerHTML =
            "<tr><td colspan='6' style='color: #ef4444;'>No equipments found</td></tr>";
        }
      })
      .catch((error) => {
        console.error("Error fetching equipments:", error);
        document.getElementById("equipment-table-body").innerHTML =
          "<tr><td colspan='6' style='color: #ef4444;'>⚠ Error fetching equipments</td></tr>";
      });
  }

  function updateEquipmentTable(equipments) {
    const tableBody = document.getElementById("equipment-table-body");

    if (!equipments || equipments.length === 0) {
      tableBody.innerHTML =
        "<tr><td colspan='6' style='color: #ef4444;'>No equipment found</td></tr>";
      return;
    }

    equipments.forEach((equipment) => {
      const row = document.createElement("tr");
      row.innerHTML = `
         <td>${equipment.model_name || "Unknown"}</td>
         <td>${equipment.modbus_address || "N/A"}</td>
         <td style="color: ${
           equipment.status === "A" ? "#00C16A" : "#ef4444"
         }; font-weight: bold;">
           ${equipment.status}
         </td>
         <td style="color: ${
           equipment.configuration_data === "A" ? "#00C16A" : "#ef4444"
         }; font-weight: bold;">
          ${
            equipment.configuration_data === "A"
              ? "Configured"
              : equipment.configuration_data === "P"
              ? "No Configure"
              : "N/A"
          }
          </td>
         <td>
          ${
            equipment.communication_protocol_code === 1
              ? "SERIAL"
              : equipment.communication_protocol_code === 2
              ? "TCP"
              : "N/A"
          }
          </td>
          <td>${formatDateTime(equipment.created_at)}</td>
        `;
      tableBody.appendChild(row);
    });
  }

  function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return (
      date.toISOString().split("T")[0] + " " + date.toTimeString().split(" ")[0]
    );
  }

  // Read Modbus
  function sendModbusRequest() {
    const terminal = document.getElementById("terminal");
    const statusMessage = document.getElementById("status-message");
    terminal.value = "🔍 Sending Modbus request... Please wait.";
    statusMessage.textContent = "";
    statusMessage.className = "status-message";

    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");
    if (!selectedDeviceIP) {
      terminal.value = "No device selected.";
      statusMessage.textContent = "Local Network Connection Scan Failed.";
      statusMessage.classList.add("error");
      return;
    }

    // Kullanıcıdan inputları al
    const registerValue = parseInt(document.getElementById("register").value);
    const countValue = parseInt(document.getElementById("count").value);
    const slaveIdValue = parseInt(document.getElementById("slave-id").value);

    // 🛠 Hatalı girişleri önlemek için kontroller
    if (isNaN(registerValue) || registerValue < 0) {
      alert("Register address must be a valid number and >= 0");
      return;
    }
    if (isNaN(countValue) || countValue <= 0) {
      alert("Count must be a valid number and greater than 0");
      return;
    }
    if (isNaN(slaveIdValue) || slaveIdValue <= 0) {
      alert("Slave ID must be a valid number and greater than 0");
      return;
    }
    const dataTypeValue = document.getElementById("read-data-type").value;
    const modbusParams = {
      port: document.getElementById("port").value,
      baudrate: parseInt(document.getElementById("baud-rate").value),
      parity: document.getElementById("parity").value,
      stopbits: parseInt(document.getElementById("stop-bit").value),
      bytesize: parseInt(document.getElementById("bytesize").value),
      timeout: parseFloat(document.getElementById("timeout").value),
      address: registerValue,
      count: countValue,
      slave_id: slaveIdValue,
      method: "rtu",
      data_type: dataTypeValue, // 📌 EKLENMESİ GEREKEN SATIR
      byte_order:
        document.getElementById("read-byte-order").value === "big" ? 1 : 0,
      word_order:
        document.getElementById("read-word-order").value === "big" ? 1 : 0,
    };
    console.log(
      "Sending JSON:",
      JSON.stringify({ modbus_params: modbusParams })
    );

    fetch("/validate_modbus", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ modbus_params: modbusParams }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Received Response:", data);

        const innerData = data.data;
        const resultValue = innerData?.data;

        if (
          data.status === "success" &&
          innerData.status === "success" &&
          resultValue !== undefined
        ) {
          terminal.value = `📥 Response: ${resultValue}`;
          statusMessage.textContent = "Modbus request successful.";
          statusMessage.classList.add("success");
        } else {
          terminal.value = `❌ Error: ${innerData?.message || data.message}`;
          statusMessage.textContent = "Modbus request failed.";
          statusMessage.classList.add("error");
        }
      })
      .catch((error) => {
        console.error("Request Failed:", error);
        terminal.value = `Request failed:\n${error}`;
        statusMessage.textContent = "Modbus request failed.";
        statusMessage.classList.add("error");
      });
  }

  // Write Modbus
  function sendWriteModbusRequest() {
    const terminal = document.getElementById("write-terminal");
    const statusMessage = document.getElementById("write-status-message");
    terminal.value = "🔍 Sending Write Modbus request... Please wait.";
    statusMessage.textContent = "";
    statusMessage.className = "status-message";

    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");
    if (!selectedDeviceIP) {
      terminal.value = "No device selected.";
      statusMessage.textContent = "Local Network Connection Scan Failed.";
      statusMessage.classList.add("error");
      return;
    }

    // Kullanıcıdan inputları al
    const registerValue = parseInt(document.getElementById("register").value);
    const countValue = parseInt(document.getElementById("count").value);
    const slaveIdValue = parseInt(document.getElementById("slave-id").value);

    // 🛠 Hatalı girişleri önlemek için kontroller
    if (isNaN(registerValue) || registerValue < 0) {
      alert("Register address must be a valid number and >= 0");
      return;
    }
    if (isNaN(countValue) || countValue <= 0) {
      alert("Count must be a valid number and greater than 0");
      return;
    }
    if (isNaN(slaveIdValue) || slaveIdValue <= 0) {
      alert("Slave ID must be a valid number and greater than 0");
      return;
    }

    const dataTypeValue = document.getElementById("write-data-type").value;
    const writeValue = document.getElementById("write-data").value;

    const modbusParams = {
      port: document.getElementById("port").value,
      baudrate: parseInt(document.getElementById("baud-rate").value),
      parity: document.getElementById("parity").value,
      stopbits: parseInt(document.getElementById("stop-bit").value),
      bytesize: parseInt(document.getElementById("bytesize").value),
      timeout: parseFloat(document.getElementById("timeout").value),
      address: registerValue,
      count: countValue,
      slave_id: slaveIdValue,
      method: "rtu",
      data_type: dataTypeValue, // 📌 EKLENDİ
      data: writeValue, // 📌 Yazılacak veri
      byte_order:
        document.getElementById("write-byte-order").value === "big" ? 1 : 0,
      word_order:
        document.getElementById("write-word-order").value === "big" ? 1 : 0,
    };

    console.log(
      "Sending JSON:",
      JSON.stringify({ modbus_params: modbusParams })
    );

    fetch("/validate_modbus", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ modbus_params: modbusParams }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Received Response:", data);

        const innerData = data.data;
        const resultValue = innerData?.data;

        if (
          data.status === "success" &&
          innerData.status === "success" &&
          resultValue !== undefined
        ) {
          terminal.value = `📥 Response: ${resultValue}`;
          statusMessage.textContent = "Modbus request successful.";
          statusMessage.classList.add("success");
        } else {
          terminal.value = `❌ Error: ${innerData?.message || data.message}`;
          statusMessage.textContent = "Modbus request failed.";
          statusMessage.classList.add("error");
        }
      })
      .catch((error) => {
        console.error("Request Failed:", error);
        terminal.value = `Request failed:\n${error}`;
        statusMessage.textContent = "Modbus request failed.";
        statusMessage.classList.add("error");
      });
  }

  // Sayfa yüklendiğinde select'leri doldur
  document.addEventListener("DOMContentLoaded", () => {
    const readSelect = document.getElementById("read-data-type");
    const writeSelect = document.getElementById("write-data-type");

    // Data types
    const dataTypes = {
      read: [
        "int16",
        "uint16",
        "int32",
        "uint32",
        "int64",
        "uint64",
        "float16",
        "float32",
        "float64",
        "unix_time32",
        "string",
        "hexadecimal",
        "numeric",
      ],
      write: [
        "from_int16",
        "from_uint16",
        "from_int32",
        "from_uint32",
        "from_int64",
        "from_uint64",
        "from_float16",
        "from_float32",
        "from_float64",
        "from_unix_time32",
      ],
    };

    // Read tiplerini doldur
    dataTypes.read.forEach((type) => {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type;
      readSelect.appendChild(option);
    });

    // Write tiplerini doldur
    dataTypes.write.forEach((type) => {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type;
      writeSelect.appendChild(option);
    });
  });

  // Cloud Status
  document.addEventListener("DOMContentLoaded", function () {
    function updateCloudStatus() {
      fetch("/cloud-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      })
        .then((response) => response.json())
        .then((data) => {
          const cloudStatusRow = document.querySelector("tr[data-status='A']");
          const statusCells =
            cloudStatusRow.querySelectorAll(".cloud-test-status");
          const lastConnectionCell = cloudStatusRow.children[3]; // 4. sütundaki tarih güncellenecek

          statusCells.forEach((cell) => {
            cell.innerHTML = `<span class="status-indicator"></span>`; // Önce temizle

            const indicator = cell.querySelector(".status-indicator");

            if (data.status === "success" && data.data.cloud_connected) {
              indicator.classList.add("status-green"); // Yeşil yap
              lastConnectionCell.textContent =
                data.data.last_connection_time || "No connection yet";
            } else {
              indicator.classList.add("status-red"); // Kırmızı yap
              lastConnectionCell.textContent = "No connection yet";
            }
          });
        })
        .catch(() => {
          console.error("Cloud connection check failed.");
        });
    }

    // Sayfa yüklendiğinde kontrol et
    updateCloudStatus();

    // Bulut bağlantısını her 10 saniyede bir kontrol et
    setInterval(updateCloudStatus, 10000);
  });
</script>

<style>
  .connected-wifi {
    font-weight: bold;
    color: #00c16a;
  }

  .popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(2px);
    background: rgba(255, 255, 255, 0.05);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .popup-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
  }

  .popup-content {
    background: #0b1734;
    color: white;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #ef8018;
  }

  .popup-content table {
    margin: 0 auto;
    text-align: center;
  }

  .popup-content th {
    text-align: center;
  }

  .spinner {
    display: inline-block;
    width: 30px;
    height: 30px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 5px;
    vertical-align: middle;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .equipment-table {
    width: 100%;
    border-collapse: collapse;
    background: #0b1734;
    border-radius: 6px;
    overflow: hidden;
    font-size: 14px;
  }

  .equipment-table th,
  .equipment-table td {
    border: none;
    padding: 10px;
    text-align: center;
    color: #fff;
  }

  .equipment-table th {
    background: #0b1734;
    font-weight: bold;
    color: #ef8018;
    border-bottom: 1px solid #ffffff;
  }

  .equipment-table td {
    border-bottom: 1px solid #ef8018;
  }

  .equipment-table tbody tr:last-child td {
    border-bottom: none;
  }

  .status-message {
    margin-left: 10px;
  }

  .success {
    color: limegreen;
    font-size: 14px;
  }

  .error {
    color: #ef4444;
    font-size: 14px;
  }

  .equipment-scan-btn {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 13px;
    font-size: 16px;
    border: none;
    background-color: #ef8018;
    color: white;
    cursor: pointer;
    transition: background 0.3s;
    margin-top: 11px;
    width: 300px;
    border-radius: 3px;
    font-weight: 600;
  }
  .loader {
    width: 14px;
    height: 14px;
    border: 2px solid transparent;
    border-radius: 50%;
    border-top: 2px solid white;
    animation: spin 1s linear infinite;
    margin: 0;
    margin-left: 10px;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .new-equipment-separator {
    text-align: center;
    font-weight: bold;
    color: #ef8018;
  }

  .status-static {
    color: #ef4444 !important;
    font-weight: bold;
  }

  div:where(.swal2-container) h2:where(.swal2-title) {
    padding: 0em 1em 0;
  }

  div:where(.swal2-container) div:where(.swal2-actions) {
    margin: 0.25em auto 0;
  }

  div:where(.swal2-container) div:where(.swal2-html-container) {
    padding: 0.5em 0.5em 0.1em;
  }

  div:where(.swal2-container) div:where(.swal2-popup) {
    width: 27em;
    font-size: 0.9rem;
  }

  div:where(.swal2-icon) {
    margin: 1.1em auto 0.4em;
  }

  .status-indicator {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    display: inline-block;
    border: 2px solid transparent;
  }

  .status-green {
    border-color: #00c16a;
  }

  .status-red {
    border-color: #ef4444;
  }
</style>

{% endblock %}
