{% extends "layout.html" %} {% block title %} Test Details {% endblock %} {%
block content %}
<!-- Header -->
{% include 'partials/header.html' %}

<!-- Yeni İçerik (İlk başta gizli olacak) -->
<div class="test-switch-content">
  <div class="test-sidebar-switch">
    <button class="switch-btn-test" data-target="wifi-test">
      Wifi / Ethernet Connection Test
    </button>
    <button class="switch-btn-test" data-target="equipment-test">
      Equipment
    </button>
    <button class="switch-btn-test" data-target="cloud-test">
      Cloud Connection Test
    </button>
    <button class="switch-btn-test" data-target="read">Read</button>
    <button class="switch-btn-test" data-target="write">Write</button>
  </div>

  <div class="switch-content-area">
    <!-- Wi-Fi Test -->
    <div id="wifi-test" class="tab-content-test">
      <div class="wifi-container-test">
        <!-- Available Wi-Fi -->
        <div class="network-box-test">
          <button class="network-header-test" id="wifiToggleBtn">
            Available Wi-Fi
            <span class="wifi-icon-test">
              <img
                src="{{ url_for('static', filename='images/svg/12.svg') }}"
                alt="Wi-Fi Icon"
              />
            </span>
          </button>

          <div class="wifi-list-test" id="wifiList">
            <div class="wifi-category-test">Other Networks</div>
            <div id="dynamicWifiList">
              <p>Loading available networks...</p>
            </div>
          </div>
        </div>

        <!-- Wi-Fi Şifre Giriş Popup -->
        <div id="wifiPopup" class="popup-overlay" style="display: none">
          <div class="popup-content">
            <h3>
              <img
                src="{{ url_for('static', filename='images/svg/12.svg') }}"
                alt="Wi-Fi"
              />
              Enter the Wi-Fi password for '<span id="wifiName"></span>'
            </h3>
            <label for="wifiPassword">Password</label>
            <input type="password" id="wifiPassword" placeholder="Password" />
            <div class="text-show-pass">
              <input type="checkbox" id="showPassword" /> Show Password
            </div>
            <div class="popup-buttons">
              <button class="cancel-btn" onclick="closeWifiPopup()">
                Cancel
              </button>
              <button id="joinWifiBtn" class="join-btn">Join</button>
            </div>
          </div>
        </div>

        <!-- Wi-Fi Bölümü  -->
        <div class="wifi-test-box">
          <!-- Network Name -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">Network Name</label>
            <span class="wifi-test-value" id="wifiNetworkName">-</span>
          </div>

          <!-- Password -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">Password</label>
            <span class="wifi-test-value" id="wifiPassword">-</span>
          </div>

          <!-- Connection Status -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">Connection Status</label>
            <span class="wifi-test-value" id="wifiConnectionStatus"
              >No connection</span
            >
          </div>

          <!-- Connection Mac -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">Connection Mac</label>
            <span class="wifi-test-value" id="wifiMacAddress">-</span>
          </div>

          <!-- Test Button ve WiFi Status -->
          <div class="wifi-test-action">
            <button class="wifi-test-btn">Test</button>
            <div style="display: flex; flex-direction: column; gap: 5px">
              <span class="wifi-success">
                <img
                  src="{{ url_for('static', filename='images/svg/13.svg') }}"
                  alt="No Wi-Fi"
                  class="ethernet-icon"
                />
                WiFi Connection Successful.
              </span>
              <span class="wifi-failed">
                <img
                  src="{{ url_for('static', filename='images/svg/14.svg') }}"
                  alt="No Wi-Fi"
                  class="ethernet-icon"
                />
                WiFi Connection Failed.
              </span>
            </div>
          </div>
        </div>
        
      </div>

      <!--Burada bir beyaz çizgi geçmeli -->
      <div class="white-line-break"></div>

      <!-- Ethernet Bölümü -->
      <div id="ethernet-test">
        <div class="ethernet-container-test">
          <!-- Available Wi-Fi -->
          <div class="ethernet-box-test">
            <img
              src="{{ url_for('static', filename='images/svg/24.svg') }}"
              alt="No Wi-Fi"
              class="ethernet-icon"
            />
            <span class="ethernet-text">Ethernet</span>
          </div>

          <!--Ethernet Test Paneli -->
          <div class="ethernet-test-box">
            <!-- Connection Status -->
            <div class="ethernet-test-row">
              <label class="ethernet-test-label">Connection Status</label>
              <span class="ethernet-test-value">Connected / No connection</span>
            </div>

            <!-- Connection Mac -->
            <div class="ethernet-test-row">
              <label class="ethernet-test-label">Connection Mac</label>
              <span class="ethernet-test-value">02:81:2b:61:c6:1d</span>
            </div>

            <!-- Test Button ve Ethernet Status -->
            <div class="ethernet-test-action">
              <button class="ethernet-test-btn">Test</button>
              <div style="display: flex; flex-direction: column; gap: 5px">
                <span class="ethernet-success"
                  ><img
                    src="{{ url_for('static', filename='images/svg/15.svg') }}"
                    alt="No Wi-Fi"
                    class="ethernet-icon"
                  />
                  WiFi Connection Successful.</span
                >
                <span class="ethernet-failed"
                  ><img
                    src="{{ url_for('static', filename='images/svg/16.svg') }}"
                    alt="No Wi-Fi"
                    class="ethernet-icon"
                  />
                  WiFi Connection Failed.</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Equipment Test -->
    <div id="equipment-test" class="tab-content-test">
      <div class="equipment-test-container">
        <div class="equipment-test-card">
          <!-- Tablonun Başlangıcı -->
          <table class="equipment-table">
            <thead>
              <tr>
                <th>Serial number</th>
                <th>SID/IP</th>
                <th>Status / Configuration</th>
                <th>Connection</th>
                <th>Connection Protocol</th>
                <th>Equipment Date / Connection Date</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>EMR-53C9@3630748023</td>
                <td>5</td>
                <td>A / A</td>
                <td>OK</td>
                <td>Modbus</td>
                <td>2024-04-01 10:43:19</td>
              </tr>
              <tr>
                <td>EMR-53C9@3630748023</td>
                <td>192.168.1.147</td>
                <td>A / A</td>
                <td>OK</td>
                <td>Modbus</td>
                <td>2024-04-01 10:43:19</td>
              </tr>
              <tr>
                <td>MPR-45C9@2931</td>
                <td>5</td>
                <td>A / A</td>
                <td>OK</td>
                <td>TCP / IP</td>
                <td>2024-04-01 10:43:19</td>
              </tr>
              <tr>
                <td>MPR-45C9@2931</td>
                <td>192.168.1.147</td>
                <td>A / A</td>
                <td>OK</td>
                <td>TCP / IP</td>
                <td>2024-04-01 10:43:19</td>
              </tr>
              <tr>
                <td>MPR-45C9@2931</td>
                <td>5</td>
                <td>A / A</td>
                <td>OK</td>
                <td>TCP / IP</td>
                <td>2024-04-01 10:43:19</td>
              </tr>
              <tr>
                <td>MPR-45C9@2931</td>
                <td>192.168.1.147</td>
                <td>A / A</td>
                <td>OK</td>
                <td>TCP / IP</td>
                <td>2024-04-01 10:43:19</td>
              </tr>
              <tr>
                <td>MPR-45C9@2931</td>
                <td>5</td>
                <td>A / A</td>
                <td>OK</td>
                <td>TCP / IP</td>
                <td>2024-04-01 10:43:19</td>
              </tr>
              <tr>
                <td>MPR-45C9@2931</td>
                <td>192.168.1.147</td>
                <td>A / A</td>
                <td>OK</td>
                <td>TCP / IP</td>
                <td>2024-04-01 10:43:19</td>
              </tr>
            </tbody>
          </table>
          <!-- Tablonun Sonu -->

          <!-- Butonlar ve Durum Bilgileri -->
          <div class="equipment-actions">
            <div class="equipment-scan-status">
              <button class="equipment-scan-btn">
                Perform a scanning test
              </button>
              <span class="equipment-scan-success"
                >Local Network Connection Scan Successful.</span
              >
              <span class="equipment-scan-failed"
                >Local Network Connection Scan Failed.</span
              >
            </div>
            <button class="equipment-update-btn">
              Update the equipment table with the equipment found during
              scanning
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cloud Connection Test -->
    <div id="cloud-test" class="cloud-test-container tab-content-test">
      <div class="cloud-test-card">
        <table class="cloud-test-table">
          <thead>
            <tr>
              <th>Archive</th>
              <th>End</th>
              <th>Connection</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr data-status="A">
              <td class="cloud-test-status"></td>
              <td class="cloud-test-status"></td>
              <td>Cloud connection</td>
              <td>2024-04-03 13:55:00</td>
            </tr>
            <tr data-status="P">
              <td class="cloud-test-status"></td>
              <td class="cloud-test-status"></td>
              <td>Rabbit Mq</td>
              <td>2024-04-03 13:55:11</td>
            </tr>
            <tr data-status="A">
              <td class="cloud-test-status"></td>
              <td class="cloud-test-status"></td>
              <td>VPN Port</td>
              <td>2024-04-03 13:55:14</td>
            </tr>
          </tbody>
        </table>
        <p class="cloud-test-info">
          *Does the ORC have connection with cloud and other devices or not?
        </p>

        <!-- Buton ve Yazıları Yan Yana Düzenleme -->
        <div class="cloud-test-footer">
          <button class="cloud-test-button">Perform a scanning test</button>
          <div class="cloud-test-status-text">
            <p class="cloud-test-success">
              Local Network Connection Scan Successful.
            </p>
            <p class="cloud-test-failed">
              Local Network Connection Scan Failed.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Read Test -->
    <div id="read" class="read-test-container tab-content-test">
      <div class="read-test-card">
        <div class="read-test-grid">
          <div class="read-test-group">
            <label for="port">Port</label>
            <input type="text" id="port" value="/dev/ttyUSB0" readonly />
          </div>
          <div class="read-test-group">
            <label for="baud-rate">Baud Rate</label>
            <input type="text" id="baud-rate" value="9600" readonly />
          </div>
          <div class="read-test-group">
            <label for="parity">Parity</label>
            <input type="text" id="parity" value="None" readonly />
          </div>
          <div class="read-test-group">
            <label for="stop-bit">Stop Bit</label>
            <input type="text" id="stop-bit" value="8" readonly />
          </div>
          <div class="read-test-group">
            <label for="register">Register</label>
            <input type="text" id="register" value="8" readonly />
          </div>
          <div class="read-test-group">
            <label for="count">Count</label>
            <input type="text" id="count" value="8" readonly />
          </div>
          <div class="read-test-group">
            <label for="data-type">Data Type</label>
            <input type="text" id="data-type" value="uint32" readonly />
          </div>
        </div>

        <div class="read-test-footer">
          <button class="read-test-button">Perform a scanning test</button>
          <div class="read-test-status">
            <p class="read-test-success">
              Local Network Connection Scan Successful.
            </p>
            <p class="read-test-failed">
              Local Network Connection Scan Failed.
            </p>
          </div>
        </div>

        <div class="read-test-terminal">
          <label for="terminal">Terminal</label>
          <textarea id="terminal" readonly>/dev/ttyUSB0</textarea>
        </div>
      </div>
    </div>

    <!-- Write Test -->
    <div id="write" class="write-test-container tab-content-test">
      <div class="write-test-card">
        <div class="write-test-grid">
          <div class="write-test-group">
            <label for="port">Port</label>
            <input type="text" id="port" value="/dev/ttyUSB0" readonly />
          </div>
          <div class="write-test-group">
            <label for="baud-rate">Baud Rate</label>
            <input type="text" id="baud-rate" value="9600" readonly />
          </div>
          <div class="write-test-group">
            <label for="parity">Parity</label>
            <input type="text" id="parity" value="None" readonly />
          </div>
          <div class="write-test-group">
            <label for="stop-bit">Stop Bit</label>
            <input type="text" id="stop-bit" value="8" readonly />
          </div>
          <div class="write-test-group">
            <label for="register">Register</label>
            <input type="text" id="register" value="8" readonly />
          </div>
          <div class="write-test-group">
            <label for="count">Count</label>
            <input type="text" id="count" value="8" readonly />
          </div>
          <div class="write-test-group">
            <label for="data-type">Data Type</label>
            <input type="text" id="data-type" value="uint32" readonly />
          </div>
        </div>

        <div class="write-test-footer">
          <button class="write-test-button">Perform a scanning test</button>
          <div class="write-test-status">
            <p class="write-test-success">
              Local Network Connection Scan Successful.
            </p>
            <p class="write-test-failed">
              Local Network Connection Scan Failed.
            </p>
          </div>
        </div>

        <div class="write-test-terminal">
          <label for="terminal">Terminal</label>
          <textarea id="terminal" readonly>
Write successful Read value: sadfasd</textarea
          >
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // JavaScript for toggling the dropdown and Pop Up password
  document.addEventListener("DOMContentLoaded", function () {
    const wifiToggleBtn = document.getElementById("wifiToggleBtn");
    const wifiList = document.getElementById("wifiList");
    const wifiPopup = document.getElementById("wifiPopup");
    const wifiName = document.getElementById("wifiName");
    const passwordInput = document.getElementById("wifiPassword");
    const showPasswordCheckbox = document.getElementById("showPassword");

    // İlk başta popup'ı kesinlikle gizli yap
    wifiPopup.style.display = "none";

    // Wi-Fi listesi aç/kapa
    wifiToggleBtn.addEventListener("click", function () {
      wifiList.style.display =
        wifiList.style.display === "block" ? "none" : "block";
    });

    // Wi-Fi listesinde her öğeye tıklanınca popup aç
    document.querySelectorAll(".wifi-item-test").forEach((item) => {
      item.addEventListener("click", function () {
        const networkName = item.getAttribute("data-wifi");
        wifiName.textContent = networkName;
        passwordInput.value = "";
        wifiPopup.style.display = "flex"; // Popup aç
      });
    });

    // Popup kapatma
    window.closeWifiPopup = function () {
      wifiPopup.style.display = "none";
    };

    // Şifre göster/gizle
    showPasswordCheckbox.addEventListener("change", function () {
      passwordInput.type = this.checked ? "text" : "password";
    });
  });
  document.addEventListener("DOMContentLoaded", function () {
    const wifiPopup = document.getElementById("wifiPopup");
    const wifiName = document.getElementById("wifiName");
    const passwordInput = document.getElementById("wifiPassword");
    const showPasswordCheckbox = document.getElementById("showPassword");
    const joinButton = document.getElementById("joinWifiBtn");

    const networkNameSpan = document.getElementById("wifiNetworkName");
    const passwordSpan = document.getElementById("wifiPasswordDisplay");
    const connectionStatusSpan = document.getElementById("wifiConnectionStatus");
    const macAddressSpan = document.getElementById("wifiMacAddress");

    function getWifiDetails() {
        fetch("/wi-fi-list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success" && data.data) {
                const connectedSSID = data.data.connected_ssid;
                const macAddress = data.data.wifi_mac;

                if (connectedSSID) {
                    networkNameSpan.textContent = connectedSSID;
                    passwordSpan.textContent = "••••••";
                    connectionStatusSpan.textContent = "Connected";
                    connectionStatusSpan.style.color = "green";
                    macAddressSpan.textContent = macAddress || "Unknown";
                } else {
                    connectionStatusSpan.textContent = "No connection";
                    connectionStatusSpan.style.color = "red";
                }
            }
        })
        .catch(error => console.error("Error fetching Wi-Fi details:", error));
    }

    getWifiDetails();

    window.openWifiPopup = function (ssid) {
        wifiName.textContent = ssid;
        passwordInput.value = "";
        wifiPopup.style.display = "flex";
    };

    window.closeWifiPopup = function () {
        wifiPopup.style.display = "none";
    };

    showPasswordCheckbox.addEventListener("change", function () {
        passwordInput.type = this.checked ? "text" : "password";
    });

    joinButton.addEventListener("click", function () {
        const ssid = wifiName.textContent.trim();
        const password = passwordInput.value.trim();

        if (!ssid) {
            Swal.fire({ icon: "error", title: "Wi-Fi Not Selected", text: "Please select a Wi-Fi network first!" });
            return;
        }

        joinButton.innerHTML = `<span class="spinner"></span> Connecting...`;
        joinButton.disabled = true;

        fetch("/connect_wifi", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ssid, password }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                Swal.fire({ icon: "success", title: "Connected!", text: `Successfully connected to ${ssid}.` });
                networkNameSpan.textContent = ssid;
                passwordSpan.textContent = password ? "••••••" : "No Password";
                connectionStatusSpan.textContent = "Connected";
                connectionStatusSpan.style.color = "green";

                getWifiDetails();
                closeWifiPopup();
            } else {
                Swal.fire({ icon: "error", title: "Connection Failed", text: data.message || "Failed to connect to Wi-Fi." });
                connectionStatusSpan.textContent = "No connection";
                connectionStatusSpan.style.color = "red";
            }
        })
        .catch(error => {
            console.error("Error connecting to Wi-Fi:", error);
            Swal.fire({ icon: "error", title: "Error", text: "An error occurred while connecting to Wi-Fi." });
            connectionStatusSpan.textContent = "No connection";
            connectionStatusSpan.style.color = "red";
        })
        .finally(() => {
            joinButton.innerHTML = "Join";
            joinButton.disabled = false;
        });
    });

    document.getElementById("wifiToggleBtn").addEventListener("click", function () {
        fetch("/wi-fi-list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            const wifiList = document.getElementById("dynamicWifiList");
            wifiList.innerHTML = "";

            if (data.status === "success" && data.data && data.data.wifi_networks) {
                let networks = data.data.wifi_networks;
                let connectedSSID = data.data.connected_ssid;

                networks.sort((a, b) => (a === connectedSSID ? -1 : b === connectedSSID ? 1 : 0));

                networks.forEach(wifi => {
                    const wifiItem = document.createElement("div");
                    wifiItem.classList.add("wifi-item-test");
                    wifiItem.dataset.wifi = wifi;

                    if (wifi === connectedSSID) wifiItem.classList.add("connected-wifi");

                    wifiItem.innerHTML = `
                        <div class="wifi-name-test">
                            <span><img src="/static/images/svg/25.svg" alt="Wi-Fi"></span>
                            ${wifi}
                            <img src="/static/images/svg/26.svg" alt="Wi-Fi">
                        </div>`;

                    wifiItem.addEventListener("click", function () { openWifiPopup(wifi); });

                    wifiList.appendChild(wifiItem);
                });
            } else {
                wifiList.innerHTML = "<p>No available networks found.</p>";
            }
        })
        .catch(error => console.error("Error fetching Wi-Fi list:", error));
    });
});


  document.addEventListener("DOMContentLoaded", function () {
    const tabButtons = document.querySelectorAll(".switch-btn-test");
    const tabContents = document.querySelectorAll(".tab-content-test");

    console.log(document.querySelectorAll(".switch-btn-test"));
    console.log(document.querySelectorAll(".tab-content-test"));

    tabButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");
        console.log(targetId);

        // Tüm içerikleri gizle
        tabContents.forEach((content) => (content.style.display = "none"));

        console.log(tabContents);

        // Tüm butonlardaki "active" sınıfını kaldır
        tabButtons.forEach((btn) => btn.classList.remove("active"));
        console.log(tabButtons);

        // Seçilen butona "active" sınıfı ekle
        this.classList.add("active");

        // İlgili içeriği göster
        const targetElement = document.getElementById(targetId);
        console.log(targetElement);
        if (targetElement) {
          targetElement.style.display = "block";
          console.log(targetElement);
        }
      });
    });

    // Sayfa yüklendiğinde ilk butonu otomatik tıklat
    if (tabButtons.length > 0) {
      tabButtons[0].click();
      console.log(tabButtons[0]);
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("tr[data-status]").forEach((row) => {
      const status = row.getAttribute("data-status");
      row.querySelectorAll(".cloud-test-status").forEach((cell) => {
        cell.innerHTML =
          status === "A"
            ? '<span class="status-indicator status-green"></span>'
            : '<span class="status-indicator status-red"></span>';
      });
    });
  });

  document
    .querySelectorAll(
      ".equipment-table tbody tr td:nth-child(3), .equipment-table tbody tr td:nth-child(4)"
    )
    .forEach((td) => {
      let text = td.innerText.trim();

      if (text === "A / A" || text === "OK") {
        td.style.color = "green";
        td.style.fontWeight = "bold";
      }

      if (text === "No") {
        td.style.color = "red";
        td.style.fontWeight = "bold";
      }
    });
</script>

<style>
  .connected-wifi {
    font-weight: bold;
    color: green;
  }

  .popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .popup-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
  }

  .popup-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
  }

  .spinner {
    display: inline-block;
    width: 13px;
    height: 13px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 5px;
    vertical-align: middle;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %}
