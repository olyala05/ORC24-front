{% extends "layout.html" %} {% block title %} Test Details {% endblock %} {%
block content %}
<!-- Header -->
{% include 'partials/header.html' %}

<!-- Yeni İçerik (İlk başta gizli olacak) -->
<div class="test-switch-content">
  <!-- Sidebar Buttons -->
  <div class="test-sidebar-switch">
    <button class="switch-btn-test" data-target="wifi-test">
      Wifi / Ethernet Connection Test
    </button>
    <button class="switch-btn-test" data-target="equipment-test">
      Equipment
    </button>
    <button class="switch-btn-test" data-target="cloud-test">
      Cloud Connection Test
    </button>
    <button class="switch-btn-test" data-target="read">Read</button>
    <button class="switch-btn-test" data-target="write">Write</button>
  </div>

  <div class="switch-content-area">
    <!-- Wi-Fi Test -->
    <div id="wifi-test" class="tab-content-test">
      <div class="wifi-container-test">
        <!-- Available Wi-Fi -->
        <div class="network-box-test">
          <button class="network-header-test" id="wifiToggleBtn">
            Available Wi-Fi
            <span class="wifi-icon-test">
              <img
                src="{{ url_for('static', filename='images/svg/12.svg') }}"
                alt="Wi-Fi Icon"
              />
            </span>
          </button>

          <div class="wifi-list-test" id="wifiList">
            <div class="wifi-category-test">Other Networks</div>
            <div id="dynamicWifiList">
              <p>Loading available networks...</p>
            </div>
          </div>
        </div>

        <!-- Wi-Fi Şifre Giriş Popup -->
        <div id="wifiPopup" class="popup-overlay" style="display: none">
          <div class="popup-content">
            <h3>
              <img
                src="{{ url_for('static', filename='images/svg/12.svg') }}"
                alt="Wi-Fi"
              />
              Enter the Wi-Fi password for '<span id="wifiName"></span>'
            </h3>
            <label for="wifiPassword">Password</label>
            <input type="password" id="wifiPassword" placeholder="Password" />
            <div class="text-show-pass">
              <input type="checkbox" id="showPassword" /> Show Password
            </div>
            <div class="popup-buttons">
              <button class="cancel-btn" onclick="closeWifiPopup()">
                Cancel
              </button>
              <button id="joinWifiBtn" class="join-btn">Join</button>
            </div>
          </div>
        </div>

        <!-- Wi-Fi Bölümü -->
        <div class="wifi-test-box">
          <!-- Network Name -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">Network Name</label>
            <span class="wifi-test-value" id="wifiNetworkName">-</span>
          </div>

          <!-- Password -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">Password</label>
            <span class="wifi-test-value" id="wifiPasswordDisplay">-</span>
          </div>

          <!-- Connection Status -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">Connection Status</label>
            <span class="wifi-test-value" id="wifiConnectionStatus"
              >No connection</span
            >
          </div>

          <!-- Connection Mac -->
          <div class="wifi-test-row">
            <label class="wifi-test-label">Connection Mac</label>
            <span class="wifi-test-value" id="wifiMacAddress">-</span>
          </div>

          <!-- Test Button ve WiFi Status -->
          <div class="wifi-test-action">
            <button class="wifi-test-btn">Test</button>
            <div style="display: flex; flex-direction: column; gap: 5px">
              <span class="wifi-success" id="wifiSuccess" style="display: none">
                <img
                  src="{{ url_for('static', filename='images/svg/13.svg') }}"
                  alt="No Wi-Fi"
                  class="ethernet-icon"
                />
                WiFi Connection Successful.
              </span>
              <span class="wifi-failed" id="wifiFailed" style="display: none">
                <img
                  src="{{ url_for('static', filename='images/svg/14.svg') }}"
                  alt="No Wi-Fi"
                  class="ethernet-icon"
                />
                WiFi Connection Failed.
              </span>
            </div>
          </div>
        </div>
      </div>

      <!--Burada bir beyaz çizgi geçmeli -->
      <div class="white-line-break"></div>

      <!-- Ethernet Bölümü -->
      <div id="ethernet-test">
        <div class="ethernet-container-test">
          <!-- Ethernet Box -->
          <div class="ethernet-box-test">
            <img
              src="{{ url_for('static', filename='images/svg/24.svg') }}"
              alt="No Wi-Fi"
              class="ethernet-icon"
            />
            <span class="ethernet-text">Ethernet</span>
          </div>

          <!-- Ethernet Test Paneli -->
          <div class="ethernet-test-box">
            <!-- Connection Status -->
            <div class="ethernet-test-row">
              <label class="ethernet-test-label">Connection Status</label>
              <span id="ethernetConnectionStatus" class="ethernet-test-value"
                >No connection</span
              >
            </div>

            <!-- Connection Mac -->
            <div class="ethernet-test-row">
              <label class="ethernet-test-label">Connection Mac</label>
              <span id="ethernetMacAddress" class="ethernet-test-value">-</span>
            </div>

            <!-- Test Button ve Ethernet Status -->
            <div class="ethernet-test-action">
              <button id="testEthernetBtn" class="ethernet-test-btn">
                Test
              </button>
              <div style="display: flex; flex-direction: column; gap: 5px">
                <span
                  id="ethernetSuccess"
                  class="ethernet-success"
                  style="display: none"
                >
                  <img
                    src="{{ url_for('static', filename='images/svg/15.svg') }}"
                    alt="Ethernet Connected"
                    class="ethernet-icon"
                  />
                  Ethernet Connection Successful.
                </span>
                <span
                  id="ethernetFailed"
                  class="ethernet-failed"
                  style="display: none"
                >
                  <img
                    src="{{ url_for('static', filename='images/svg/16.svg') }}"
                    alt="Ethernet Disconnected"
                    class="ethernet-icon"
                  />
                  Ethernet Connection Failed.
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Equipment Test -->
    <div id="equipment-test" class="tab-content-test">
      <div class="equipment-test-container">
        <div class="equipment-test-card">
          <!-- Tablonun Başlangıcı -->
          <table class="equipment-table">
            <thead>
              <tr>
                <th>Serial Number</th>
                <th>SID/IP</th>
                <th>Status</th>
                <th>Configuration Connection</th>
                <th>Connection Protocol</th>
                <th>Equipment Date / Connection Date</th>
              </tr>
            </thead>
            <tbody id="equipment-table-body">
              <!-- Dinamik veriler buraya eklenecek -->
            </tbody>
          </table>
          <!-- Tablonun Sonu -->

          <!-- Butonlar ve Durum Bilgileri -->
          <div class="equipment-actions">
            <div class="equipment-scan-status">
              <button
                class="equipment-scan-btn"
                onclick="startScanning()"
                id="scan-btn"
              >
                Perform a scanning test
                <span
                  id="scan-spinner"
                  class="loader"
                  style="display: none"
                ></span>
              </button>
              <span id="scan-status" style="display: none; color: green">
                Scanning in progress...
              </span>
            </div>
            <button class="equipment-update-btn" onclick="fetchEquipments()">
              Update the equipment table with the equipment found during
              scanning
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cloud Connection Test -->
    <div id="cloud-test" class="cloud-test-container tab-content-test">
      <div class="cloud-test-card">
        <table class="cloud-test-table">
          <thead>
            <tr>
              <th>Archive</th>
              <th>End</th>
              <th>Connection</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr data-status="A">
              <td class="cloud-test-status"></td>
              <td class="cloud-test-status"></td>
              <td>Cloud connection</td>
              <td>2024-04-03 13:55:00</td>
            </tr>
            <tr data-status="P">
              <td class="cloud-test-status"></td>
              <td class="cloud-test-status"></td>
              <td>Rabbit MQ</td>
              <!-- Bağlıysa yeşil, değilse kırmızı olacak -->
              <td>2024-04-03 13:55:11</td>
            </tr>
            <tr data-status="A">
              <td class="cloud-test-status"></td>
              <td class="cloud-test-status"></td>
              <td>VPN Port</td>
              <td>2024-04-03 13:55:14</td>
            </tr>
          </tbody>
        </table>
        <p class="cloud-test-info">
          *Does the ORC have connection with cloud and other devices or not?
        </p>

        <!-- Buton ve Yazıları Yan Yana Düzenleme -->
        <div class="cloud-test-footer">
          <button class="cloud-test-button" onclick="updateRabbitMQStatus()">
            Perform a scanning test
          </button>
          <div class="cloud-test-status-text">
            <p class="cloud-test-success">
              Local Network Connection Scan Successful.
            </p>
            <p class="cloud-test-failed">
              Local Network Connection Scan Failed.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Read Test -->
    <div id="read" class="read-test-container tab-content-test">
      <div class="read-test-card">
        <div class="read-test-grid">
          <div class="read-test-group">
            <label for="port">Port</label>
            <select id="port">
              <option value="/dev/ttyUSB0" selected>/dev/ttyUSB0</option>
              <option value="/dev/ttyUSB1">/dev/ttyUSB1</option>
              <option value="/dev/ttyS0">/dev/ttyS0</option>
              <option value="/dev/ttyS1">/dev/ttyS1</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="baud-rate">Baud Rate</label>
            <select id="baud-rate">
              <option value="19200" selected>19200</option>
              <option value="9600">9600</option>
              <option value="115200">115200</option>
              <option value="38400">38400</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="parity">Parity</label>
            <select id="parity">
              <option value="N" selected>N</option>
              <option value="E">E</option>
              <option value="O">O</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="stop-bit">Stop Bits</label>
            <select id="stop-bit">
              <option value="1" selected>1</option>
              <option value="2">2</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="bytesize">Byte Size</label>
            <select id="bytesize">
              <option value="8" selected>8</option>
              <option value="7">7</option>
              <option value="6">6</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="timeout">Timeout</label>
            <select id="timeout">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="5">5</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="register">Register</label>
            <select id="register">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="count">Count</label>
            <select id="count">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="slave-id">Slave ID</label>
            <select id="slave-id">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <div class="read-test-group">
            <label for="data-type">Data Type</label>
            <select id="data-type">
              <option value="uint32" selected>uint32</option>
              <option value="uint16">uint16</option>
              <option value="int32">int32</option>
              <option value="float">float</option>
            </select>
          </div>
        </div>

        <div class="read-test-footer">
          <button class="read-test-button" onclick="sendModbusRequest()">
            Send Modbus Request
          </button>
          <span id="status-message" class="status-message"></span>
          <!-- Durum mesajı için -->
        </div>

        <div class="read-test-terminal">
          <label for="terminal">Terminal</label>
          <textarea id="terminal" readonly>Waiting for response...</textarea>
        </div>
      </div>
    </div>

    <!-- Write Test -->
    <div id="write" class="write-test-container tab-content-test">
      <div class="write-test-card">
        <div class="write-test-grid">
          <div class="write-test-group">
            <label for="port">Port</label>
            <select id="port">
              <option value="/dev/ttyUSB0" selected>/dev/ttyUSB0</option>
              <option value="/dev/ttyUSB1">/dev/ttyUSB1</option>
              <option value="/dev/ttyS0">/dev/ttyS0</option>
              <option value="/dev/ttyS1">/dev/ttyS1</option>
            </select>
          </div>
          <div class="write-test-group">
            <label for="baud-rate">Baud Rate</label>
            <select id="baud-rate">
              <option value="9600" selected>9600</option>
              <option value="19200">19200</option>
              <option value="115200">115200</option>
              <option value="38400">38400</option>
            </select>
          </div>
          <div class="write-test-group">
            <label for="parity">Parity</label>
            <select id="parity">
              <option value="N" selected>N</option>
              <option value="E">E</option>
              <option value="O">O</option>
            </select>
          </div>
          <div class="write-test-group">
            <label for="stop-bit">Stop Bits</label>
            <select id="stop-bit">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
          </div>
          <div class="write-test-group">
            <label for="bytessize">Byte Size</label>
            <select id="bytesize">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="timeout">Timeout</label>
            <select id="timeout">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="register">Register</label>
            <select id="register">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="count">Count</label>
            <select id="count">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="slave-id">Slave ID</label>
            <select id="slave-id">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3" selected>3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <div class="write-test-group">
            <label for="data-type">Data Type</label>
            <select id="data-type">
              <option value="unit32">unit32</option>
              <option value="uint16">uint16</option>
              <option value="init32" selected>init32</option>
              <option value="float">float</option>
            </select>
          </div>
        </div>

        <div class="write-test-footer">
          <button class="write-test-button" onclick="performWriteTest()">
            Perform a Scanning Test
          </button>
          <div class="write-test-status">
            <p
              id="write-test-success"
              class="write-test-success"
              style="display: none; color: green"
            >
              Local Network Connection Scan Successful.
            </p>
            <p
              id="write-test-failed"
              class="write-test-failed"
              style="display: none; color: red"
            >
              Local Network Connection Scan Failed.
            </p>
          </div>
        </div>

        <div class="write-test-terminal">
          <label for="write-terminal">Terminal</label>
          <textarea id="write-terminal" readonly>
            Waiting for response...</textarea
          >
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // JavaScript for toggling the dropdown and Pop Up password
  document.addEventListener("DOMContentLoaded", function () {
    const wifiToggleBtn = document.getElementById("wifiToggleBtn");
    const wifiList = document.getElementById("wifiList");
    const wifiPopup = document.getElementById("wifiPopup");
    const wifiName = document.getElementById("wifiName");
    const passwordInput = document.getElementById("wifiPassword");
    const showPasswordCheckbox = document.getElementById("showPassword");

    // İlk başta popup'ı kesinlikle gizli yap
    wifiPopup.style.display = "none";

    // Wi-Fi listesi aç/kapa
    wifiToggleBtn.addEventListener("click", function () {
      wifiList.style.display =
        wifiList.style.display === "block" ? "none" : "block";
    });

    // Wi-Fi listesinde her öğeye tıklanınca popup aç
    document.querySelectorAll(".wifi-item-test").forEach((item) => {
      item.addEventListener("click", function () {
        const networkName = item.getAttribute("data-wifi");
        wifiName.textContent = networkName;
        passwordInput.value = "";
        wifiPopup.style.display = "flex"; // Popup aç
      });
    });

    // Popup kapatma
    window.closeWifiPopup = function () {
      wifiPopup.style.display = "none";
    };

    // Şifre göster/gizle
    showPasswordCheckbox.addEventListener("change", function () {
      passwordInput.type = this.checked ? "text" : "password";
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const wifiPopup = document.getElementById("wifiPopup");
    const wifiName = document.getElementById("wifiName");
    const passwordInput = document.getElementById("wifiPassword");
    const showPasswordCheckbox = document.getElementById("showPassword");
    const joinButton = document.getElementById("joinWifiBtn");

    const networkNameSpan = document.getElementById("wifiNetworkName");
    const passwordSpan = document.getElementById("wifiPasswordDisplay");
    const connectionStatusSpan = document.getElementById(
      "wifiConnectionStatus"
    );
    const macAddressSpan = document.getElementById("wifiMacAddress");
    const wifiSuccess = document.getElementById("wifiSuccess");
    const wifiFailed = document.getElementById("wifiFailed");

    const ethernetStatusSpan = document.getElementById(
      "ethernetConnectionStatus"
    );
    const ethernetMacSpan = document.getElementById("ethernetMacAddress");
    const ethernetSuccess = document.getElementById("ethernetSuccess");
    const ethernetFailed = document.getElementById("ethernetFailed");

    const wifiListContainer = document.getElementById("dynamicWifiList");

    function getNetworkDetails(updateList = false) {
      fetch("/wi-fi-list", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success" && data.data) {
            const connectedSSID = data.data.connected_ssid;
            const macAddress = data.data.wifi_mac;
            const password = data.data.wifi_password;
            const ethernetConnected = data.data.ethernet_connected;
            const ethernetMac = data.data.ethernet_mac;

            // 📌 Wi-Fi Bilgilerini Güncelle
            if (connectedSSID) {
              networkNameSpan.textContent = connectedSSID;
              passwordSpan.textContent = password ? password : "No Password";
              connectionStatusSpan.textContent = "Connected";
              connectionStatusSpan.style.color = "green";
              macAddressSpan.textContent = macAddress || "Unknown";
              wifiSuccess.style.display = "block";
              wifiFailed.style.display = "none";
            } else {
              connectionStatusSpan.textContent = "No connection";
              connectionStatusSpan.style.color = "red";
              wifiSuccess.style.display = "none";
              wifiFailed.style.display = "block";
            }

            // Ethernet Bilgilerini Güncelle
            if (ethernetConnected) {
              ethernetStatusSpan.textContent = "Connected";
              ethernetStatusSpan.style.color = "green";
              ethernetMacSpan.textContent = ethernetMac || "Unknown";
              ethernetSuccess.style.display = "block";
              ethernetFailed.style.display = "none";
            } else {
              ethernetStatusSpan.textContent = "No connection";
              ethernetStatusSpan.style.color = "red";
              ethernetSuccess.style.display = "none";
              ethernetFailed.style.display = "block";
            }

            if (updateList)
              updateWifiList(data.data.wifi_networks, connectedSSID);
          }
        })
        .catch((error) =>
          console.error("Error fetching network details:", error)
        );
    }

    function updateWifiList(networks, connectedSSID) {
      wifiListContainer.innerHTML = "";

      if (networks.length > 0) {
        networks.sort((a, b) =>
          a === connectedSSID ? -1 : b === connectedSSID ? 1 : 0
        );

        networks.forEach((wifi) => {
          const wifiItem = document.createElement("div");
          wifiItem.classList.add("wifi-item-test");
          wifiItem.dataset.wifi = wifi;

          if (wifi === connectedSSID) wifiItem.classList.add("connected-wifi");

          wifiItem.innerHTML = `
                    <div class="wifi-name-test">
                        <span><img src="/static/images/svg/25.svg" alt="Wi-Fi"></span>
                        ${wifi}
                        <img src="/static/images/svg/26.svg" alt="Wi-Fi">
                    </div>`;

          wifiItem.addEventListener("click", function () {
            openWifiPopup(wifi);
          });

          wifiListContainer.appendChild(wifiItem);
        });
      } else {
        wifiListContainer.innerHTML = "<p>No available networks found.</p>";
      }
    }

    getNetworkDetails(true);

    window.openWifiPopup = function (ssid) {
      wifiName.textContent = ssid;
      passwordInput.value = "";
      wifiPopup.style.display = "flex";
    };

    window.closeWifiPopup = function () {
      wifiPopup.style.display = "none";
    };

    showPasswordCheckbox.addEventListener("change", function () {
      passwordInput.type = this.checked ? "text" : "password";
    });

    joinButton.addEventListener("click", function () {
      const ssid = wifiName.textContent.trim();
      const password = passwordInput.value.trim();

      if (!ssid) {
        Swal.fire({
          icon: "error",
          title: "Wi-Fi Not Selected",
          text: "Please select a Wi-Fi network first!",
        });
        return;
      }

      joinButton.innerHTML = `<span class="spinner"></span> Connecting...`;
      joinButton.disabled = true;

      fetch("/connect_wifi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ssid, password }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            Swal.fire({
              icon: "success",
              title: "Connected!",
              text: `Successfully connected to ${ssid}.`,
            });

            networkNameSpan.textContent = ssid;
            passwordSpan.textContent = password ? password : "No Password";
            connectionStatusSpan.textContent = "Connected";
            connectionStatusSpan.style.color = "green";

            getNetworkDetails(true);
            closeWifiPopup();
          } else {
            Swal.fire({
              icon: "error",
              title: "Connection Failed",
              text: data.message || "Failed to connect to Wi-Fi.",
            });
            connectionStatusSpan.textContent = "No connection";
            connectionStatusSpan.style.color = "red";
          }
        })
        .catch((error) => {
          console.error("Error connecting to Wi-Fi:", error);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "An error occurred while connecting to Wi-Fi.",
          });
          connectionStatusSpan.textContent = "No connection";
          connectionStatusSpan.style.color = "red";
        })
        .finally(() => {
          joinButton.innerHTML = "Join";
          joinButton.disabled = false;
        });
    });

    document
      .getElementById("wifiToggleBtn")
      .addEventListener("click", function () {
        getNetworkDetails(true);
      });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const tabButtons = document.querySelectorAll(".switch-btn-test");
    const tabContents = document.querySelectorAll(".tab-content-test");

    console.log(document.querySelectorAll(".switch-btn-test"));
    console.log(document.querySelectorAll(".tab-content-test"));

    tabButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");
        console.log(targetId);

        // Tüm içerikleri gizle
        tabContents.forEach((content) => (content.style.display = "none"));

        console.log(tabContents);

        // Tüm butonlardaki "active" sınıfını kaldır
        tabButtons.forEach((btn) => btn.classList.remove("active"));
        console.log(tabButtons);

        // Seçilen butona "active" sınıfı ekle
        this.classList.add("active");

        // İlgili içeriği göster
        const targetElement = document.getElementById(targetId);
        console.log(targetElement);
        if (targetElement) {
          targetElement.style.display = "block";
          console.log(targetElement);
        }
      });
    });

    // Sayfa yüklendiğinde ilk butonu otomatik tıklat
    if (tabButtons.length > 0) {
      tabButtons[0].click();
      console.log(tabButtons[0]);
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    function setCloudConnectionStatus(isConnected) {
      const cloudStatusRow = document.querySelector(
        "tr[data-status='A']:nth-child(1)"
      ); // Cloud Connection satırı
      const statusCells = cloudStatusRow.querySelectorAll(".cloud-test-status");

      statusCells.forEach((cell) => {
        cell.innerHTML = isConnected
          ? '<span class="status-indicator status-green"></span>'
          : '<span class="status-indicator status-red"></span>';
      });
    }

    function updateRabbitMQStatus() {
      fetch("/rabbitmq-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      })
        .then((response) => response.json())
        .then((data) => {
          const rabbitmqStatusRow = document.querySelector(
            "tr[data-status='P']"
          );
          const statusCells =
            rabbitmqStatusRow.querySelectorAll(".cloud-test-status");

          if (data.status === "success" && data.data.rabbitmq_connected) {
            statusCells.forEach((cell) => {
              cell.innerHTML =
                '<span class="status-indicator status-green"></span>';
            });
          } else {
            statusCells.forEach((cell) => {
              cell.innerHTML =
                '<span class="status-indicator status-red"></span>';
            });
          }
        })
        .catch((error) =>
          console.error("Error fetching RabbitMQ status:", error)
        );
    }

    function updateVPNStatus() {
      fetch("/vpn-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      })
        .then((response) => response.json())
        .then((data) => {
          const vpnStatusRow = document.querySelector(
            "tr[data-status='A']:nth-child(3)"
          ); // VPN Port satırı
          const statusCells =
            vpnStatusRow.querySelectorAll(".cloud-test-status");

          if (data.status === "success" && data.data.vpn_connected) {
            statusCells.forEach((cell) => {
              cell.innerHTML =
                '<span class="status-indicator status-green"></span>';
            });
          } else {
            statusCells.forEach((cell) => {
              cell.innerHTML =
                '<span class="status-indicator status-red"></span>';
            });
          }
        })
        .catch((error) => console.error("Error fetching VPN status:", error));
    }

    // 📌 **Cloud varsayılan olarak kırmızı olacak**
    setCloudConnectionStatus(false);

    // 📌 **RabbitMQ ve VPN bağlantılarını kontrol et**
    updateRabbitMQStatus();
    updateVPNStatus();
  });

  document
    .querySelectorAll(
      ".equipment-table tbody tr td:nth-child(3), .equipment-table tbody tr td:nth-child(4)"
    )
    .forEach((td) => {
      let text = td.innerText.trim();

      if (text === "A") {
        td.style.color = "green";
        td.style.fontWeight = "bold";
      } else if (text === "P") {
        td.style.color = "red";
        td.style.fontWeight = "bold";
      }
    });

  document.addEventListener("DOMContentLoaded", function () {
    console.log("Page Loaded, Fetching Equipments...");
    fetchEquipments();
  });

  let previousEquipmentData = [];

  function startScanning() {
    console.log("Scanning started...");
    document.getElementById("scan-status").style.display = "inline";
    document.getElementById("scan-status").textContent =
      "Scanning in progress...";

    // Yükleme simgesini göster
    document.getElementById("scan-spinner").style.display = "inline-block";

    fetch("/get_slave_data", {
      method: "GET",
      headers: { "Content-Type": "application/json" },
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Backend'den Gelen Veri:", data);

        if (
          data.status === "success" &&
          Array.isArray(data.data) &&
          data.data.length > 0
        ) {
          console.log("Yeni cihazlar bulundu!");
          addNewDataToTable(data.data);
        } else {
          console.warn("No new data found.");
        }

        document.getElementById("scan-status").style.display = "none";
      })
      .catch((error) => {
        console.error("Error during scanning:", error);
        document.getElementById("scan-status").textContent = "Scanning failed!";
        document.getElementById("scan-status").style.color = "red";
      })
      .finally(() => {
        document.getElementById("scan-spinner").style.display = "none";
      });
  }

  function addNewDataToTable(newData) {
    console.log("Yeni cihazlar tabloya ekleniyor...");
    const tableBody = document.getElementById("equipment-table-body");

    const newEquipments = newData.filter(
      (item) =>
        !previousEquipmentData.some(
          (prev) =>
            prev.slave_id === item.slave_id &&
            prev.model_name === item.model_name &&
            prev.ip === item.ip
        )
    );

    if (newEquipments.length === 0) {
      console.log("Yeni veri bulunamadı.");
      return;
    }

    // İlk yeni satırdan önce bir ayırıcı çizgi ekleyelim
    const separatorRow = document.createElement("tr");
    separatorRow.innerHTML = `<td colspan="6" class="new-equipment-separator">Equipment Scan Results</td>`;
    tableBody.appendChild(separatorRow);

    newEquipments.forEach((item) => {
      const row = document.createElement("tr");

      // Eğer hem slave_id hem ip varsa, ikisini de göster
      let sidOrIP = "";
      if (item.slave_id && item.ip) {
        sidOrIP = `Slave ID: ${item.slave_id} | IP: ${item.ip}`;
      } else if (item.slave_id) {
        sidOrIP = `Slave ID: ${item.slave_id}`;
      } else if (item.ip) {
        sidOrIP = `IP: ${item.ip}`;
      } else {
        sidOrIP = "N/A";
      }

      row.innerHTML = `
        <td>${item.model_name}</td>
        <td>${sidOrIP}</td>
        <td class="status-static" style="color: red; font-weight: bold;">P / P</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
      `;
      tableBody.appendChild(row);
    });

    // Yeni eklenen verileri sakla
    previousEquipmentData = [...previousEquipmentData, ...newEquipments];
  }

  function fetchEquipments() {
    console.log("fetchEquipments() çağrıldı!");
    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

    if (!selectedDeviceIP) {
      console.warn("⚠ No device selected for fetching equipments.");
      document.getElementById("equipment-table-body").innerHTML =
        "<tr><td colspan='6' style='color: red;'>⚠ No device selected.</td></tr>";
      return;
    }

    fetch("/equipments-with-models", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ip_address: selectedDeviceIP }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Equipment Data Fetched:", data);

        if (
          data.status === "success" &&
          Array.isArray(data.data) &&
          data.data.length > 0
        ) {
          updateEquipmentTable(data.data);
        } else {
          console.warn("No equipments found.");
          document.getElementById("equipment-table-body").innerHTML =
            "<tr><td colspan='6' style='color: red;'>No equipments found</td></tr>";
        }
      })
      .catch((error) => {
        console.error("Error fetching equipments:", error);
        document.getElementById("equipment-table-body").innerHTML =
          "<tr><td colspan='6' style='color: red;'>⚠ Error fetching equipments</td></tr>";
      });
  }

  function updateEquipmentTable(equipments) {
    const tableBody = document.getElementById("equipment-table-body");

    if (!equipments || equipments.length === 0) {
      tableBody.innerHTML =
        "<tr><td colspan='6' style='color: red;'>No equipment found</td></tr>";
      return;
    }

    equipments.forEach((equipment) => {
      const row = document.createElement("tr");
      row.innerHTML = `
         <td>${equipment.model_name || "Unknown"}</td>
         <td>${equipment.modbus_address || "N/A"}</td>
         <td style="color: ${equipment.status === "A" ? "green" : "red"}; font-weight: bold;">
           ${equipment.status}
         </td>
         <td style="color: ${equipment.configuration_data === "A" ? "green" : "red"}; font-weight: bold;">
           ${equipment.configuration_data}
         </td>
         <td style="color: ${equipment.communication_protocol_code === 1 ? "green" : "red"}; font-weight: bold;">
           ${equipment.communication_protocol_code === 1 ? "OK" : "No"}
         </td>
         <td>${formatDateTime(equipment.created_at)}</td>
        `;
      tableBody.appendChild(row);
    });
  }

  function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return (
      date.toISOString().split("T")[0] + " " + date.toTimeString().split(" ")[0]
    );
  }

  // Read Modbus
  function sendModbusRequest() {
    const terminal = document.getElementById("terminal");
    const statusMessage = document.getElementById("status-message");
    terminal.value = "🔍 Sending Modbus request... Please wait.";
    statusMessage.textContent = "";
    statusMessage.className = "status-message";

    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");
    if (!selectedDeviceIP) {
      terminal.value = "No device selected.";
      statusMessage.textContent = "Local Network Connection Scan Failed.";
      statusMessage.classList.add("error");
      return;
    }

    const modbusParams = {
      port: document.getElementById("port").value,
      baudrate: parseInt(document.getElementById("baud-rate").value),
      parity: document.getElementById("parity").value,
      stopbits: parseInt(document.getElementById("stop-bit").value),
      bytesize: parseInt(document.getElementById("bytesize").value),
      timeout: parseFloat(document.getElementById("timeout").value),
      address: parseInt(document.getElementById("register").value),
      count: 2,
      slave_id: parseInt(document.getElementById("slave-id").value),
      method: "rtu",
    };

    console.log(
      "Sending JSON:",
      JSON.stringify({ modbus_params: modbusParams })
    );

    fetch("/validate_modbus", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ modbus_params: modbusParams }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Received Response:", data);
        const registers = data.data?.data;

        if (
          data.status === "success" &&
          Array.isArray(registers) &&
          registers.length > 0
        ) {
          terminal.value = `Registers: ${registers.join(", ")}`;
          statusMessage.textContent =
            "Local Network Connection Scan Successful.";
          statusMessage.classList.add("success");
        } else {
          terminal.value = `Error: ${data.message}`;
          statusMessage.textContent = "Local Network Connection Scan Failed.";
          statusMessage.classList.add("error");
        }
      })
      .catch((error) => {
        console.error("Request Failed:", error);
        terminal.value = `Request failed:\n${error}`;
        statusMessage.textContent = "Local Network Connection Scan Failed.";
        statusMessage.classList.add("error");
      });
  }

  // Write Modbus
  function sendModbusRequest() {
    const terminal = document.getElementById("terminal");
    const statusMessage = document.getElementById("status-message"); // Durum mesajı

    terminal.value = "Sending Modbus request... Please wait.";
    statusMessage.textContent = "";
    statusMessage.className = "status-message"; // Önceki class'ı sıfırla

    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");
    if (!selectedDeviceIP) {
      terminal.value = "No device selected.";
      statusMessage.textContent = "Local Network Connection Scan Failed.";
      statusMessage.classList.add("error");
      return;
    }

    const modbusParams = {
      port: document.getElementById("port").value,
      baudrate: parseInt(document.getElementById("baud-rate").value),
      parity: document.getElementById("parity").value,
      stopbits: parseInt(document.getElementById("stop-bit").value),
      bytesize: parseInt(document.getElementById("bytesize").value),
      timeout: parseFloat(document.getElementById("timeout").value),
      address: parseInt(document.getElementById("register").value),
      count: parseInt(document.getElementById("count").value),
      slave_id: parseInt(document.getElementById("slave-id").value),
      method: "rtu",
    };

    console.log(
      "Sending JSON:",
      JSON.stringify({ modbus_params: modbusParams })
    );

    fetch("/validate_modbus", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ modbus_params: modbusParams }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Received Response:", data);

        const registers = data.data?.data;

        if (
          data.status === "success" &&
          Array.isArray(registers) &&
          registers.length > 0
        ) {
          terminal.value = `Registers: ${registers.join(", ")}`;
          statusMessage.textContent =
            "Local Network Connection Scan Successful.";
          statusMessage.classList.add("success");
        } else {
          terminal.value = `Error: ${data.message}`;
          statusMessage.textContent = "Local Network Connection Scan Failed.";
          statusMessage.classList.add("error");
        }
      })
      .catch((error) => {
        console.error("Request Failed:", error);
        terminal.value = `Request failed:\n${error}`;
        statusMessage.textContent = "Local Network Connection Scan Failed.";
        statusMessage.classList.add("error");
      });
  }

  function performWriteTest() {
    const terminal = document.getElementById("write-terminal");
    const successMessage = document.getElementById("write-test-success");
    const failedMessage = document.getElementById("write-test-failed");

    successMessage.style.display = "none";
    failedMessage.style.display = "none";

    terminal.value = "Sending write request... Please wait.";

    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");
    if (!selectedDeviceIP) {
      terminal.value = "No device selected.";
      failedMessage.style.display = "block";
      return;
    }

    const modbusParams = {
      port: document.getElementById("port").value,
      baudrate: parseInt(document.getElementById("baud-rate").value),
      parity: document.getElementById("parity").value,
      stopbits: parseInt(document.getElementById("stop-bit").value),
      bytesize: parseInt(document.getElementById("bytesize").value),
      timeout: parseFloat(document.getElementById("timeout").value),
      slave_id: parseInt(document.getElementById("slave-id").value),
      count: parseInt(document.getElementById("count").value),
      register: parseInt(document.getElementById("register").value),
      data_type: document.getElementById("data-type").value,
      method: "rtu",
    };

    console.log(
      "Sending JSON:",
      JSON.stringify({ modbus_params: modbusParams })
    );

    fetch("/validate_modbus", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ modbus_params: modbusParams }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Received Response:", data);

        const registers = data.data?.data;

        if (
          data.status === "success" &&
          Array.isArray(registers) &&
          registers.length > 0
        ) {
          terminal.value = `Write successful. Read value: ${registers.join(
            ", "
          )}`;
          successMessage.style.display = "block";
        } else {
          terminal.value = `Error: ${data.message}`;
          failedMessage.style.display = "block";
        }
      })
      .catch((error) => {
        console.error("Request Failed:", error);
        terminal.value = `Request failed:\n${error}`;
        failedMessage.style.display = "block";
      });
  }
</script>

<style>
  .connected-wifi {
    font-weight: bold;
    color: green;
  }

  .popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .popup-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
  }

  .popup-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
  }

  .spinner {
    display: inline-block;
    width: 13px;
    height: 13px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 5px;
    vertical-align: middle;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .equipment-table {
    width: 100%;
    border-collapse: collapse;
    background: #0b1734;
    border-radius: 6px;
    overflow: hidden;
    font-size: 14px;
  }

  .equipment-table th,
  .equipment-table td {
    border: none;
    padding: 10px;
    text-align: center;
    color: #fff;
  }

  .equipment-table th {
    background: #0b1734;
    font-weight: bold;
    color: #ef8018;
    border-bottom: 1px solid #ffffff;
  }

  .equipment-table td {
    border-bottom: 1px solid #ef8018;
  }

  .equipment-table tbody tr:last-child td {
    border-bottom: none;
  }

  .status-message {
    margin-left: 10px;
  }

  .success {
    color: limegreen;
    font-size: 14px;
  }

  .error {
    color: red;
    font-size: 14px;
  }

  .equipment-scan-btn {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px; /* Buton içindeki elemanlar arasında boşluk bırak */
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    background-color: #3498db;
    color: white;
    cursor: pointer;
    transition: background 0.3s;
  }

  .equipment-scan-btn:hover {
    background-color: #2980b9;
  }

  .loader {
    width: 14px;
    height: 14px;
    border: 2px solid transparent;
    border-radius: 50%;
    border-top: 2px solid white;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .new-equipment-separator {
    text-align: center;
    font-weight: bold;
    color: #ef8018;
  }

  .status-static {
    color: red !important;
    font-weight: bold;
  }
</style>
{% endblock %}
