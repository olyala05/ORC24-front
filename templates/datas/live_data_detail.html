{% extends "layout.html" %} 

{% block title %} {{ _('Live Data Details') }} {% endblock %}

{% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="live-data-detail-table-container">
  <!-- Equipment Details Table -->
  <table class="live-data-detail-data-table">
    <thead>
      <tr>
        <th>{{ _('Serial Number')}}</th>
        <th>{{ _('Modem Serial No')}}</th>
        <th>{{ _('Status / Configuration')}}</th>
        <th>{{ _('Archive') }}</th>
        <th>{{ _('Number of Data')}}</th>
      </tr>
    </thead>
    <tbody id="equipment-details">
      <tr><td colspan='5' class="empty-message"></td></tr>
    </tbody>
  </table>

  <!-- Live Data Table with Scroll -->
  <div class="scrollable-table">
    <table class="live-data-detail-data-table">
      <thead>
        <tr>
          <th>{{ _('Live Data ID') }}</th>
          <th>{{ _('Device ID') }}</th>
          <th>{{ _('Value List') }}</th>
          <th>{{ _('Data Value') }}</th>
          <th>{{ _('Created Date') }}</th>
        </tr>
      </thead>
      <tbody id="live-data-body">
        <tr><td colspan='5' class="empty-message"></td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetchEquipmentDetails();
    fetchLiveData(1);
  });

  function fetchEquipmentDetails() {
    const selectedEquipmentID = sessionStorage.getItem("selected_equipment_id");

    if (!selectedEquipmentID) {
        document.getElementById("equipment-details").innerHTML =
            "<tr><td colspan='5' class='empty-message'>{{ _('No equipment selected')}}</td></tr>";
        return;
    }

    fetch(`/fetch_equipment_details?equipment_id=${selectedEquipmentID}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === "success" && data.data) {
                updateDetailsTable([data.data]);
            } else {
                document.getElementById("equipment-details").innerHTML =
                    "<tr><td colspan='5' class='empty-message'>{{ _('No equipment details found.')}}</td></tr>";
            }
        })
        .catch(() => {
            document.getElementById("equipment-details").innerHTML =
                "<tr><td colspan='5' class='empty-message'>{{ _('Error loading data.')}}</td></tr>";
        });
}

function updateDetailsTable(equipments) {
  const tableBody = document.getElementById("equipment-details");
  tableBody.innerHTML = "";

  equipments.forEach((equipment) => {
    let row = document.createElement("tr");
    row.innerHTML = `
        <td>${equipment.model_name}@${equipment.serial_number}</td>
        <td>${equipment.modem_serial_number || "N/A"}</td>
        <td style="color: ${equipment.status === 'A' ? 'green' : 'red'}; font-weight: bold;">
            ${equipment.status === "A" ? "A" : "P"}
        </td>
        <td><div class="status-circle"></div></td>
        <td>${equipment.data_count || 0}</td>
    `;

    tableBody.appendChild(row);
  });
}


  let currentPage = 1;
  const perPage = 20;
  let isFetching = false;

  document.querySelector(".scrollable-table tbody").addEventListener("scroll", function () {
    if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
      if (!isFetching) {
        isFetching = true;
        currentPage++;
        fetchLiveData(currentPage);
      }
    }
  });

  function fetchLiveData(page) {
    fetch("/fetch_live_data_paginated", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ page: page, per_page: perPage }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.status === "success" && data.data && Array.isArray(data.data.data)) {
          updateLiveDataTable(data.data.data);
        } else if (page === 1) {
          document.getElementById("live-data-body").innerHTML =
            "<tr><td colspan='5' class='empty-message'>{{ _('Live Data is Empty') }}</td></tr>";
        }
      })
      .catch(() => {
        document.getElementById("live-data-body").innerHTML =
          "<tr><td colspan='5' class='empty-message'>{{ _('Error loading data.')}}</td></tr>";
      })
      .finally(() => {
        isFetching = false;
      });
  }

  function updateLiveDataTable(liveData) {
    const tableBody = document.getElementById("live-data-body");

    liveData.forEach((data) => {
      let row = document.createElement("tr");
      row.innerHTML = `
            <td>${data.device_serial_no || "N/A"}</td>
            <td>${data.device_id || "N/A"}</td>
            <td>${data.value_list_title || "N/A"}</td>
            <td>${data.value || "0.00"}</td>
            <td>${formatDateTime(data.created_at)}</td>
        `;
      tableBody.appendChild(row);
    });
  }

  function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toISOString().split("T")[0] + " " + date.toTimeString().split(" ")[0];
  }
</script>

<style>
  .empty-message {
    text-align: center;
    color: red;
    font-weight: bold;
    font-size: 18px;
    padding: 15px;
  }
</style>

{% endblock %}
