{% extends "layout.html" %} {% block title %} Live Data Details {% endblock %}
{% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="live-data-detail-table-container">

  <!-- Sabit duran ilk tablo -->
  <table class="live-data-detail-data-table">
    <thead>
      <tr>
        <th>Serial Number</th>
        <th>Modem Serial No</th>
        <th>Status / Configuration</th>
        <th>Archive</th>
        <th>Number of Data</th>
      </tr>
    </thead>
    <tbody id="equipment-details"></tbody>
  </table>

  <!-- Scroll olacak ikinci tablo -->
  <div class="scrollable-table">
    <table class="live-data-detail-data-table">
      <thead>
        <tr>
          <th>Live Data ID</th>
          <th>Device ID</th>
          <th>Value List</th>
          <th>Data Value</th>
          <th>Created Date</th>
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>

</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetchEquipmentDetails();
  });

  function fetchEquipmentDetails() {
    const selectedEquipmentID = sessionStorage.getItem("selected_equipment_id");

    if (!selectedEquipmentID) {
      console.error("‚ùå Ekipman se√ßilmedi!");
      document.getElementById("equipment-details").innerHTML =
        "<tr><td colspan='5' style='color: red; text-align: center;'>Ekipman se√ßilmedi!</td></tr>";
      return;
    }

    console.log("üîç Se√ßilen Equipment ID:", selectedEquipmentID);

    fetch(`/fetch_equipment_details?equipment_id=${selectedEquipmentID}`)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP Hatasƒ±! Status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log("‚úÖ Equipment Details Response:", data);

        if (data.status === "success" && data.data) {
          updateDetailsTable([data.data]);
        } else {
          console.warn("‚ö†Ô∏è Ekipman detaylarƒ± bulunamadƒ±.");
          document.getElementById("equipment-details").innerHTML =
            "<tr><td colspan='5' style='color: red; text-align: center;'>Ekipman detaylarƒ± bulunamadƒ±.</td></tr>";
        }
      })
      .catch((error) => {
        console.error("Detaylarƒ± getirirken hata olu≈ütu:", error);
        document.getElementById("equipment-details").innerHTML =
          "<tr><td colspan='5' style='color: red; text-align: center;'>Hata olu≈ütu.</td></tr>";
      });
  }

  function updateDetailsTable(equipments) {
    const tableBody = document.getElementById("equipment-details");

    if (!tableBody) {
      console.error("Hata: `equipment-details` ID'li element bulunamadƒ±.");
      return;
    }

    tableBody.innerHTML = "";

    equipments.forEach((equipment) => {
      let row = document.createElement("tr");
      row.innerHTML = `
          <td>${equipment.model_name}@${equipment.serial_number}</td>
          <td>${equipment.modem_serial_number || "N/A"}</td>
          <td class="live-data-detail-status">${
            equipment.status === 1 ? "A / A" : "P / P"
          }</td>
          <td class="live-data-detail-archive">&#128308;</td>
          <td>${equipment.data_count || 0}</td>
      `;
      tableBody.appendChild(row);
    });
  }


  // Live Data
  let currentPage = 1; // Ba≈ülangƒ±√ß sayfasƒ±
const perPage = 20; // Her istekte ka√ß veri √ßekilecek
let isFetching = false; // Tekrar eden istekleri √∂nlemek i√ßin flag

document.addEventListener("DOMContentLoaded", function () {
    fetchLiveData(currentPage); // ƒ∞lk sayfa verilerini √ßek
});

// Scroll Event Listener
document.querySelector(".scrollable-table tbody").addEventListener("scroll", function () {
    const tableBody = this;
    if (tableBody.scrollTop + tableBody.clientHeight >= tableBody.scrollHeight - 50) {
        if (!isFetching) {
            isFetching = true;
            currentPage++; // Sayfa numarasƒ±nƒ± artƒ±r
            fetchLiveData(currentPage);
        }
    }
});

function fetchLiveData(page) {
    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

    if (!selectedDeviceIP) {
        console.warn("Cihaz IP adresi se√ßilmedi.");
        return;
    }

    fetch("/fetch_live_data_paginated", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ page: page, per_page: perPage }),
    })
    .then((response) => response.json())
    .then((data) => {
        console.log("üìå Live Data Response:", data);

        if (data.status === "success" && data.data && Array.isArray(data.data.data)) {
            updateLiveDataTable(data.data.data);
        } else {
            console.warn("‚ö†Ô∏è Yeni veri bulunamadƒ±.");
        }
    })
    .catch((error) => console.error("‚ùå Veri √ßekme hatasƒ±:", error))
    .finally(() => {
        isFetching = false;
    });
}

function updateLiveDataTable(liveData) {
    const tableBody = document.querySelector(".scrollable-table tbody");

    if (!tableBody) {
        console.error("Hata: `tbody` bulunamadƒ±.");
        return;
    }

    liveData.forEach((data) => {
        let row = document.createElement("tr");
        row.innerHTML = `
            <td>${data.device_serial_no || "N/A"}</td>
            <td>${data.device_id || "N/A"}</td>
            <td>${data.value_list_title || "N/A"}</td>
            <td>${data.value || "0.00"}</td>
            <td>${formatDateTime(data.created_at)}</td>
        `;
        tableBody.appendChild(row);
    });
}

function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toISOString().split("T")[0] + " " + date.toTimeString().split(" ")[0];
}

</script>


{% endblock %}
