{% extends "layout.html" %} 

{% block title %} {{ _('Daily Data') }} {% endblock %}

{% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="daily-data-container">
  <!-- Daily Data Table Bölümü -->
  <div class="daily-data-table">
    <div class="table-header">
      <div>{{ _('Created Date')}}</div>
      <div>{{ _('Number of Equipment')}}</div>
      <div>{{ _('Number of Data')}}</div>
      <div>{{ _('Time (Sec)')}}</div>
    </div>
    <div id="daily-data-container"></div>
  </div>

  <!-- Daily Data Status Bölümü -->
  <div class="daily-data-status">
    <div class="table-header">
      <div>{{ _('Serial Number')}}</div>
      <div>{{ _('Status / Config.')}}</div>
      <div>{{ _('Equipment Type')}}</div>
      <div>{{ _('Archive') }}</div>
      <div>{{ _('Number of Data')}}</div>
    </div>
    <div id="equipment-table">
      <!-- Dinamik veriler buraya eklenecek -->
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetchDailyData();
  });

  function fetchDailyData() {
    fetch("/fetch_grouped_daily_data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    })
      .then((response) => response.json())
      .then((data) => {
        updateDailyDataTable(data.equipments || []);
      })
      .catch((error) => {
        console.error("Hata:", error);
        updateDailyDataTable([]);
      });
  }

  function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return (
      date.toISOString().split("T")[0] + " " + date.toTimeString().split(" ")[0]
    );
  }

  function updateDailyDataTable(dailyData) {
    const container = document.getElementById("daily-data-container");
    container.innerHTML = "";

    if (!dailyData || dailyData.length === 0) {
      const emptyMessage = document.createElement("div");
      emptyMessage.className = "empty-message";
      emptyMessage.innerText = "{{ _('Daily Data is Empty') }}";
      container.appendChild(emptyMessage);
      return;
    }

    dailyData.forEach((item) => {
      const formattedDate = formatDateTime(item.created_at);

      const row = document.createElement("div");
      row.className = "table-row";
      row.innerHTML = `
            <div>${formattedDate}</div>
            <div>${item.equipment_count}</div>
            <div>${item.data_count}</div>
            <div>0</div>
        `;
      container.appendChild(row);
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const clickableElements = document.querySelectorAll(".clickable");
    clickableElements.forEach(function (elem) {
      elem.addEventListener("click", function () {
        window.location.href = "/daily-data-detail";
      });
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    fetchEquipments();
  });

  function fetchEquipments() {
    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

    if (!selectedDeviceIP) {
      console.warn("No device selected for fetching equipments.");
      document.getElementById("equipment-table").innerHTML =
        "<p style='color: red;'>{{ _('No device selected.')}}</p>";
      return;
    }

    fetch("/equipments-with-models", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ip_address: selectedDeviceIP }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("{{ _('Equipments Response:')}}", data);

        if (data.status === "success" && Array.isArray(data.data)) {
          updateTable(data.data);
        } else {
          console.warn("{{ _('No equipments found')}}");
          document.getElementById("equipment-table").innerHTML =
            "<p style='color: red;'>{{ _('No equipments found')}}</p>";
        }
      })
      .catch((error) => {
        console.error("{{ _('Error fetching equipments')}}", error);
        document.getElementById("equipment-table").innerHTML =
          "<p style='color: red;'>{{ _('Error fetching equipments')}}</p>";
      });
  }

  function updateTable(equipments) {
    const table = document.getElementById("equipment-table");
    table.innerHTML = ""; 

    if (equipments.length === 0) {
      table.innerHTML = "<p style='color: red;'>{{ _('No equipments found')}}</p>";
      return;
    }

    equipments.forEach((device) => {
      const statusText = device.status === "A" ? "A" : "P";
      const statusClass = device.status === "A" ? "green" : "red";

      let row = document.createElement("div");
      row.className = "table-row clickable";

      row.innerHTML = `
            <div data-serial="${device.model_name}@${device.serial_number}">
                ${device.model_name}@${device.serial_number}
            </div>
            <div data-status="${statusText}" style="color: ${statusClass}; font-weight: bold;">
                ${statusText}
            </div>
            <div>${device.equipment_type || "Analyzer"}</div>
            <div><span class="status ${statusClass}"></span></div>
            <div>${device.data_count || 0}</div>
        `;

      // Cihaza tıklanınca ID'yi sessionStorage ve backend'e gönder
      row.addEventListener("click", function () {
        sessionStorage.setItem("selected_equipment_id", device.id);
        console.log("{{ _('Selected Equipment ID saved:')}}", device.id);
        fetch("/set_selected_equipment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ equipment_id: device.id }),
        })
          .then((response) => response.json())
          .then((setResponse) => {
            if (setResponse.success) {
              console.log("{{ _('Equipment ID updated in the backend:')}}", device.id);
              window.location.href = "/daily-data-detail";
            } else {
              throw new Error("{{ _('ID could not be updated in the backend!')}}");
            }
          })
          .catch((error) =>
            console.error("{{ _('Error while updating ID in the backend:')}}", error)
          );
      });

      table.appendChild(row);
    });
  }

</script>

<style>
  .table-row div:first-child {
    white-space: normal;
    word-break: break-word;
    max-width: 150px;
    overflow: visible;
    display: block;
  }

  .empty-message {
    text-align: center;
    color: red;
    font-weight: bold;
    font-size: 14px;
    margin: 20px 0;
  }
</style>

{% endblock %}
