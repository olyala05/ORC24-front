{% extends "layout.html" %} {% block title %} Live Data Details {% endblock %}
{% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="live-data-container">
  <!-- Live Data Table Bölümü -->
  <div class="live-data-table">
    <div class="table-header">
      <div>Created Date</div>
      <div>Number of Equipment</div>
      <div>Number of Data</div>
      <div>Time (Sec)</div>
    </div>
    <div id="live-data-container"></div>
  </div>

  <!-- Live Data Status Bölümü -->
  <div class="live-data-status">
    <div class="table-header">
      <div>Serial Number</div>
      <div>Status / Config.</div>
      <div>Equipment Type</div>
      <div>Archive</div>
      <div>Number of Data</div>
    </div>
    <div id="equipment-table">
      <!-- Dinamik veriler buraya eklenecek -->
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetchLiveData();
  });

  function fetchLiveData() {
    fetch("/fetch_grouped_live_data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.equipments) {
          updateLiveDataTable(data.equipments);
        } else {
          console.error("Veri alınamadı:", data.message || data.error);
        }
      })
      .catch((error) => console.error("Hata:", error));
  }

  function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return (
      date.toISOString().split("T")[0] + " " + date.toTimeString().split(" ")[0]
    );
  }

  function updateLiveDataTable(liveData) {
    const container = document.getElementById("live-data-container");
    container.innerHTML = "";

    liveData.forEach((item, index) => {
      const formattedDate = formatDateTime(item.created_at);

      const row = document.createElement("div");
      row.className = "table-row";
      row.innerHTML = `
          <div>${formattedDate}</div>
          <div>${item.equipment_count}</div>
          <div>${item.data_count}</div>
          <div>0</div>
      `;
      container.appendChild(row);
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const clickableElements = document.querySelectorAll(".clickable");
    clickableElements.forEach(function (elem) {
      elem.addEventListener("click", function () {
        window.location.href = "/live-data-detail";
      });
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    fetchEquipments();
  });

  document.addEventListener("DOMContentLoaded", function () {
    fetchEquipments();
  });

  function fetchEquipments() {
    const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

    if (!selectedDeviceIP) {
      console.warn("No device selected for fetching equipments.");
      document.getElementById("equipment-table").innerHTML =
        "<p style='color: red;'>No device selected.</p>";
      return;
    }

    fetch("/equipments-with-models", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ip_address: selectedDeviceIP }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Equipments Response:", data);

        if (data.status === "success" && Array.isArray(data.data)) {
          updateTable(data.data);
        } else {
          console.warn("No equipments found.");
          document.getElementById("equipment-table").innerHTML =
            "<p style='color: red;'>No equipments found</p>";
        }
      })
      .catch((error) => {
        console.error("Error fetching equipments:", error);
        document.getElementById("equipment-table").innerHTML =
          "<p style='color: red;'>Error fetching equipments</p>";
      });
  }

  function updateTable(equipments) {
    const table = document.getElementById("equipment-table");
    table.innerHTML = "";

    if (equipments.length === 0) {
      table.innerHTML = "<p style='color: red;'>No equipments found</p>";
      return;
    }

    equipments.forEach((device) => {
      // Status'u "A" veya "P" olarak ayarla
      const statusText = device.status === 1 ? "A" : "P";
      const statusClass = device.status === 1 ? "green" : "red"; // CSS için sınıflar

      let row = document.createElement("div");
      row.className = "table-row clickable";

      row.innerHTML = `
          <div data-serial="${device.model_name}@${device.serial_number}">
              ${device.model_name}@${device.serial_number}
          </div>
          <div data-status="${statusText}" style="color: ${statusClass}; font-weight: bold;">
              ${statusText}
          </div>
          <div>${device.equipment_type || "Analyzer"}</div>
          <div><span class="status ${statusClass}"></span></div>
          <div>${device.data_count || 0}</div>
      `;

      table.appendChild(row);
    });
  }


</script>


<style>
  .table-row div:first-child {
      white-space: normal; 
      word-break: break-word; 
      max-width: 150px;
      overflow: visible; 
      display: block; 
  }
</style>

{% endblock %}
