{% extends "layout.html" %} {% block title %} Equipment Settings {% endblock %}
{% block content %}
<!-- Header -->
{% include 'partials/header.html' %}

<div class="equ-set-container">
  <!-- Sol Sidebar -->
  <div class="equ-set-sidebar">
    <button class="equ-set-btn active" data-target="modbus-settings">
      Modbus Settings
    </button>
    <button class="equ-set-btn" data-target="tcp-settings" disabled>
      TCP/IP Settings
    </button>
    <button class="equ-set-btn" data-target="obis-settings" disabled>
      Obis Settings
    </button>
    <button class="equ-set-btn" data-target="equipment-settings">
      Equipment Settings
    </button>
  </div>

  <!-- SaÄŸ Ä°Ã§erik AlanÄ± -->
  <div class="equ-set-content">
    <!-- Modbus Settings -->
    <div id="modbus-settings" class="modbus-setting-form">
      <div class="modbus-setting-row">
        <div class="modbus-setting-group">
          <label>Port</label>
          <select id="portSelect">
            <option value="/dev/ttyUSB0" selected>/dev/ttyUSB0</option>
            <!-- Default -->
            <option value="/dev/ttyUSB1">/dev/ttyUSB1</option>
            <option value="/dev/ttyS0">/dev/ttyS0</option>
            <option value="/dev/ttyS1">/dev/ttyS1</option>
          </select>
        </div>
        <div class="modbus-setting-group">
          <label>Baud Rate</label>
          <select id="baudRateSelect">
            <option value="9600">9600</option>
            <option value="19200" selected>19200</option>
            <!-- Default -->
            <option value="38400">38400</option>
            <option value="57600">57600</option>
            <option value="115200">115200</option>
          </select>
        </div>
      </div>
      <div class="modbus-setting-row">
        <div class="modbus-setting-group">
          <label>Parity</label>
          <select id="paritySelect">
            <option value="None" selected>N</option>
            <!-- Default -->
            <option value="Even">E</option>
            <option value="Odd">O</option>
          </select>
        </div>
        <div class="modbus-setting-group">
          <label>Stop Bits</label>
          <select id="stopBitsSelect">
            <option value="1" selected>1</option>
            <!-- Default -->
            <option value="2">2</option>
          </select>
        </div>
      </div>
      <div class="modbus-setting-row">
        <div class="modbus-setting-group">
          <label>ByteSize</label>
          <select id="byteSizeSelect">
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8" selected>8</option>
            <!-- Default -->
          </select>
        </div>
        <div class="modbus-setting-group">
          <label>Timeout (Seconds)</label>
          <select id="timeoutSelect">
            <option value="0.5">0.5</option>
            <option value="1" selected>1</option>
            <!-- Default -->
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>

      <button class="modbus-setting-btn-test">Test</button>

      <!-- Test Results -->
      <p class="modbus-setting-success">Modbus connection successful</p>
      <p class="modbus-setting-failed">Modbus connection failed</p>
    </div>

    <!-- TCP/IP Settings -->
    <div id="tcp-settings" class="tcp-setting-form" style="display: none">
      <h3>TCP/IP Settings</h3>
    </div>

    <!-- Obis Settings -->
    <div id="obis-settings" class="obis-setting-form" style="display: none">
      <h3>Obis Settings</h3>
    </div>

    <!-- Equipments list Settings  Ä°lk burasÄ± aÃ§Ä±lacak sonra -->
    <div
      id="equipment-set-list"
      class="equipment-set-list-card"
      style="display: none"
    >
      <div class="equipment-set-grid" id="equipment-set-list">
        <!-- Buraya dinamik EQuipmenler veriler gelecek -->
        <div class="equipment-set-box green">DKM411</div>
        <div class="equipment-set-box red">PAC3200</div>
        <div class="equipment-set-box green">MPR-16S-21</div>
        <div class="equipment-set-box red">RGSR-20S-OG</div>
      </div>
    </div>

    <!-- Equipment Settings -->
    <div
      id="equipment-settings"
      class="equip-setting-form"
      style="display: none"
    >
      <div class="equip-setting-card">
        <!--Equipment Name-->
        <div class="equip-setting-group">
          <label>Equipment Name</label>
          <input type="text" placeholder="Equipment Name" />
        </div>

        <!--Equipment Slave ID-->
        <div class="equip-setting-group">
          <label>Equipment Slave ID</label>
          <input type="text" placeholder="Equipment Slave ID" />
        </div>

        <!--Modem Serial No-->
        <div class="equip-setting-group">
          <label>Modem Serial No</label>
          <input type="text" placeholder="Modem Serial No" />
        </div>

        <!--Equipment Serial No-->
        <div class="equip-setting-group">
          <label>Equipment Serial No</label>
          <input type="text" placeholder="Equipment Serial No" />
        </div>

        <!--Electrical ID-->
        <div class="equip-setting-group">
          <label>Electrical ID</label>
          <input type="text" placeholder="Electrical ID" />
        </div>

        <!-- Equipment Status -->
        <div class="equip-setting-group">
          <label>Equipment Status</label>
          <div class="equip-setting-select">
            <select>
              <option value="">Select</option>
              <option value="active">Active</option>
              <option value="passive">Passive</option>
            </select>
            <span class="equip-setting-arrow">&#9662;</span>
          </div>
        </div>

        <!-- Equipment Config Status -->
        <div class="equip-setting-group">
          <label>Equipment Config Status</label>
          <div class="equip-setting-select">
            <select>
              <option value="">Select</option>
              <option value="active">Active</option>
              <option value="passive">Passive</option>
            </select>
            <span class="equip-setting-arrow">&#9662;</span>
          </div>
        </div>

        <!-- Equipment Model -->
        <div class="equip-setting-group">
          <label>Equipment Model</label>
          <div class="equip-setting-select">
            <select>
              <option value="">Select</option>
              <option value="EMR-53CS">EMR-53CS</option>
              <option value="PAC3200">PAC3200</option>
            </select>
            <span class="equip-setting-arrow">&#9662;</span>
          </div>
        </div>

        <!-- Equipment Brand -->
        <div class="equip-setting-group">
          <label>Equipment Brand</label>
          <div class="equip-setting-select">
            <select>
              <option value="">Select</option>
              <option value="entes">Entes</option>
              <option value="datacom">Datacom</option>
            </select>
            <span class="equip-setting-arrow">&#9662;</span>
          </div>
        </div>

        <!-- Multiplier Values -->
        <div class="equip-setting-group">
          <label>Multiplier Values</label>
          <div class="equip-setting-select">
            <select>
              <option value="">Select</option>
              <option value="1">1x</option>
              <option value="2">2x</option>
              <option value="3">3x</option>
            </select>
            <span class="equip-setting-arrow">&#9662;</span>
            <!-- AÅŸaÄŸÄ± bakan ok -->
          </div>
        </div>

        <!-- Gmt -->
        <div class="equip-setting-group">
          <label>Gmt</label>
          <div class="equip-setting-select">
            <select>
              <option value="">Select</option>
              <option value="gmt-3">GMT -3</option>
              <option value="gmt+0">GMT +0</option>
              <option value="gmt+3">GMT +3</option>
            </select>
            <span class="equip-setting-arrow">&#9662;</span>
          </div>
        </div>

        <!-- Daylight Saving Time -->
        <div class="equip-setting-group">
          <label>Daylight Saving Time</label>
          <div class="equip-setting-select">
            <select>
              <option value="">Select</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
            <span class="equip-setting-arrow">&#9662;</span>
          </div>
        </div>
        <button class="equip-setting-save-btn">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const buttons = document.querySelectorAll(".equ-set-btn");
    const sections = document.querySelectorAll(
        ".modbus-setting-form, .tcp-setting-form, .obis-setting-form, .equip-setting-form, .equipment-set-list-card"
    );

    const equipmentSettingsButton = document.querySelector('[data-target="equipment-settings"]');
    const equipmentSetList = document.getElementById("equipment-set-list");
    const equipmentSettings = document.getElementById("equipment-settings");
    const equipmentGrid = document.querySelector(".equipment-set-grid"); 

    // Ä°lk baÅŸta sadece Modbus ayarlarÄ± gÃ¶sterilsin, Equipment list ve settings gizli olsun
    sections.forEach((section) => (section.style.display = "none"));
    document.getElementById("modbus-settings").style.display = "block";
    equipmentSetList.style.display = "none";
    equipmentSettings.style.display = "none";

    buttons.forEach((button) => {
        button.addEventListener("click", function () {
            const targetId = this.getAttribute("data-target");

            buttons.forEach((btn) => btn.classList.remove("active"));
            sections.forEach((section) => {
                section.style.display = "none";
            });

            this.classList.add("active");
            document.getElementById(targetId).style.display = "block";
        });
    });

    // "Equipment Settings" butonuna tÄ±klanÄ±nca API'den cihazlarÄ± Ã§ek ve listele
    equipmentSettingsButton.addEventListener("click", function () {
        sections.forEach((section) => (section.style.display = "none"));
        equipmentSetList.style.display = "block"; // Listeyi aÃ§

        fetchEquipments(); // API'den verileri Ã§ek ve listele
    });

    function fetchEquipments() {
        const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

        if (!selectedDeviceIP) {
            console.warn("No device selected for fetching equipments.");
            return;
        }

        fetch("/equipments-with-models", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ip_address: selectedDeviceIP }),
        })
            .then((response) => response.json())
            .then((data) => {
                console.log("Equipments Response:", data);

                if (data.status === "success" && Array.isArray(data.data)) {
                    equipmentGrid.innerHTML = ""; // Ã–nce mevcut listeyi temizle

                    data.data.forEach((device) => {
                        const statusClass = device.status === 1 ? "green" : "red";
                        const equipmentBox = document.createElement("div");

                        equipmentBox.classList.add("equipment-set-box", statusClass);
                        equipmentBox.innerText = device.model_name; // ðŸ“Œ Model ismi gÃ¶sterilecek

                        // ðŸ“Œ Kutulara tÄ±klanÄ±nca detay sayfasÄ±na yÃ¶nlendirme
                        equipmentBox.addEventListener("click", function () {
                            equipmentSetList.style.display = "none";
                            equipmentSettings.style.display = "block";
                        });

                        equipmentGrid.appendChild(equipmentBox);
                    });
                } else {
                    console.warn("No equipments found.");
                    equipmentGrid.innerHTML = "<p style='color: red;'>No equipments found</p>";
                }
            })
            .catch((error) => {
                console.error("Error fetching equipments:", error);
                equipmentGrid.innerHTML = "<p style='color: red;'>Error fetching equipments</p>";
            });
    }
});


  document.addEventListener("DOMContentLoaded", function () {
    const testButton = document.querySelector(".modbus-setting-btn-test");
    const successMessage = document.querySelector(".modbus-setting-success");
    const failureMessage = document.querySelector(".modbus-setting-failed");

    successMessage.style.display = "none";
    failureMessage.style.display = "none";

    testButton.addEventListener("click", function () {
      const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

      if (!selectedDeviceIP) {
        console.warn("No device selected for Modbus test.");
        failureMessage.innerText = "No device selected for Modbus test.";
        failureMessage.style.display = "block";
        return;
      }

      const selectedModbusParams = {
        port: document.getElementById("portSelect").value,
        baudrate: document.getElementById("baudRateSelect").value,
        parity: document.getElementById("paritySelect").value,
        stopbits: document.getElementById("stopBitsSelect").value,
        bytesize: document.getElementById("byteSizeSelect").value,
        timeout: document.getElementById("timeoutSelect").value,
      };

      console.log("Selected Modbus Parameters:", selectedModbusParams);
      testButton.disabled = true;
      testButton.innerHTML = `<span class="spinner"></span> Testing...`;

      // ðŸ“Œ DoÄŸru endpoint Ã§aÄŸrÄ±lÄ±yor: "/modbus_test"
      fetch("/modbus_test", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ip_address: selectedDeviceIP,
          modbus_params: selectedModbusParams,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Response from Backend:", data);

          if (
            data.status === "success" &&
            Array.isArray(data.data) &&
            data.data.length > 0
          ) {
            successMessage.innerText = "Modbus connection successful!";
            successMessage.style.display = "block";
            failureMessage.style.display = "none";

            // ðŸ“Œ Gelen cihaz verisini gÃ¶ster (Ä°lk bulunan cihaz)
            const device = data.data[0];

            // ðŸ“Œ Gelen deÄŸerler varsa deÄŸiÅŸtir, yoksa seÃ§ili deÄŸerleri koru
            if (device.port)
              document.getElementById("portSelect").value = device.port;
            if (device.baudrate && device.baudrate !== "Unknown")
              document.getElementById("baudRateSelect").value = device.baudrate;
            if (device.parity && device.parity !== "Unknown")
              document.getElementById("paritySelect").value = device.parity;
            if (device.stopbits && device.stopbits !== "Unknown")
              document.getElementById("stopBitsSelect").value = device.stopbits;
            if (device.bytesize && device.bytesize !== "Unknown")
              document.getElementById("byteSizeSelect").value = device.bytesize;
          } else {
            failureMessage.innerText = "Modbus test failed: No valid response";
            failureMessage.style.display = "block";
            successMessage.style.display = "none";
          }
        })
        .catch((error) => {
          console.error("Error during Modbus test:", error);
          failureMessage.innerText =
            "Error during Modbus test: " + error.message;
          failureMessage.style.display = "block";
          successMessage.style.display = "none";
        })
        .finally(() => {
          testButton.disabled = false;
          testButton.innerHTML = "Test";
        });
    });
  });
</script>
{% endblock %}
