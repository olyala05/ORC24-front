{% extends "layout.html" %} {% block title %} {{ _('Equipment Settings')}} {%
endblock %} {% block content %}
<!-- Header -->
{% include 'partials/header.html' %}

<div class="equ-set-container">
  <!-- Sol Sidebar -->
  <div class="equ-set-sidebar">
    <button class="equ-set-btn active" data-target="modbus-settings">
      {{ _('Modbus Settings')}}
    </button>
    <button class="equ-set-btn" data-target="tcp-settings" disabled>
      {{ _('TCP/IP Settings')}}
    </button>
    <button class="equ-set-btn" data-target="obis-settings" disabled>
      {{ _('Obis Settings')}}
    </button>
    <button class="equ-set-btn" data-target="equipment-settings">
      {{ _('Equipment Settings')}}
    </button>
  </div>

  <!-- Sağ İçerik Alanı -->
  <div class="equ-set-content">
    <!-- Modbus Settings -->
    <div id="modbus-settings" class="modbus-setting-form">
      <div class="modbus-setting-row">
        <div class="modbus-setting-group">
          <label>Port</label>
          <select id="portSelect">
            <option value="/dev/ttyACM0">/dev/ttyACM0</option>
            <option value="/dev/ttyUSB0" selected>/dev/ttyUSB0</option>
            <!-- Default -->
            <option value="/dev/ttyUSB1">/dev/ttyUSB1</option>
            <option value="/dev/ttyS0">/dev/ttyS0</option>
            <option value="/dev/ttyS1">/dev/ttyS1</option>
          </select>
        </div>
        <div class="modbus-setting-group">
          <label>Baud Rate</label>
          <select id="baudRateSelect">
            <option value="9600">9600</option>
            <option value="19200" selected>19200</option>
            <!-- Default -->
            <option value="38400">38400</option>
            <option value="57600">57600</option>
            <option value="115200">115200</option>
          </select>
        </div>
      </div>
      <div class="modbus-setting-row">
        <div class="modbus-setting-group">
          <label>Parity</label>
          <select id="paritySelect">
            <option value="None" selected>N</option>
            <!-- Default -->
            <option value="Even">E</option>
            <option value="Odd">O</option>
          </select>
        </div>
        <div class="modbus-setting-group">
          <label>Stop Bits</label>
          <select id="stopBitsSelect">
            <option value="1" selected>1</option>
            <!-- Default -->
            <option value="2">2</option>
          </select>
        </div>
      </div>
      <div class="modbus-setting-row">
        <div class="modbus-setting-group">
          <label>ByteSize</label>
          <select id="byteSizeSelect">
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8" selected>8</option>
            <!-- Default -->
          </select>
        </div>
        <div class="modbus-setting-group">
          <label>Timeout (Seconds)</label>
          <select id="timeoutSelect">
            <option value="0.5">0.5</option>
            <option value="1" selected>1</option>
            <!-- Default -->
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>

      <button class="modbus-setting-btn-test">{{ _('Test')}}</button>

      <!-- Test Results -->
      <p class="modbus-setting-success">
        {{ _('Modbus connection successful')}}
      </p>
      <p class="modbus-setting-failed">{{ _('Modbus connection failed')}}</p>
    </div>

    <!-- TCP/IP Settings -->
    <div id="tcp-settings" class="tcp-setting-form" style="display: none">
      <h3>{{ _('TCP/IP Settings') }}</h3>
    </div>

    <!-- Obis Settings -->
    <div id="obis-settings" class="obis-setting-form" style="display: none">
      <h3>{{ _('Obis Settings') }}</h3>
    </div>

    <!-- Equipments list Settings  İlk burası açılacak sonra -->
    <div
      id="equipment-set-list"
      class="equipment-set-list-card"
      style="display: none"
    >
      <div class="equipment-set-grid" id="equipment-set-list">
        <!-- Buraya dinamik EQuipmenler veriler gelecek -->
        <div class="equipment-set-box green">DKM411</div>
        <div class="equipment-set-box red">PAC3200</div>
        <div class="equipment-set-box green">MPR-16S-21</div>
        <div class="equipment-set-box red">RGSR-20S-OG</div>
      </div>
    </div>

    <!-- Equipment Settings -->
    <div
      id="equipment-settings"
      class="equip-setting-form"
      style="display: none"
    >
      <div class="equip-setting-card">
        <!-- Equipment Name -->
        <div class="equip-setting-group">
          <label>{{ _('Equipment Name') }}</label>
          <input type="text" id="equipment-name" />
        </div>

        <!-- Equipment Status (select) -->
        <div class="equip-setting-group">
          <label>{{ _('Equipment Status') }}</label>
          <select id="equipment-status">
            <option value="1">{{ _('Active') }}</option>
            <option value="0">{{ _('Passive') }}</option>
          </select>
        </div>
        <!-- Installation Power -->
        <div class="equip-setting-group">
          <label>{{ _('Installation Power (W)') }}</label>
          <input type="number" id="installation-power" />
        </div>

        <!-- Phase 1 Current -->
        <div class="equip-setting-group">
          <label>{{ _('Phase 1 Current (A)') }}</label>
          <input type="text" id="phase1-current" />
        </div>

        <!-- Phase 2 Current -->
        <div class="equip-setting-group">
          <label>{{ _('Phase 2 Current (A)') }}</label>
          <input type="text" id="phase2-current" />
        </div>

        <!-- Phase 3 Current -->
        <div class="equip-setting-group">
          <label>{{ _('Phase 3 Current (A)') }}</label>
          <input type="text" id="phase3-current" />
        </div>

        <button class="equip-setting-save-btn">{{ _('Save') }}</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const buttons = document.querySelectorAll(".equ-set-btn");
    const sections = document.querySelectorAll(
      ".modbus-setting-form, .tcp-setting-form, .obis-setting-form, .equip-setting-form, .equipment-set-list-card"
    );

    const equipmentSettingsButton = document.querySelector(
      '[data-target="equipment-settings"]'
    );
    const equipmentSetList = document.getElementById("equipment-set-list");
    const equipmentSettings = document.getElementById("equipment-settings");
    const equipmentGrid = document.querySelector(".equipment-set-grid");

    // 📌 İlk başta sadece Modbus ayarları gösterilsin
    sections.forEach((section) => (section.style.display = "none"));
    document.getElementById("modbus-settings").style.display = "block";
    equipmentSetList.style.display = "none";
    equipmentSettings.style.display = "none";

    buttons.forEach((button) => {
      button.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");

        buttons.forEach((btn) => btn.classList.remove("active"));
        sections.forEach((section) => {
          section.style.display = "none";
        });

        this.classList.add("active");
        document.getElementById(targetId).style.display = "block";
      });
    });

    equipmentSettingsButton.addEventListener("click", function () {
      sections.forEach((section) => (section.style.display = "none"));
      equipmentSetList.style.display = "block";
      fetchEquipments();
    });

    function fetchEquipments() {
      const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

      if (!selectedDeviceIP) {
        console.warn("No device selected for fetching equipments.");
        return;
      }

      fetch("/equipments-with-models", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ip_address: selectedDeviceIP }),
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Equipments Response:", data);

          if (data.status === "success" && Array.isArray(data.data)) {
            equipmentGrid.innerHTML = "";

            data.data.forEach((device) => {
              const statusClass = device.status === "A" ? "green" : "red";
              const equipmentBox = document.createElement("div");

              equipmentBox.classList.add("equipment-set-box", statusClass);
              equipmentBox.innerText = device.model_name;
              equipmentBox.dataset.equipmentId = device.id;

              equipmentGrid.appendChild(equipmentBox);
            });
          } else {
            console.warn("{{ _('No equipments found')}}");
            equipmentGrid.innerHTML =
              "<p style='color: red;'>{{ _('No equipments found')}}</p>";
          }
        })
        .catch((error) => {
          console.error("{{ _('Error fetching equipments')}}:", error);
          equipmentGrid.innerHTML =
            "<p style='color: red;'>{{ _('Error fetching equipments')}}</p>";
        });
    }

    document.addEventListener("click", function (event) {
      const clickedEquipment = event.target.closest(".equipment-set-box");

      if (!clickedEquipment) return;

      const equipmentId = clickedEquipment.dataset.equipmentId;
      console.log("Clicked Equipment ID:", equipmentId);

      if (!equipmentId) return;

      sessionStorage.setItem("selected_equipment_id", equipmentId);
      fetchEquipmentDetails(equipmentId);
    });

    let currentEquipmentUUID = "";

    function fetchEquipmentDetails(equipmentId) {
      const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

      fetch(`http://${selectedDeviceIP}:8085/get_equipments`)
        .then((response) => response.json())
        .then((data) => {
          const equipments = data.data || [];
          const equipment = equipments.find((eq) => eq.id == equipmentId);

          if (!equipment || !equipment.uuid) {
            throw new Error("{{ _('UUID not found!') }}");
          }

          currentEquipmentUUID = equipment.uuid; 

          return fetch(`/get_equipment_from_cloud/${currentEquipmentUUID}`);
        })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success" && data.data) {
            const equipment = data.data;

            document.getElementById("equipment-name").value = equipment.name;
            if (equipment.status === 1 || equipment.status === 0) {
              document.getElementById("equipment-status").value =
                equipment.status.toString();
            } else {
              console.warn("Bilinmeyen status değeri:", equipment.status);
            }
            document.getElementById("installation-power").value =
              equipment.installation_power;
            document.getElementById("phase1-current").value =
              equipment.phase_1_current;
            document.getElementById("phase2-current").value =
              equipment.phase_2_current;
            document.getElementById("phase3-current").value =
              equipment.phase_3_current;

            document.getElementById("equipment-set-list").style.display =
              "none";
            document.getElementById("equipment-settings").style.display =
              "block";
          }
        })
        .catch((error) => {
          console.error("Hata:", error);
        });
    }

    // Save Butonu
    document
      .querySelector(".equip-setting-save-btn")
      .addEventListener("click", function () {
        const equipmentData = {
          name: document.getElementById("equipment-name").value.trim(),
          status: parseInt(document.getElementById("equipment-status").value),
          installation_power: parseInt(
            document.getElementById("installation-power").value
          ),
          phase_1_current: parseFloat(
            document.getElementById("phase1-current").value
          ),
          phase_2_current: parseFloat(
            document.getElementById("phase2-current").value
          ),
          phase_3_current: parseFloat(
            document.getElementById("phase3-current").value
          ),
        };

        if (!currentEquipmentUUID) {
          showErrorAlert("{{ _('UUID not found!') }}");
          return;
        }

        showLoading("{{ _('Updating...') }}");

        fetch(`/update_equipment_cloud/${currentEquipmentUUID}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(equipmentData),
        })
          .then((response) => response.json())
          .then((data) => {
            hideLoading();
            if (data.status === "success") {
              showSuccessAlert("{{ _('Equipment updated!') }}");

              // 🌟 Buluttan cihazına senkronizasyon isteği
              fetch(`/sync_equipment_local/${currentEquipmentUUID}`)
                .then((syncRes) => syncRes.json())
                .then((syncData) => {
                  if (syncData.status === "success") {
                    console.log("✅ Cihaza başarıyla senkronize edildi!");
                  } else {
                    console.error("❌ Sync hatası:", syncData.message);
                  }
                });
            } else {
              showErrorAlert("{{ _('Error!') }}", data.message);
            }
          });
      });
  });

  document.addEventListener("DOMContentLoaded", function () {
    const testButton = document.querySelector(".modbus-setting-btn-test");
    const successMessage = document.querySelector(".modbus-setting-success");
    const failureMessage = document.querySelector(".modbus-setting-failed");

    successMessage.style.display = "none";
    failureMessage.style.display = "none";

    testButton.addEventListener("click", function () {
      const selectedDeviceIP = sessionStorage.getItem("selected_device_ip");

      if (!selectedDeviceIP) {
        console.warn("{{ _('No device selected for Modbus test.')}}");
        failureMessage.innerText =
          "{{ _('No device selected for Modbus test')}}.";
        failureMessage.style.display = "block";
        return;
      }

      const selectedModbusParams = {
        port: document.getElementById("portSelect").value,
        baudrate: document.getElementById("baudRateSelect").value,
        parity: document.getElementById("paritySelect").value,
        stopbits: document.getElementById("stopBitsSelect").value,
        bytesize: document.getElementById("byteSizeSelect").value,
        timeout: document.getElementById("timeoutSelect").value,
      };

      console.log("Selected Modbus Parameters:", selectedModbusParams);
      testButton.disabled = true;
      testButton.innerHTML = `<span class="spinner"></span> {{ _('Testing...')}}`;
      fetch("/modbus_test", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ip_address: selectedDeviceIP,
          modbus_params: selectedModbusParams,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Response from Backend:", data);
          if (
            data.status === "success" &&
            Array.isArray(data.data) &&
            data.data.length > 0
          ) {
            successMessage.innerText =
              "{{ _('Modbus connection successful!')}}";
            successMessage.style.display = "block";
            failureMessage.style.display = "none";
            const device = data.data[0];
            if (device.port)
              document.getElementById("portSelect").value = device.port;
            if (device.baudrate && device.baudrate !== "{{ _('Unknown')}}")
              document.getElementById("baudRateSelect").value = device.baudrate;
            if (device.parity && device.parity !== "{{ _('Unknown')}}")
              document.getElementById("paritySelect").value = device.parity;
            if (device.stopbits && device.stopbits !== "{{ _('Unknown')}}")
              document.getElementById("stopBitsSelect").value = device.stopbits;
            if (device.bytesize && device.bytesize !== "{{ _('Unknown')}}")
              document.getElementById("byteSizeSelect").value = device.bytesize;
          } else {
            failureMessage.innerText =
              "{{ _('Modbus test failed: No valid response')}}";
            failureMessage.style.display = "block";
            successMessage.style.display = "none";
          }
        })
        .catch((error) => {
          console.error("{{ _('Error during Modbus test')}}:", error);
          failureMessage.innerText =
            "{{ _('Error during Modbus test')}}: " + error.message;
          failureMessage.style.display = "block";
          successMessage.style.display = "none";
        })
        .finally(() => {
          testButton.disabled = false;
          testButton.innerHTML = "Test";
        });
    });
  });
</script>
{% endblock %}
