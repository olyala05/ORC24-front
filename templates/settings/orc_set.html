{% extends "layout.html" %} {% block title %} {{ _('ORC Settings')}} {% endblock
%} {% block content %}
<!-- Header -->
{% include 'partials/header.html' %}
<!-- Virtual Keyboard -->
<div id="keyboard-container" class="simple-keyboard"></div>

<!-- Yeni İçerik (İlk başta gizli olacak) -->
<div class="settings-content">
  <div class="orc-sidebar-set">
    <button class="tab-btn-set" data-target="wifi-set">
      {{ _('Wi-fi Settings')}}
    </button>
    <button class="tab-btn-set" data-target="lora-set" disabled>
      {{ _('LoRa Settings')}}
    </button>
    <!--
    <button class="tab-btn-set" data-target="eth-set" disabled>
      {{ _('Ethernet Settings')}}
    </button>
    -->
    <button class="tab-btn-set" data-target="gsm-set" disabled>
      {{ _('GSM Settings')}}
    </button>
    <button class="tab-btn-set" data-target="orc-set">
      {{ _('ORC Settings')}}
    </button>
  </div>

  <div class="content-area-set">
    <!-- Wi-Fi Set -->
    <div id="wifi-set" class="tab-content-set">
      <div class="wifi-container-set">
        <!-- Wi-Fi Password Form -->
        <div class="wifi-connection-set">

          <!-- Connected Wi-Fi -->
          <div class="wifi-card-set connected">
            <h4>{{ _('Connected')}}</h4>
            <div class="underline"></div>
            <div class="wifi-info-set">
              <img
                src="{{ url_for('static', filename='images/svg/12.svg') }}"
                alt="No Wi-Fi"
              />
              <span id="connected-wifi">{{ _('Not Connected')}}</span>
              <!-- -->
              <button class="btn disconnect" id="disconnect-btn">
                {{ _('Disconnect')}}
              </button>
            </div>
          </div>

          <div class="wifi-card-set">
            <div class="wifi-icon-set">
              <img
                src="{{ url_for('static', filename='images/svg/12.svg') }}"
                alt="No Wi-Fi"
              />
              <p id="wifi-ssid">{{ _('Wi-Fi SSID:')}} <span>{{ _('Not Connected')}}</span></p>
            </div>
            <div class="password-intput-set">
              <label>{{ _('Password:')}}</label>
              <input type="password" id="wifi-password" />
            </div>
            <div class="show-password-set">
              <input type="checkbox" id="showPass" class="check-box-set" />
              <label for="showPass" class="show-pass"
                >{{ _('Show Password')}}</label
              >
            </div>
            <div class="btn-group-set">
              <button class="btn-set cancel-set">{{ _('Cancel')}}</button>
              <button class="btn-set connec-set" id="connect-btn">
                {{ _('Connect')}}
              </button>
            </div>
          </div>

        </div>
        <!-- Available Wi-Fi -->
        <div class="network-box-set">
          <div id="wifi-list" class="wifi-list-set">
            <h4 style="margin: 6px 0 5px 0px; padding: 0; padding: 0 20px">
              {{ _('Available Wi-Fi')}}
            </h4>
            <div class="available-wifi-underline"></div>
            <ul id="wifi-networks">
              <!-- Buraya dinamik Wi-Fi listesi gelecek -->
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- LoRa Set -->
    <div id="lora-set" class="lora-settings-container" style="display: none">
      <div class="lora-settings-card">
        <h3>{{ _('LoRa Settings')}}</h3>
      </div>
    </div>

    <!-- !! Ethernet Set Yeni versiyonda Kaldırıldı !! -->
    <!--  <div id="eth-set" class="eth-settings-container" style="display: none">
      <div class="eth-settings-card">
        <h3>{{ _('Ethernet Settings')}}</h3>
      </div>
    </div> 
    -->

    <!-- GSM Set -->
    <div id="gsm-set" class="gsm-settings-container" style="display: none">
      <div class="gsm-settings-card">
        <h3>{{ _('GSM Settings')}}</h3>
      </div>
    </div>

    <!-- ORC Set -->
    <div id="orc-set" class="orc-settings-container" style="display: none">
      <div class="orc-settings-card">
        <div class="orc-input-group">
          <label>{{ _('Modem Name')}}</label>
          <input type="text" placeholder="{{ _('Modem Name')}}" readonly />
        </div>

        <div class="orc-input-group">
          <label>{{ _('Modem Status')}}</label>
          <select>
            <option value="active">{{ _('Active')}}</option>
            <option value="inactive">{{ _('Inactive')}}</option>
          </select>
        </div>

        <div class="orc-input-group">
          <label>{{ _('Query Update Time (Hour - Minute)')}}</label>
          <select>
            <option value="">{{ _('Select')}}</option>
            <option value="00:30">00:30</option>
            <option value="01:00">01:00</option>
            <option value="01:30">01:30</option>
            <option value="02:00">02:00</option>
          </select>
        </div>
        <button class="orc-save-btn">{{ _('Save')}}</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const tabButtons = document.querySelectorAll(".tab-btn-set");
      const tabContents = document.querySelectorAll(".content-area-set > div");
      tabButtons.forEach((button) => {
        button.addEventListener("click", function () {
          const targetId = this.getAttribute("data-target");

          tabContents.forEach((content) => (content.style.display = "none"));

          tabButtons.forEach((btn) => btn.classList.remove("active"));

          this.classList.add("active");

          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            targetElement.style.display = "block";
          }
        });
      });

      if (tabButtons.length > 0) {
        tabButtons[0].click();
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      const wifiListElement = document.getElementById("wifi-networks");
      const wifiPasswordInput = document.getElementById("wifi-password");
      const wifiSSIDElement = document
        .getElementById("wifi-ssid")
        .querySelector("span");
      const connectedWifiSpan = document.getElementById("connected-wifi");
      const connectButton = document.getElementById("connect-btn");
      const disconnectButton = document.getElementById("disconnect-btn");
      const showPasswordCheckbox = document.getElementById("showPass");
      let selectedSSID = null;

      function fetchWifiNetworks() {
        fetch("/wi-fi-list", { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            if (data.status !== "success") {
              wifiListElement.innerHTML = `<p style='color: red;'>${data.message}</p>`;
              return;
            }

            let networks = data.data.wifi_networks || [];
            const connectedSSID = data.data.connected_ssid || null;
            const connectedPassword = data.data.wifi_password || "";

            let wifiHTML = "";

            // Bağlı Wi-Fi'yi en üste taşı
            if (connectedSSID) {
              networks = networks.filter((ssid) => ssid !== connectedSSID);
              networks.unshift(connectedSSID);
            }

            networks.forEach((ssid) => {
              const isConnected =
                ssid === connectedSSID ? "wifi-connected" : "";
              wifiHTML += `
                          <li onclick="selectWifi('${ssid}')" class="${isConnected}">
                              <img src="/static/images/svg/25.svg" alt="Wi-Fi"/>
                              <span>${ssid}</span>
                              <img src="/static/images/svg/26.svg" alt="Lock"/>
                          </li>
                      `;
            });

            wifiListElement.innerHTML = wifiHTML;

            if (connectedSSID) {
              selectedSSID = connectedSSID;
              wifiSSIDElement.innerText = connectedSSID;
              connectedWifiSpan.innerText = connectedSSID;
              wifiPasswordInput.value = connectedPassword;
            } else {
              connectedWifiSpan.innerText = "{{ _('Not Connected')}}";
            }
          })
          .catch((error) => {
            console.error("{{ _('Wi-Fi networks loading error')}}:", error);
            wifiListElement.innerHTML =
              "<p style='color: red;'>{{ _('Wi-Fi information could not be retrieved')}}.</p>";
          });
      }

      window.selectWifi = function (ssid) {
        selectedSSID = ssid;
        wifiSSIDElement.innerText = ssid;
        wifiPasswordInput.value = "";
      };

      // Şifreyi göster/gizle
      showPasswordCheckbox.addEventListener("change", function () {
        wifiPasswordInput.type = this.checked ? "text" : "password";
      });

      // Wi-Fi ağına bağlan
      connectButton.addEventListener("click", function () {
        if (!selectedSSID) {
          Swal.fire({
            icon: "warning",
            title: "{{ _('Wi-Fi not selected!')}}",
            text: "{{ _('Please select a Wi-Fi network.')}}",
            width: "280px",
            customClass: {
              popup: "small-swal-popup",
            },
          });
          return;
        }

        const password = wifiPasswordInput.value;
        if (!password) {
          Swal.fire({
            icon: "warning",
            title: "{{ _('Password not entered!')}}",
            text: "{{ _('Please enter the password.')}}",
            width: "280px",
            customClass: {
              popup: "small-swal-popup",
            },
          });
          return;
        }

        // Butonu loading durumuna geçir
        connectButton.disabled = true;
        connectButton.innerHTML = `<span class="spinner"></span> {{ _('Connecting...')}}`;

        // Bağlantıyı başlat
        fetch("/connect_wifi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ssid: selectedSSID, password: password }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              Swal.fire({
                icon: "success",
                title: "{{ _('Connection Successful!')}}",
                text: `{{ _('Wi-Fi connection successfully established')}}: ${selectedSSID}`,
                width: "280px",
                customClass: {
                  popup: "small-swal-popup",
                },
              });

              connectedWifiSpan.innerText = selectedSSID;
              fetchWifiNetworks();
            } else {
              Swal.fire({
                icon: "error",
                title: "{{ _('Connection Failed!')}}",
                text:
                  data.message ||
                  "{{ _('Unable to connect. Please try again.')}}",
                width: "280px",
                customClass: {
                  popup: "small-swal-popup",
                },
              });
            }
          })
          .catch((error) => {
            console.error(
              "{{ _('Error occurred during Wi-Fi connection')}}:",
              error
            );
            Swal.fire({
              icon: "error",
              title: "{{ _('Connection Error!')}}",
              text: "{{ _('An error occurred while establishing the Wi-Fi connection.')}}",
              width: "280px",
              customClass: {
                popup: "small-swal-popup",
              },
            });
          })
          .finally(() => {
            // Butonu eski haline getirir
            connectButton.disabled = false;
            connectButton.innerHTML = "{{ _('Connect')}}";
          });
      });

      // Wi-Fi Disconnection
      disconnectButton.addEventListener("click", function () {
        if (connectedWifiSpan.innerText === "{{ _('Not Connected')}}") {
          Swal.fire({
            icon: "info",
            title: "{{ _('No Active Connection!')}}",
            text: "{{ _('You are not currently connected to any Wi-Fi network.')}}",
            width: "280px",
            customClass: {
              popup: "small-swal-popup",
            },
          });
          return;
        }

        Swal.fire({
          icon: "warning",
          title: "{{ _('Disconnect Wi-Fi?')}}",
          text: "{{ _('Are you sure you want to disconnect from the Wi-Fi network?')}}",
          width: "280px",
          showCancelButton: true,
          confirmButtonText: "{{ _('Yes, disconnect')}}",
          cancelButtonText: "{{ _('Cancel')}}",
          customClass: {
            popup: "small-swal-popup",
            confirmButton: "btn-confirm",
            cancelButton: "btn-cancel",
          },
        }).then((result) => {
          if (result.isConfirmed) {
            disconnectButton.disabled = true;
            disconnectButton.innerHTML = `<span class="spinner"></span> {{ _('Disconnecting...')}}`;

            fetch("/disconnect_wifi", { method: "POST" })
              .then((response) => response.json())
              .then((data) => {
                if (data.status === "success") {
                  Swal.fire({
                    icon: "success",
                    title: "{{ _('Wi-Fi Disconnected!')}}",
                    text: "{{ _('You have successfully disconnected from the Wi-Fi network.')}}",
                    width: "280px",
                    customClass: {
                      popup: "small-swal-popup",
                    },
                  });
                  wifiListElement.innerHTML = "";
                  wifiSSIDElement.innerText = "{{ _('Not Connected')}}";
                  wifiPasswordInput.value = "";
                  connectedWifiSpan.innerText = "{{ _('Not Connected')}}";
                  fetchWifiNetworks();
                } else {
                  Swal.fire({
                    icon: "error",
                    title: "{{ _('Disconnection Failed!')}}",
                    text:
                      data.message ||
                      "{{ _('An error occurred while disconnecting from Wi-Fi.')}}",
                    width: "280px",
                    customClass: {
                      popup: "small-swal-popup",
                    },
                  });
                }
              })
              .catch((error) => {
                console.error("{{ _('Error while disconnecting')}}:", error);
                Swal.fire({
                  icon: "error",
                  title: "{{ _('Disconnection Error!')}}",
                  text: "{{ _('An unexpected error occurred while disconnecting.')}}",
                  width: "280px",
                  customClass: {
                    popup: "small-swal-popup",
                  },
                });
              })
              .finally(() => {
                disconnectButton.disabled = false;
                disconnectButton.innerHTML = "{{ _('Disconnect')}}";
              });
          }
        });
      });

      fetchWifiNetworks();
    });

    document.addEventListener("DOMContentLoaded", function () {
      const modemNameInput = document.querySelector(
        "#orc-set .orc-input-group input"
      );
      const modemStatusSelect = document.querySelector(
        "#orc-set .orc-input-group select"
      );

      function fetchModemInfo() {
        fetch("/get_modem_info")
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              const modem = data.data;

              modemNameInput.value =
                modem.name && modem.name.trim() ? modem.name : "-";

              modemStatusSelect.value =
                modem.status && modem.status.trim()
                  ? modem.status.toLowerCase()
                  : "-";

              console.log("{{ _('Modem Info')}}:", modem);
            } else {
              console.error(
                "{{ _('Failed to load modem info')}}:",
                data.message
              );
              modemNameInput.value = "-";
              modemStatusSelect.value = "-";
            }
          })
          .catch((error) => {
            console.error("{{ _('Error while fetching modem info')}}:", error);
            modemNameInput.value = "-";
            modemStatusSelect.value = "-";
          });
      }
      fetchModemInfo();
    });
  </script>

  <style>
    .wifi-connected span {
      color: green;
      font-weight: bold;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 5px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .small-swal-popup {
      font-size: 14px !important;
      padding: 10px !important;
      max-width: 280px !important;
    }

    .swal2-title {
      font-size: 14px !important;
    }

    .swal2-content {
      font-size: 14px !important;
    }

    .btn-confirm {
      background-color: #ef742a !important; /* Red button */
      color: white !important;
    }

    .btn-cancel {
      background-color: #6c757d !important; /* Grey button */
      color: white !important;
    }
  </style>
  {% endblock %}
</div>
