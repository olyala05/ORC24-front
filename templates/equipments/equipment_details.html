{% extends "layout.html" %} {% block title %} Equipment Details {% endblock %}
{% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/equipment.scss') }}"
/>
{% endblock %} {% block content %}

<!-- Header -->
{% include 'partials/header.html' %}

<div class="eq-detail-container">
  <!-- Equipment Details Panel -->
  <div class="eq-detail-panel">
    <div class="eq-detail-info">
      <div class="eq-detail-item">
        <span>Equipment Name:</span>
        <span class="eq-detail-status">EMR-53CS@3630748023</span>
      </div>
      <div class="eq-detail-item"><span>Slave ID:</span> <span>12</span></div>
      <div class="eq-detail-item"><span>Modem Name:</span> <span>-</span></div>
      <div class="eq-detail-item">
        <span>Brand / Model:</span> <span>Entes / 46s</span>
      </div>
      <div class="eq-detail-item">
        <span>Equipment Type:</span> <span>Analyzer</span>
      </div>
      <div class="eq-detail-item">
        <span>Equipment Serial NO:</span> <span>asj-234</span>
      </div>
      <div class="eq-detail-item">
        <span>Activity Status:</span> <span>5</span>
      </div>
      <div class="eq-detail-item">
        <span>Device ID:</span> <span>Active</span>
      </div>
      <div class="eq-detail-item"><span>SID/IP:</span> <span>5</span></div>
      <div class="eq-detail-item">
        <span>Status / Configuration:</span>
        <span class="eq-detail-green">A / A</span>
      </div>
      <div class="eq-detail-item">
        <span>Archive:</span> <span class="eq-detail-dot eq-active"></span>
      </div>
      <div class="eq-detail-item">
        <span>Connection Protocol:</span> <span>Modbus</span>
      </div>
      <div class="eq-detail-item"><span>GMT:</span> <span>+3</span></div>
      <div class="eq-detail-item">
        <span>Daylight Saving Time:</span>
        <span class="eq-detail-dot eq-active"></span>
      </div>
      <div class="eq-detail-item">
        <span>Equipment Date:</span> <span>2024-04-01 10:43:19</span>
      </div>
      <div class="eq-detail-item">
        <span>Connection Date:</span> <span>2024-04-01 10:43:19</span>
      </div>
    </div>
  </div>

  <!-- Archive Log Panel -->
  <div class="eq-detail-log">
    <div class="eq-detail-log-header">
      <span>Archive</span>
      <span>End</span>
    </div>
    <ul class="eq-detail-log-list">
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>Service Started</span>
        </span>
        <span>2024-04-03 13:54:31</span>
      </li>

      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>Modbus connection established</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>32000 register error etc.</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>equipment not found etc.</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>

      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>Modbus Connection</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>Register Read</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>32000 register error etc.</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-passive"></span>
          <span class="eq-detail-dot eq-passive"></span>
          <span>Equipment Data Collecting </span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>Modem Task Cycle</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-passive"></span>
          <span>Data Transfer Cycle</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
    </ul>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let equipmentContainer = document.querySelector(".eq-detail-info");
  
    function fetchModems() {
      return fetch("/get_modem_info")
        .then((response) => response.json())
        .then((data) => {
          if (data.status !== "success" || !data.data) {
            console.error("❌ Modem verisi alınamadı:", data.message);
            return null;
          }
          return data.data; // Modem bilgisi döndür
        })
        .catch((error) => {
          console.error("❌ Modem bilgisi alınırken hata oluştu:", error);
          return null;
        });
    }
  
    function fetchEquipmentDetails() {
      return fetch("/fetch_equipment_details")
        .then((response) => response.json())
        .then((data) => {
          if (data.status !== "success") {
            equipmentContainer.innerHTML = `<p style='color: red;'>${data.message}</p>`;
            return null;
          }
          return data.data; // Ekipman bilgisi döndür
        })
        .catch((error) => {
          console.error("❌ Ekipman detayları yüklenirken hata oluştu:", error);
          equipmentContainer.innerHTML =
            "<p style='color: red;'>Ekipman bilgisi alınamadı.</p>";
          return null;
        });
    }
  
    // **Modem ve ekipman bilgilerini aynı anda çek**
    Promise.all([fetchEquipmentDetails(), fetchModems()]).then(
      ([equipment, modem]) => {
        if (!equipment) return;
  
        document.querySelector(".eq-detail-status").innerText = `${
          equipment.model_name || "Bilinmiyor"
        }@${equipment.serial_number || "N/A"}`;
  
        // **Modem Bilgisi Güncelle**
        document.querySelector(
          ".eq-detail-item:nth-child(3) span:last-child"
        ).innerText = modem && modem.name ? modem.name : "Modem Bulunamadı";
  
        document.querySelector(
          ".eq-detail-item:nth-child(4) span:last-child"
        ).innerText = `${equipment.brand_name || "N/A"} / ${
          equipment.model_name || "N/A"
        }`;
  
        document.querySelector(
          ".eq-detail-item:nth-child(2) span:last-child"
        ).innerText = equipment.modbus_address || "N/A";
        document.querySelector(
          ".eq-detail-item:nth-child(5) span:last-child"
        ).innerText = equipment.equipment_type || "Analyzer";
        document.querySelector(
          ".eq-detail-item:nth-child(6) span:last-child"
        ).innerText = equipment.serial_number || "N/A";
        document.querySelector(
          ".eq-detail-item:nth-child(8) span:last-child"
        ).innerText = equipment.device_id || "N/A";
        document.querySelector(
          ".eq-detail-item:nth-child(9) span:last-child"
        ).innerText = equipment.modbus_address || "N/A";
  
        let protocolText = "N/A";
        if (equipment.communication_protocol_code == 1) {
          protocolText = "SERIAL";
        } else if (equipment.communication_protocol_code == 2) {
          protocolText = "TCP";
        }
        document.querySelector(
          ".eq-detail-item:nth-child(12) span:last-child"
        ).innerText = protocolText;
  
        document.querySelector(
          ".eq-detail-item:nth-child(15) span:last-child"
        ).innerText = formatDate(equipment.created_at);
        document.querySelector(
          ".eq-detail-item:nth-child(16) span:last-child"
        ).innerText = formatDate(equipment.updated_at);
      }
    );
  
    function formatDate(dateString) {
      if (!dateString) return "N/A";
      let date = new Date(dateString);
      return (
        date.getFullYear() +
        "-" +
        String(date.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(date.getDate()).padStart(2, "0") +
        " " +
        String(date.getHours()).padStart(2, "0") +
        ":" +
        String(date.getMinutes()).padStart(2, "0") +
        ":" +
        String(date.getSeconds()).padStart(2, "0")
      );
    }
  });
  
</script>

{% endblock %}
