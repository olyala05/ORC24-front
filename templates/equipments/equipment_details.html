{% extends "layout.html" %} 

{% block title %} {{ _('Equipment Details') }} {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/equipment.scss') }}" />
{% endblock %} 

{% block content %}
<!-- Header -->
{% include 'partials/header.html' %}

<div class="eq-detail-container">
  <!-- Equipment Details Panel -->
  <div class="eq-detail-panel">
    <div class="eq-detail-info">
      <div class="eq-detail-item">
        <span>{{ _('Equipment Name')}}</span>
        <span class="eq-detail-status">EMR-53CS@3630748023</span>
      </div>
      <div class="eq-detail-item"><span>{{ _('Slave ID') }}</span> <span>12</span></div>
      <div class="eq-detail-item"><span>{{ _('Modem Name') }}</span> <span>-</span></div>
      <div class="eq-detail-item">
        <span>{{ _('Brand / Model')}}</span> <span>Entes / 46s</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Equipment Type')}}</span> <span>{{ _('Analyzer')}}</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Equipment Serial NO')}}</span> <span>asj-234</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Activity Status')}}</span> <span>5</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Device ID')}}</span> <span>{{ _('Active')}}</span>
      </div>
      <div class="eq-detail-item"><span>{{ _('SID/IP')}}</span> <span>5</span></div>
      <div class="eq-detail-item">
        <span>{{ _('Status / Configuration')}}</span>
        <span class="eq-detail-green">A / A</span>
      </div>

      <div class="eq-detail-item">
        <span>{{ _('Connection Protocol') }}</span> <span>Modbus</span>
      </div>
      <div class="eq-detail-item"><span>{{ _('GMT')}}</span> <span>+3</span></div>
      <div class="eq-detail-item">
        <span>{{ _('Daylight Saving Time') }}</span>
        <span class="eq-detail-dot eq-active"></span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Date Created') }}</span> <span>2024-04-01 10:43:19</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Last Connection Date') }}</span> <span>2024-04-01 10:43:19</span>
      </div>
    </div>
  </div>

  <!-- Archive Log Panel -->
  <div class="eq-detail-log">
    <div class="eq-detail-log-header">
      <span>{{ _('Archive') }}</span>
      <span>{{ _('End')}}</span>
    </div>
    <ul class="eq-detail-log-list">
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Service Started')}}</span>
        </span>
        <span>2024-04-03 13:54:31</span>
      </li>

      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Modbus connection established')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('32000 register error etc.')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Equipment not found etc.')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>

      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Modbus Connection')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Register Read')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('32000 register error etc.')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-passive"></span>
          <span class="eq-detail-dot eq-passive"></span>
          <span>{{ _('Equipment Data Collecting')}} </span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Modem Task Cycle')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-passive"></span>
          <span>{{ _('Data Transfer Cycle')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
    </ul>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let equipmentContainer = document.querySelector(".eq-detail-info");

    function fetchModems() {
      return fetch("/get_modem_info")
        .then((response) => response.json())
        .then((data) => {
          if (data.status !== "success" || !data.data) {
            console.error("{{ _('Modem data could not be retrieved:') }}", data.message);
            return null;
          }
          return data.data; 
        })
        .catch((error) => {
          console.error("{{ _('Error occurred while retrieving modem information:')}}", error);
          return null;
        });
    }

    function fetchEquipmentDetails() {
      return fetch("/fetch_equipment_details")
        .then((response) => response.json())
        .then((data) => {
          if (data.status !== "success") {
            equipmentContainer.innerHTML = `<p style='color: red;'>${data.message}</p>`;
            return null;
          }
          return data.data; 
        })
        .catch((error) => {
          console.error("{{ _('Error occurred while loading equipment details:')}}", error);
          equipmentContainer.innerHTML =
            "<p style='color: red;'>{{ _('Equipment information could not be retrieved') }}</p>";
          return null;
        });
    }

    Promise.all([fetchEquipmentDetails(), fetchModems()]).then(
      ([equipment, modem]) => {
        if (!equipment) return;

        document.querySelector(".eq-detail-status").innerText = `${
          equipment.model_name || "{{ _('Unknown') }}"
        }@${equipment.serial_number || "N/A"}`;

        // Modem adı
        document.querySelector(
          ".eq-detail-item:nth-child(3) span:last-child"
        ).innerText = modem && modem.name ? modem.name : "{{ _('Modem Not Found')}}";

        // Marka / Model
        document.querySelector(
          ".eq-detail-item:nth-child(4) span:last-child"
        ).innerText = `${equipment.brand_name || "N/A"} / ${
          equipment.model_name || "N/A"
        }`;

        // Slave ID
        document.querySelector(
          ".eq-detail-item:nth-child(2) span:last-child"
        ).innerText = equipment.modbus_address || "N/A";

        // Ekipman Tipi
        document.querySelector(
          ".eq-detail-item:nth-child(5) span:last-child"
        ).innerText = equipment.equipment_type || "{{ _('Analyzer')}}";

        // Seri No
        document.querySelector(
          ".eq-detail-item:nth-child(6) span:last-child"
        ).innerText = equipment.serial_number || "N/A";

        // Device ID
        document.querySelector(
          ".eq-detail-item:nth-child(8) span:last-child"
        ).innerText = equipment.device_id || "N/A";

        // SID/IP
        document.querySelector(
          ".eq-detail-item:nth-child(9) span:last-child"
        ).innerText = equipment.modbus_address || "N/A";

        // Protokol
        let protocolText = "N/A";
        if (equipment.communication_protocol_code == 1) {
          protocolText = "SERIAL";
        } else if (equipment.communication_protocol_code == 2) {
          protocolText = "TCP";
        }
        document.querySelector(
          ".eq-detail-item:nth-child(11) span:last-child"
        ).innerText = protocolText;

        // Oluşturulma tarihi
        document.querySelector(
          ".eq-detail-item:nth-child(14) span:last-child"
        ).innerText = formatDate(equipment.created_at);

        // Son bağlantı tarihi
        document.querySelector(
          ".eq-detail-item:nth-child(15) span:last-child"
        ).innerText = formatDate(equipment.updated_at);
      }
    );

    function formatDate(dateString) {
      if (!dateString) return "N/A";
      let date = new Date(dateString);
      return (
        date.getFullYear() +
        "-" +
        String(date.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(date.getDate()).padStart(2, "0") +
        " " +
        String(date.getHours()).padStart(2, "0") +
        ":" +
        String(date.getMinutes()).padStart(2, "0") +
        ":" +
        String(date.getSeconds()).padStart(2, "0")
      );
    }
  });
</script>


{% endblock %}
