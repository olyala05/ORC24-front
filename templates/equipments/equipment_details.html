{% extends "layout.html" %} {% block title %} {{ _('Equipment Details') }} {%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/equipment.scss') }}"
/>
{% endblock %} {% block content %}
<!-- Header -->
{% include 'partials/header.html' %}

<div class="eq-detail-container">
  <!-- Equipment Details Panel -->
  <div class="eq-detail-panel">
    <div class="eq-detail-info">
      <div class="eq-detail-item">
        <span>{{ _('Equipment Name')}}</span>
        <span class="eq-detail-status">-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Slave ID') }}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Modem Name') }}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Brand / Model')}}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Equipment Type')}}</span>
        <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Equipment Serial NO')}}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Device ID')}}</span> <span>{{ _('Active')}}</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('SID/IP')}}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Status / Configuration')}}</span>
        <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Connection Protocol') }}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('GMT')}}</span> <span>+3</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Daylight Saving Time') }}</span>
        <span class="eq-detail-dot eq-active"></span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Date Created') }}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Last Connection Date') }}</span> <span>-</span>
      </div>
    </div>
  </div>

  <!-- Archive Log Panel -->
  <div class="eq-detail-log">
    <div class="eq-detail-log-header">
      <span>{{ _('Archive') }}</span>
      <span>{{ _('End')}}</span>
    </div>
    <ul class="eq-detail-log-list">
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Service Started')}}</span>
        </span>
        <span>2024-04-03 13:54:31</span>
      </li>

      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Modbus connection established')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('32000 register error etc.')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Equipment not found etc.')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>

      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Modbus Connection')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Register Read')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('32000 register error etc.')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-passive"></span>
          <span class="eq-detail-dot eq-passive"></span>
          <span>{{ _('Equipment Data Collecting')}} </span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Modem Task Cycle')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
      <li class="eq-detail-log-item">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-passive"></span>
          <span>{{ _('Data Transfer Cycle')}}</span>
        </span>
        <span>2024-04-03 13:55:00</span>
      </li>
    </ul>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let equipmentContainer = document.querySelector(".eq-detail-info");

    function fetchModems() {
      return fetch("/get_modem_info")
        .then((response) => response.json())
        .then((data) => {
          if (data.status !== "success" || !data.data) {
            console.error(
              "{{ _('Modem data could not be retrieved:') }}",
              data.message
            );
            return null;
          }
          return data.data;
        })
        .catch((error) => {
          console.error(
            "{{ _('Error occurred while retrieving modem information:')}}",
            error
          );
          return null;
        });
    }

    function fetchEquipmentDetails() {
      return fetch("/fetch_equipment_details")
        .then((response) => response.json())
        .then((data) => {
          if (data.status !== "success") {
            equipmentContainer.innerHTML = `<p>${data.message}</p>`;
            return null;
          }
          return data.data;
        })
        .catch((error) => {
          console.error(
            "{{ _('Error occurred while loading equipment details:')}}",
            error
          );
          equipmentContainer.innerHTML = `<p>{{ _('Equipment information could not be retrieved') }}</p>`;
          return null;
        });
    }

    const equipmentTypeMap = {
      1: "ANALYZER",
      2: "CURRENT_TRANSFORMER",
      3: "INVERTER",
      4: "METER",
      5: "TEMPERATURE",
      6: "PRESSURE",
      7: "VIBRATION",
      8: "LIQUID_LEVEL",
      9: "RAIN",
      10: "WIND",
      11: "PLC",
      12: "SCADA",
      13: "BATTERY_LEVEL",
      14: "RADIATION",
      15: "CLOUDINESS",
      16: "AIR_TEMPERATURE",
      17: "FUEL_STATUS",
      18: "HUMIDITY",
      19: "MAGNETIC",
      20: "LIGHT",
      21: "SOUND",
      22: "CO2",
      23: "O2",
      24: "H2O",
      25: "LIQUID",
      26: "UPS"
    };

    Promise.all([fetchEquipmentDetails(), fetchModems()]).then(
      ([equipment, modem]) => {
        if (!equipment) return;

        // 1. Equipment Name
        document.querySelector(".eq-detail-status").innerText = `${
          equipment.model_name || "{{ _('Unknown') }}"
        }@${equipment.serial_number || "N/A"}`;

        // 2. Slave ID
        document.querySelector(
          ".eq-detail-item:nth-child(2) span:last-child"
        ).innerText = equipment.modbus_address || "N/A";

        // 3. Modem adı
        document.querySelector(
          ".eq-detail-item:nth-child(3) span:last-child"
        ).innerText =
          modem && modem.name ? modem.name : "{{ _('Modem Not Found')}}";

        // 4. Marka / Model
        document.querySelector(
          ".eq-detail-item:nth-child(4) span:last-child"
        ).innerText = `${equipment.brand_name || "N/A"} / ${
          equipment.model_name || "N/A"
        }`;

        // 5. Ekipman Tipi
        const typeCode = equipment.equipment_type;
        const typeName = equipmentTypeMap[typeCode] || "UNKNOWN";
        document.querySelector(
          ".eq-detail-item:nth-child(5) span:last-child"
        ).innerText = typeName;

        // 6. Seri No
        document.querySelector(
          ".eq-detail-item:nth-child(6) span:last-child"
        ).innerText = equipment.serial_number || "N/A";

        // 7. Device ID (önceden 8'di)
        document.querySelector(
          ".eq-detail-item:nth-child(7) span:last-child"
        ).innerText = equipment.device_id || "N/A";

        // 8. SID/IP (önceden 9'du)
        document.querySelector(
          ".eq-detail-item:nth-child(8) span:last-child"
        ).innerText = equipment.modbus_address || "N/A";

        // 9. Status / Configuration (önceden 10'du)
        const configSpan = document.querySelector(
          ".eq-detail-item:nth-child(9) span:last-child"
        );
        const configValue = equipment.configuration_data || "-";

        if (configValue === "A") {
          configSpan.innerText = "A";
          configSpan.style.color = "#28a745"; // yeşil
        } else if (configValue === "P") {
          configSpan.innerText = "P";
          configSpan.style.color = "#dc3545"; // kırmızı
        } else {
          configSpan.innerText = configValue;
          configSpan.style.color = "#6c757d"; // gri
        }

        // 10. Protokol (önceden 11'di)
        let protocolText = "N/A";
        if (equipment.communication_protocol_code == 1) {
          protocolText = "SERIAL";
        } else if (equipment.communication_protocol_code == 2) {
          protocolText = "TCP";
        }
        document.querySelector(
          ".eq-detail-item:nth-child(10) span:last-child"
        ).innerText = protocolText;

        // 13. Oluşturulma tarihi (önceden 14’tü)
        document.querySelector(
          ".eq-detail-item:nth-child(13) span:last-child"
        ).innerText = formatDate(equipment.created_at);

        // 14. Son bağlantı tarihi (önceden 15’ti)
        document.querySelector(
          ".eq-detail-item:nth-child(14) span:last-child"
        ).innerText = formatDate(equipment.updated_at);
      }
    );

    function formatDate(dateString) {
      if (!dateString) return "N/A";
      let date = new Date(dateString);
      return (
        date.getFullYear() +
        "-" +
        String(date.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(date.getDate()).padStart(2, "0") +
        " " +
        String(date.getHours()).padStart(2, "0") +
        ":" +
        String(date.getMinutes()).padStart(2, "0") +
        ":" +
        String(date.getSeconds()).padStart(2, "0")
      );
    }

  });
</script>

{% endblock %}
