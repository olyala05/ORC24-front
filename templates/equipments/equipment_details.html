{% extends "layout.html" %} {% block title %} {{ _('Equipment Details') }} {%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/equipment.scss') }}"
/>
{% endblock %} {% block content %}
<!-- Header -->
{% include 'partials/header.html' %}

<div class="eq-detail-container">
  <!-- Equipment Details Panel -->
  <div class="eq-detail-panel">
    <div class="eq-detail-info">
      <div class="eq-detail-item">
        <span>{{ _('Equipment Name')}}</span>
        <span class="eq-detail-status" title="equipment name">-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Modem Name') }}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Brand / Model')}}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Equipment Type')}}</span>
        <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Equipment Serial NO')}}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Device ID')}}</span> <span>{{ _('Active')}}</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('SID/IP')}}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Status / Configuration')}}</span>
        <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Connection Protocol') }}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('GMT')}}</span> <span>+3</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Daylight Saving Time') }}</span>
        <span class="eq-detail-dot eq-active"></span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Date Created') }}</span> <span>-</span>
      </div>
      <div class="eq-detail-item">
        <span>{{ _('Last Connection Date') }}</span> <span>-</span>
      </div>
    </div>
  </div>

  <!-- Archive Log Panel -->
  <div class="eq-detail-log">
    <div class="eq-detail-log-header">
      <span>{{ _('Archive') }}</span>
      <span>{{ _('Now')}}</span>
    </div>
    <ul class="eq-detail-log-list">
      <li class="eq-detail-log-item" data-tag="Were active devices configured?">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Were active devices configured?') }}</span>
        </span>
        <span class="text-right">-</span>
      </li>

      <li
        class="eq-detail-log-item"
        data-tag="Results of data collection task from devices"
      >
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Results of data collection task from devices') }}</span>
        </span>
        <span class="text-right">-</span>
      </li>

      <li
        class="eq-detail-log-item"
        data-tag="Were the detected items written to the database?"
      >
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span
            >{{ _('Were the detected items written to the database?') }}</span
          >
        </span>
        <span class="text-right">-</span>
      </li>

      <li class="eq-detail-log-item" data-tag="Active devices">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Active devices') }}</span>
        </span>
        <span class="text-right">-</span>
      </li>

      <li class="eq-detail-log-item" data-tag="Detected devices">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Detected devices') }}</span>
        </span>
        <span class="text-right">-</span>
      </li>

      <li class="eq-detail-log-item" data-tag="Did device scanning start?">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-active"></span>
          <span>{{ _('Did device scanning start?') }}</span>
        </span>
        <span class="text-right">-</span>
      </li>

      <li class="eq-detail-log-item" data-tag="Device scanning flags">
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-passive"></span>
          <span class="eq-detail-dot eq-passive"></span>
          <span>{{ _('Device scanning flags') }}</span>
        </span>
        <span class="text-right">-</span>
      </li>

      <li
        class="eq-detail-log-item"
        data-tag="Was Modbus Serial scan successful?"
      >
        <span class="eq-detail-log-status">
          <span class="eq-detail-dot eq-active"></span>
          <span class="eq-detail-dot eq-passive"></span>
          <span>{{ _('Was Modbus Serial scan successful?') }}</span>
        </span>
        <span class="text-right">-</span>
      </li>
    </ul>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let equipmentContainer = document.querySelector(".eq-detail-info");

    function fetchModems() {
      return fetch("/get_modem_info")
        .then((response) => response.json())
        .then((data) => {
          if (data.status !== "success" || !data.data) {
            console.error(
              "{{ _('Modem data could not be retrieved:') }}",
              data.message
            );
            return null;
          }
          return data.data;
        })
        .catch((error) => {
          console.error(
            "{{ _('Error occurred while retrieving modem information:')}}",
            error
          );
          return null;
        });
    }

    function fetchEquipmentDetails() {
      return fetch("/fetch_equipment_details")
        .then((response) => response.json())
        .then((data) => {
          if (data.status !== "success") {
            equipmentContainer.innerHTML = `<p>${data.message}</p>`;
            return null;
          }
          return data.data;
        })
        .catch((error) => {
          console.error(
            "{{ _('Error occurred while loading equipment details:')}}",
            error
          );
          equipmentContainer.innerHTML = `<p>{{ _('Equipment information could not be retrieved') }}</p>`;
          return null;
        });
    }

    const equipmentTypeMap = {
      1: "ANALYZER",
      2: "CURRENT_TRANSFORMER",
      3: "INVERTER",
      4: "METER",
      5: "TEMPERATURE",
      6: "PRESSURE",
      7: "VIBRATION",
      8: "LIQUID_LEVEL",
      9: "RAIN",
      10: "WIND",
      11: "PLC",
      12: "SCADA",
      13: "BATTERY_LEVEL",
      14: "RADIATION",
      15: "CLOUDINESS",
      16: "AIR_TEMPERATURE",
      17: "FUEL_STATUS",
      18: "HUMIDITY",
      19: "MAGNETIC",
      20: "LIGHT",
      21: "SOUND",
      22: "CO2",
      23: "O2",
      24: "H2O",
      25: "LIQUID",
      26: "UPS",
    };

    Promise.all([fetchEquipmentDetails(), fetchModems()]).then(
      ([equipment, modem]) => {
        if (!equipment) return;
    
        // 1. Equipment Name
        const eqName = `${equipment.model_name || "UNKNOWN"}@${
          equipment.serial_number || "N/A"
        }`;
        const eqSpan = document.querySelector(".eq-detail-status");
        eqSpan.innerText = eqName;
        eqSpan.title = eqName;
    
        // 2. Modem adı
        document.querySelector(
          ".eq-detail-item:nth-child(2) span:last-child"
        ).innerText =
          modem && modem.name ? modem.name : "{{ _('Modem Not Found')}}";
    
        // 3. Marka / Model
        document.querySelector(
          ".eq-detail-item:nth-child(3) span:last-child"
        ).innerText = `${equipment.brand_name || "N/A"} / ${
          equipment.model_name || "N/A"
        }`;
    
        // 4. Ekipman Tipi
        const typeCode = equipment.equipment_type;
        const typeName = equipmentTypeMap[typeCode] || "UNKNOWN";
        document.querySelector(
          ".eq-detail-item:nth-child(4) span:last-child"
        ).innerText = typeName;
    
        // 5. Seri No
        document.querySelector(
          ".eq-detail-item:nth-child(5) span:last-child"
        ).innerText = equipment.serial_number || "N/A";
    
        // 6. Device ID
        document.querySelector(
          ".eq-detail-item:nth-child(6) span:last-child"
        ).innerText = equipment.device_id || "N/A";
    
        // 7. SID/IP
        document.querySelector(
          ".eq-detail-item:nth-child(7) span:last-child"
        ).innerText = equipment.modbus_address || "N/A";
    
        // 8. Status / Configuration
        const configSpan = document.querySelector(
          ".eq-detail-item:nth-child(8) span:last-child"
        );
        const configValue = equipment.configuration_data || "-";
        if (configValue === "A") {
          configSpan.innerText = "A";
          configSpan.style.color = "#28a745"; 
        } else if (configValue === "P") {
          configSpan.innerText = "P";
          configSpan.style.color = "#dc3545"; 
        } else {
          configSpan.innerText = configValue;
          configSpan.style.color = "#6c757d"; 
        }

        // 9. Protokol
        let protocolText = "N/A";
        switch (equipment.communication_protocol_code) {
          case 1:
            protocolText = "MODBUS TCP/IP";
            break;
          case 2:
            protocolText = "MODBUS RTU";
            break;
          case 3:
            protocolText = "OBIS";
            break;
          case 4:
            protocolText = "RS232";
            break;
        }
        document.querySelector(
          ".eq-detail-item:nth-child(9) span:last-child"
        ).innerText = protocolText;

        // 12. Oluşturulma tarihi
        document.querySelector(
          ".eq-detail-item:nth-child(12) span:last-child"
        ).innerText = formatDate(equipment.created_at);
    
        // 13. Son bağlantı tarihi
        document.querySelector(
          ".eq-detail-item:nth-child(13) span:last-child"
        ).innerText = formatDate(equipment.updated_at);
      }
    );
    
    function formatDate(dateString) {
      if (!dateString) return "N/A";
      let date = new Date(dateString);
      return (
        date.getFullYear() +
        "-" +
        String(date.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(date.getDate()).padStart(2, "0") +
        " " +
        String(date.getHours()).padStart(2, "0") +
        ":" +
        String(date.getMinutes()).padStart(2, "0") +
        ":" +
        String(date.getSeconds()).padStart(2, "0")
      );
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    fetch("/get_archive_log_status")
      .then((response) => response.json())
      .then((data) => {
        if (data.status !== "success" || !data.data) {
          console.warn("[LOG] Geçersiz yanıt yapısı");
          return;
        }

        const archiveData = data.data;

        const tagMapping = {
          "Were active devices configured?":
            "Aktif ekipmanlar konfigure edildi mi?",
          "Results of data collection task from devices":
            "Ekipmanlardan veri toplama görevi sonuçları",
          "Were the detected items written to the database?":
            "Tespit edilen ekipmanlar veritabanına yazıldı mı?",
          "Active devices": "Aktif ekipmanlar",
          "Detected devices": "Tespit edilmiş ekipmanlar",
          "Did device scanning start?": "Ekipman tarama görevi başladı",
          "Device scanning flags": "Ekipman tarama görevi bayrakları!",
          "Was Modbus Serial scan successful?":
            "Modbus Serial üzerinden başarılı tarama yapıldı mı?",
        };

        const typeToColorClass = {
          1: "eq-active",
          2: "eq-warning",
          3: "eq-passive",
        };

        const items = document.querySelectorAll(".eq-detail-log-item");
        Object.entries(tagMapping).forEach(([staticText, archiveKeyText]) => {
          const item = document.querySelector(
            `.eq-detail-log-item[data-tag="${staticText}"]`
          );

          if (!item) {
            console.warn(`[LOG] '${staticText}' için <li> bulunamadı.`);
            return;
          }

          const archiveKey = Object.keys(archiveData).find(
            (key) => key.toLowerCase() === archiveKeyText.toLowerCase()
          );

          if (!archiveKey) {
            console.warn(`[LOG] '${archiveKeyText}' verisi bulunamadı.`);
            return;
          }

          const archiveInfo = archiveData[archiveKey];
          const dots = item.querySelectorAll(".eq-detail-dot");
          const spans = item.querySelectorAll("span");

          const archiveType = archiveInfo.archive_log_type;
          const nowType = archiveInfo.last_log_type;
          const lastLogDate = archiveInfo.last_log_date;

          if (typeToColorClass[archiveType]) {
            dots[0].classList.remove("eq-active", "eq-warning", "eq-passive");
            dots[0].classList.add(typeToColorClass[archiveType]);
          }

          if (typeToColorClass[nowType]) {
            dots[1].classList.remove("eq-active", "eq-warning", "eq-passive");
            dots[1].classList.add(typeToColorClass[nowType]);
          }

          if (lastLogDate) {
            const formattedDate = formatDateCustom(lastLogDate);
            spans[spans.length - 1].textContent = formattedDate;
          }
        });

        console.log("[LOG] Detay log paneli başarıyla güncellendi.");
      })
      .catch((error) => {
        console.error("[LOG] Detay log verisi alınamadı:", error);
      });
  });

  // Tooltip kutusu oluştur (sayfa yüklendikten sonra bir kez)
  const tooltip = document.createElement("div");
  tooltip.classList.add("eq-detail-tooltip");
  document.body.appendChild(tooltip);

  // Equipment Name'e tıklanınca göster
  const eqStatus = document.querySelector(".eq-detail-status");
  eqStatus.addEventListener("click", function (e) {
    const fullText = eqStatus.innerText;

    // Eğer tooltip zaten görünüyorsa: gizle ve çık
    if (tooltip.classList.contains("active")) {
      tooltip.classList.remove("active");
      return;
    }

    // Devam: gösterilecek metin
    tooltip.innerText = fullText;

    const rect = eqStatus.getBoundingClientRect();
    const tooltipWidth = 300;
    const offsetY = 10;

    tooltip.style.width = `${tooltipWidth}px`;
    tooltip.style.top = `${rect.top + window.scrollY - offsetY - 40}px`;
    tooltip.style.left = `${
      rect.left + window.scrollX + rect.width / 2 - tooltipWidth / 2
    }px`;

    tooltip.classList.add("active");

    // Dışarı tıklanınca gizle
    const hideTooltip = (event) => {
      if (!tooltip.contains(event.target) && event.target !== eqStatus) {
        tooltip.classList.remove("active");
        document.removeEventListener("click", hideTooltip);
      }
    };
    document.addEventListener("click", hideTooltip);
  });
</script>

{% endblock %}
<!-- #ffda29 -->
